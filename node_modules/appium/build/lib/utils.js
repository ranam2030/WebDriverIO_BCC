"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getExtensionArgs = getExtensionArgs;
exports.getPackageVersion = getPackageVersion;
exports.insertAppiumPrefixes = insertAppiumPrefixes;
exports.inspectObject = inspectObject;
exports.parseCapsForInnerDriver = parseCapsForInnerDriver;
exports.pullSettings = pullSettings;
exports.removeAppiumPrefixes = removeAppiumPrefixes;
exports.rootDir = void 0;
exports.validateExtensionArgs = validateExtensionArgs;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _baseDriver = require("@appium/base-driver");

var _support = require("@appium/support");

const W3C_APPIUM_PREFIX = 'appium';

function inspectObject(args) {
  function getValueArray(obj, indent = '  ') {
    if (!_lodash.default.isObject(obj)) {
      return [obj];
    }

    let strArr = ['{'];

    for (let [arg, value] of _lodash.default.toPairs(obj)) {
      if (!_lodash.default.isObject(value)) {
        strArr.push(`${indent}  ${arg}: ${value}`);
      } else {
        value = getValueArray(value, `${indent}  `);
        strArr.push(`${indent}  ${arg}: ${value.shift()}`);
        strArr.push(...value);
      }
    }

    strArr.push(`${indent}}`);
    return strArr;
  }

  for (let [arg, value] of _lodash.default.toPairs(args)) {
    value = getValueArray(value);

    _logger.default.info(`  ${arg}: ${value.shift()}`);

    for (let val of value) {
      _logger.default.info(val);
    }
  }
}

function getExtensionArgs(extensionArgs, extensionName) {
  if (!_lodash.default.has(extensionArgs, extensionName)) {
    return {};
  }

  if (!_lodash.default.isPlainObject(extensionArgs[extensionName])) {
    throw new TypeError(`Driver or plugin arguments must be plain objects`);
  }

  return extensionArgs[extensionName];
}

function ensureNoUnknownArgs(extensionArgs, argsConstraints) {
  const knownArgNames = Object.keys(argsConstraints);

  const unknownArgs = _lodash.default.difference(Object.keys(extensionArgs), knownArgNames);

  if (unknownArgs.length > 0) {
    throw new Error(`Some arguments were not recognized: ${JSON.stringify(unknownArgs)}. ` + `Are you sure they are in the list of supported args? ${JSON.stringify(knownArgNames)}`);
  }
}

function validateExtensionArgs(extensionArgs, argsConstraints) {
  if (!_lodash.default.isEmpty(extensionArgs) && !_lodash.default.isEmpty(argsConstraints)) {
    ensureNoUnknownArgs(extensionArgs, argsConstraints);
    (0, _baseDriver.validateCaps)(extensionArgs, argsConstraints);
  }
}

function parseCapsForInnerDriver(jsonwpCapabilities, w3cCapabilities, constraints = {}, defaultCapabilities = {}) {
  const hasW3CCaps = _lodash.default.isPlainObject(w3cCapabilities) && (_lodash.default.has(w3cCapabilities, 'alwaysMatch') || _lodash.default.has(w3cCapabilities, 'firstMatch'));

  const hasJSONWPCaps = _lodash.default.isPlainObject(jsonwpCapabilities);

  let desiredCaps = {};
  let processedW3CCapabilities = null;
  let processedJsonwpCapabilities = null;

  if (!hasW3CCaps) {
    return {
      protocol: _baseDriver.PROTOCOLS.W3C,
      error: new Error('W3C capabilities should be provided')
    };
  }

  const {
    W3C
  } = _baseDriver.PROTOCOLS;
  const protocol = W3C;
  jsonwpCapabilities = _lodash.default.cloneDeep(jsonwpCapabilities);
  w3cCapabilities = _lodash.default.cloneDeep(w3cCapabilities);
  defaultCapabilities = _lodash.default.cloneDeep(defaultCapabilities);

  if (!_lodash.default.isEmpty(defaultCapabilities)) {
    if (hasW3CCaps) {
      for (const [defaultCapKey, defaultCapValue] of _lodash.default.toPairs(defaultCapabilities)) {
        let isCapAlreadySet = false;

        for (const firstMatchEntry of w3cCapabilities.firstMatch || []) {
          if (_lodash.default.isPlainObject(firstMatchEntry) && _lodash.default.has(removeAppiumPrefixes(firstMatchEntry), removeAppiumPrefix(defaultCapKey))) {
            isCapAlreadySet = true;
            break;
          }
        }

        isCapAlreadySet = isCapAlreadySet || _lodash.default.isPlainObject(w3cCapabilities.alwaysMatch) && _lodash.default.has(removeAppiumPrefixes(w3cCapabilities.alwaysMatch), removeAppiumPrefix(defaultCapKey));

        if (isCapAlreadySet) {
          continue;
        }

        if (_lodash.default.isEmpty(w3cCapabilities.firstMatch)) {
          w3cCapabilities.firstMatch = [{
            [defaultCapKey]: defaultCapValue
          }];
        } else {
          w3cCapabilities.firstMatch[0][defaultCapKey] = defaultCapValue;
        }
      }
    }

    if (hasJSONWPCaps) {
      jsonwpCapabilities = Object.assign({}, removeAppiumPrefixes(defaultCapabilities), jsonwpCapabilities);
    }
  }

  if (hasJSONWPCaps) {
    processedJsonwpCapabilities = { ...jsonwpCapabilities
    };
  }

  if (hasW3CCaps) {
    try {
      desiredCaps = (0, _baseDriver.processCapabilities)(w3cCapabilities, constraints, true);
    } catch (error) {
      _logger.default.info(`Could not parse W3C capabilities: ${error.message}`);

      return {
        desiredCaps,
        processedJsonwpCapabilities,
        processedW3CCapabilities,
        protocol,
        error
      };
    }

    processedW3CCapabilities = {
      alwaysMatch: { ...insertAppiumPrefixes(desiredCaps)
      },
      firstMatch: [{}]
    };
  }

  return {
    desiredCaps,
    processedJsonwpCapabilities,
    processedW3CCapabilities,
    protocol
  };
}

function insertAppiumPrefixes(caps) {
  const STANDARD_CAPS = ['browserName', 'browserVersion', 'platformName', 'acceptInsecureCerts', 'pageLoadStrategy', 'proxy', 'setWindowRect', 'timeouts', 'unhandledPromptBehavior'];
  let prefixedCaps = {};

  for (let [name, value] of _lodash.default.toPairs(caps)) {
    if (STANDARD_CAPS.includes(name) || name.includes(':')) {
      prefixedCaps[name] = value;
    } else {
      prefixedCaps[`${W3C_APPIUM_PREFIX}:${name}`] = value;
    }
  }

  return prefixedCaps;
}

function removeAppiumPrefixes(caps) {
  if (!_lodash.default.isPlainObject(caps)) {
    return caps;
  }

  const fixedCaps = {};

  for (let [name, value] of _lodash.default.toPairs(caps)) {
    fixedCaps[removeAppiumPrefix(name)] = value;
  }

  return fixedCaps;
}

function removeAppiumPrefix(key) {
  const prefix = `${W3C_APPIUM_PREFIX}:`;
  return _lodash.default.startsWith(key, prefix) ? key.substring(prefix.length) : key;
}

function getPackageVersion(pkgName) {
  const pkgInfo = require(`${pkgName}/package.json`) || {};
  return pkgInfo.version;
}

function pullSettings(caps) {
  if (!_lodash.default.isPlainObject(caps) || _lodash.default.isEmpty(caps)) {
    return {};
  }

  const result = {};

  for (const [key, value] of _lodash.default.toPairs(caps)) {
    const match = /\bsettings\[(\S+)\]$/.exec(key);

    if (!match) {
      continue;
    }

    result[match[1]] = value;
    delete caps[key];
  }

  return result;
}

const rootDir = _support.fs.findRoot(__dirname);

exports.rootDir = rootDir;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJXM0NfQVBQSVVNX1BSRUZJWCIsImluc3BlY3RPYmplY3QiLCJhcmdzIiwiZ2V0VmFsdWVBcnJheSIsIm9iaiIsImluZGVudCIsIl8iLCJpc09iamVjdCIsInN0ckFyciIsImFyZyIsInZhbHVlIiwidG9QYWlycyIsInB1c2giLCJzaGlmdCIsImxvZ2dlciIsImluZm8iLCJ2YWwiLCJnZXRFeHRlbnNpb25BcmdzIiwiZXh0ZW5zaW9uQXJncyIsImV4dGVuc2lvbk5hbWUiLCJoYXMiLCJpc1BsYWluT2JqZWN0IiwiVHlwZUVycm9yIiwiZW5zdXJlTm9Vbmtub3duQXJncyIsImFyZ3NDb25zdHJhaW50cyIsImtub3duQXJnTmFtZXMiLCJPYmplY3QiLCJrZXlzIiwidW5rbm93bkFyZ3MiLCJkaWZmZXJlbmNlIiwibGVuZ3RoIiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5IiwidmFsaWRhdGVFeHRlbnNpb25BcmdzIiwiaXNFbXB0eSIsInBhcnNlQ2Fwc0ZvcklubmVyRHJpdmVyIiwianNvbndwQ2FwYWJpbGl0aWVzIiwidzNjQ2FwYWJpbGl0aWVzIiwiY29uc3RyYWludHMiLCJkZWZhdWx0Q2FwYWJpbGl0aWVzIiwiaGFzVzNDQ2FwcyIsImhhc0pTT05XUENhcHMiLCJkZXNpcmVkQ2FwcyIsInByb2Nlc3NlZFczQ0NhcGFiaWxpdGllcyIsInByb2Nlc3NlZEpzb253cENhcGFiaWxpdGllcyIsInByb3RvY29sIiwiUFJPVE9DT0xTIiwiVzNDIiwiZXJyb3IiLCJjbG9uZURlZXAiLCJkZWZhdWx0Q2FwS2V5IiwiZGVmYXVsdENhcFZhbHVlIiwiaXNDYXBBbHJlYWR5U2V0IiwiZmlyc3RNYXRjaEVudHJ5IiwiZmlyc3RNYXRjaCIsInJlbW92ZUFwcGl1bVByZWZpeGVzIiwicmVtb3ZlQXBwaXVtUHJlZml4IiwiYWx3YXlzTWF0Y2giLCJhc3NpZ24iLCJtZXNzYWdlIiwiaW5zZXJ0QXBwaXVtUHJlZml4ZXMiLCJjYXBzIiwiU1RBTkRBUkRfQ0FQUyIsInByZWZpeGVkQ2FwcyIsIm5hbWUiLCJpbmNsdWRlcyIsImZpeGVkQ2FwcyIsImtleSIsInByZWZpeCIsInN0YXJ0c1dpdGgiLCJzdWJzdHJpbmciLCJnZXRQYWNrYWdlVmVyc2lvbiIsInBrZ05hbWUiLCJwa2dJbmZvIiwicmVxdWlyZSIsInZlcnNpb24iLCJwdWxsU2V0dGluZ3MiLCJyZXN1bHQiLCJtYXRjaCIsImV4ZWMiLCJyb290RGlyIiwiZnMiLCJmaW5kUm9vdCIsIl9fZGlybmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGlCQUFpQixHQUFHLFFBQTFCOztBQUVBLFNBQVNDLGFBQVQsQ0FBd0JDLElBQXhCLEVBQThCO0FBQzVCLFdBQVNDLGFBQVQsQ0FBd0JDLEdBQXhCLEVBQTZCQyxNQUFNLEdBQUcsSUFBdEMsRUFBNEM7QUFDMUMsUUFBSSxDQUFDQyxnQkFBRUMsUUFBRixDQUFXSCxHQUFYLENBQUwsRUFBc0I7QUFDcEIsYUFBTyxDQUFDQSxHQUFELENBQVA7QUFDRDs7QUFFRCxRQUFJSSxNQUFNLEdBQUcsQ0FBQyxHQUFELENBQWI7O0FBQ0EsU0FBSyxJQUFJLENBQUNDLEdBQUQsRUFBTUMsS0FBTixDQUFULElBQXlCSixnQkFBRUssT0FBRixDQUFVUCxHQUFWLENBQXpCLEVBQXlDO0FBQ3ZDLFVBQUksQ0FBQ0UsZ0JBQUVDLFFBQUYsQ0FBV0csS0FBWCxDQUFMLEVBQXdCO0FBQ3RCRixRQUFBQSxNQUFNLENBQUNJLElBQVAsQ0FBYSxHQUFFUCxNQUFPLEtBQUlJLEdBQUksS0FBSUMsS0FBTSxFQUF4QztBQUNELE9BRkQsTUFFTztBQUNMQSxRQUFBQSxLQUFLLEdBQUdQLGFBQWEsQ0FBQ08sS0FBRCxFQUFTLEdBQUVMLE1BQU8sSUFBbEIsQ0FBckI7QUFDQUcsUUFBQUEsTUFBTSxDQUFDSSxJQUFQLENBQWEsR0FBRVAsTUFBTyxLQUFJSSxHQUFJLEtBQUlDLEtBQUssQ0FBQ0csS0FBTixFQUFjLEVBQWhEO0FBQ0FMLFFBQUFBLE1BQU0sQ0FBQ0ksSUFBUCxDQUFZLEdBQUdGLEtBQWY7QUFDRDtBQUNGOztBQUNERixJQUFBQSxNQUFNLENBQUNJLElBQVAsQ0FBYSxHQUFFUCxNQUFPLEdBQXRCO0FBQ0EsV0FBT0csTUFBUDtBQUNEOztBQUNELE9BQUssSUFBSSxDQUFDQyxHQUFELEVBQU1DLEtBQU4sQ0FBVCxJQUF5QkosZ0JBQUVLLE9BQUYsQ0FBVVQsSUFBVixDQUF6QixFQUEwQztBQUN4Q1EsSUFBQUEsS0FBSyxHQUFHUCxhQUFhLENBQUNPLEtBQUQsQ0FBckI7O0FBQ0FJLG9CQUFPQyxJQUFQLENBQWEsS0FBSU4sR0FBSSxLQUFJQyxLQUFLLENBQUNHLEtBQU4sRUFBYyxFQUF2Qzs7QUFDQSxTQUFLLElBQUlHLEdBQVQsSUFBZ0JOLEtBQWhCLEVBQXVCO0FBQ3JCSSxzQkFBT0MsSUFBUCxDQUFZQyxHQUFaO0FBQ0Q7QUFDRjtBQUNGOztBQVFELFNBQVNDLGdCQUFULENBQTJCQyxhQUEzQixFQUEwQ0MsYUFBMUMsRUFBeUQ7QUFDdkQsTUFBSSxDQUFDYixnQkFBRWMsR0FBRixDQUFNRixhQUFOLEVBQXFCQyxhQUFyQixDQUFMLEVBQTBDO0FBQ3hDLFdBQU8sRUFBUDtBQUNEOztBQUNELE1BQUksQ0FBQ2IsZ0JBQUVlLGFBQUYsQ0FBZ0JILGFBQWEsQ0FBQ0MsYUFBRCxDQUE3QixDQUFMLEVBQW9EO0FBQ2xELFVBQU0sSUFBSUcsU0FBSixDQUFlLGtEQUFmLENBQU47QUFDRDs7QUFDRCxTQUFPSixhQUFhLENBQUNDLGFBQUQsQ0FBcEI7QUFDRDs7QUFVRCxTQUFTSSxtQkFBVCxDQUE4QkwsYUFBOUIsRUFBNkNNLGVBQTdDLEVBQThEO0FBQzVELFFBQU1DLGFBQWEsR0FBR0MsTUFBTSxDQUFDQyxJQUFQLENBQVlILGVBQVosQ0FBdEI7O0FBQ0EsUUFBTUksV0FBVyxHQUFHdEIsZ0JBQUV1QixVQUFGLENBQWFILE1BQU0sQ0FBQ0MsSUFBUCxDQUFZVCxhQUFaLENBQWIsRUFBeUNPLGFBQXpDLENBQXBCOztBQUNBLE1BQUlHLFdBQVcsQ0FBQ0UsTUFBWixHQUFxQixDQUF6QixFQUE0QjtBQUMxQixVQUFNLElBQUlDLEtBQUosQ0FBVyx1Q0FBc0NDLElBQUksQ0FBQ0MsU0FBTCxDQUFlTCxXQUFmLENBQTRCLElBQW5FLEdBQ0Msd0RBQXVESSxJQUFJLENBQUNDLFNBQUwsQ0FBZVIsYUFBZixDQUE4QixFQURoRyxDQUFOO0FBRUQ7QUFDRjs7QUFVRCxTQUFTUyxxQkFBVCxDQUFnQ2hCLGFBQWhDLEVBQStDTSxlQUEvQyxFQUFnRTtBQUM5RCxNQUFJLENBQUNsQixnQkFBRTZCLE9BQUYsQ0FBVWpCLGFBQVYsQ0FBRCxJQUE2QixDQUFDWixnQkFBRTZCLE9BQUYsQ0FBVVgsZUFBVixDQUFsQyxFQUE4RDtBQUM1REQsSUFBQUEsbUJBQW1CLENBQUNMLGFBQUQsRUFBZ0JNLGVBQWhCLENBQW5CO0FBQ0Esa0NBQWFOLGFBQWIsRUFBNEJNLGVBQTVCO0FBQ0Q7QUFDRjs7QUFZRCxTQUFTWSx1QkFBVCxDQUFrQ0Msa0JBQWxDLEVBQXNEQyxlQUF0RCxFQUF1RUMsV0FBVyxHQUFHLEVBQXJGLEVBQXlGQyxtQkFBbUIsR0FBRyxFQUEvRyxFQUFtSDtBQUVqSCxRQUFNQyxVQUFVLEdBQUduQyxnQkFBRWUsYUFBRixDQUFnQmlCLGVBQWhCLE1BQ2hCaEMsZ0JBQUVjLEdBQUYsQ0FBTWtCLGVBQU4sRUFBdUIsYUFBdkIsS0FBeUNoQyxnQkFBRWMsR0FBRixDQUFNa0IsZUFBTixFQUF1QixZQUF2QixDQUR6QixDQUFuQjs7QUFFQSxRQUFNSSxhQUFhLEdBQUdwQyxnQkFBRWUsYUFBRixDQUFnQmdCLGtCQUFoQixDQUF0Qjs7QUFDQSxNQUFJTSxXQUFXLEdBQUcsRUFBbEI7QUFDQSxNQUFJQyx3QkFBd0IsR0FBRyxJQUEvQjtBQUNBLE1BQUlDLDJCQUEyQixHQUFHLElBQWxDOztBQUVBLE1BQUksQ0FBQ0osVUFBTCxFQUFpQjtBQUNmLFdBQU87QUFDTEssTUFBQUEsUUFBUSxFQUFFQyxzQkFBVUMsR0FEZjtBQUVMQyxNQUFBQSxLQUFLLEVBQUUsSUFBSWxCLEtBQUosQ0FBVSxxQ0FBVjtBQUZGLEtBQVA7QUFJRDs7QUFFRCxRQUFNO0FBQUNpQixJQUFBQTtBQUFELE1BQVFELHFCQUFkO0FBQ0EsUUFBTUQsUUFBUSxHQUFHRSxHQUFqQjtBQUdBWCxFQUFBQSxrQkFBa0IsR0FBRy9CLGdCQUFFNEMsU0FBRixDQUFZYixrQkFBWixDQUFyQjtBQUNBQyxFQUFBQSxlQUFlLEdBQUdoQyxnQkFBRTRDLFNBQUYsQ0FBWVosZUFBWixDQUFsQjtBQUNBRSxFQUFBQSxtQkFBbUIsR0FBR2xDLGdCQUFFNEMsU0FBRixDQUFZVixtQkFBWixDQUF0Qjs7QUFFQSxNQUFJLENBQUNsQyxnQkFBRTZCLE9BQUYsQ0FBVUssbUJBQVYsQ0FBTCxFQUFxQztBQUNuQyxRQUFJQyxVQUFKLEVBQWdCO0FBQ2QsV0FBSyxNQUFNLENBQUNVLGFBQUQsRUFBZ0JDLGVBQWhCLENBQVgsSUFBK0M5QyxnQkFBRUssT0FBRixDQUFVNkIsbUJBQVYsQ0FBL0MsRUFBK0U7QUFDN0UsWUFBSWEsZUFBZSxHQUFHLEtBQXRCOztBQUVBLGFBQUssTUFBTUMsZUFBWCxJQUErQmhCLGVBQWUsQ0FBQ2lCLFVBQWhCLElBQThCLEVBQTdELEVBQWtFO0FBQ2hFLGNBQUlqRCxnQkFBRWUsYUFBRixDQUFnQmlDLGVBQWhCLEtBQ0doRCxnQkFBRWMsR0FBRixDQUFNb0Msb0JBQW9CLENBQUNGLGVBQUQsQ0FBMUIsRUFBNkNHLGtCQUFrQixDQUFDTixhQUFELENBQS9ELENBRFAsRUFDd0Y7QUFDdEZFLFlBQUFBLGVBQWUsR0FBRyxJQUFsQjtBQUNBO0FBQ0Q7QUFDRjs7QUFFREEsUUFBQUEsZUFBZSxHQUFHQSxlQUFlLElBQUsvQyxnQkFBRWUsYUFBRixDQUFnQmlCLGVBQWUsQ0FBQ29CLFdBQWhDLEtBQ2pDcEQsZ0JBQUVjLEdBQUYsQ0FBTW9DLG9CQUFvQixDQUFDbEIsZUFBZSxDQUFDb0IsV0FBakIsQ0FBMUIsRUFBeURELGtCQUFrQixDQUFDTixhQUFELENBQTNFLENBREw7O0FBRUEsWUFBSUUsZUFBSixFQUFxQjtBQUVuQjtBQUNEOztBQUdELFlBQUkvQyxnQkFBRTZCLE9BQUYsQ0FBVUcsZUFBZSxDQUFDaUIsVUFBMUIsQ0FBSixFQUEyQztBQUN6Q2pCLFVBQUFBLGVBQWUsQ0FBQ2lCLFVBQWhCLEdBQTZCLENBQUM7QUFBQyxhQUFDSixhQUFELEdBQWlCQztBQUFsQixXQUFELENBQTdCO0FBQ0QsU0FGRCxNQUVPO0FBQ0xkLFVBQUFBLGVBQWUsQ0FBQ2lCLFVBQWhCLENBQTJCLENBQTNCLEVBQThCSixhQUE5QixJQUErQ0MsZUFBL0M7QUFDRDtBQUNGO0FBQ0Y7O0FBQ0QsUUFBSVYsYUFBSixFQUFtQjtBQUNqQkwsTUFBQUEsa0JBQWtCLEdBQUdYLE1BQU0sQ0FBQ2lDLE1BQVAsQ0FBYyxFQUFkLEVBQWtCSCxvQkFBb0IsQ0FBQ2hCLG1CQUFELENBQXRDLEVBQTZESCxrQkFBN0QsQ0FBckI7QUFDRDtBQUNGOztBQUdELE1BQUlLLGFBQUosRUFBbUI7QUFDakJHLElBQUFBLDJCQUEyQixHQUFHLEVBQUMsR0FBR1I7QUFBSixLQUE5QjtBQUNEOztBQUdELE1BQUlJLFVBQUosRUFBZ0I7QUFHZCxRQUFJO0FBQ0ZFLE1BQUFBLFdBQVcsR0FBRyxxQ0FBb0JMLGVBQXBCLEVBQXFDQyxXQUFyQyxFQUFrRCxJQUFsRCxDQUFkO0FBQ0QsS0FGRCxDQUVFLE9BQU9VLEtBQVAsRUFBYztBQUNkbkMsc0JBQU9DLElBQVAsQ0FBYSxxQ0FBb0NrQyxLQUFLLENBQUNXLE9BQVEsRUFBL0Q7O0FBQ0EsYUFBTztBQUNMakIsUUFBQUEsV0FESztBQUVMRSxRQUFBQSwyQkFGSztBQUdMRCxRQUFBQSx3QkFISztBQUlMRSxRQUFBQSxRQUpLO0FBS0xHLFFBQUFBO0FBTEssT0FBUDtBQU9EOztBQUdETCxJQUFBQSx3QkFBd0IsR0FBRztBQUN6QmMsTUFBQUEsV0FBVyxFQUFFLEVBQUMsR0FBR0csb0JBQW9CLENBQUNsQixXQUFEO0FBQXhCLE9BRFk7QUFFekJZLE1BQUFBLFVBQVUsRUFBRSxDQUFDLEVBQUQ7QUFGYSxLQUEzQjtBQUlEOztBQUVELFNBQU87QUFBQ1osSUFBQUEsV0FBRDtBQUFjRSxJQUFBQSwyQkFBZDtBQUEyQ0QsSUFBQUEsd0JBQTNDO0FBQXFFRSxJQUFBQTtBQUFyRSxHQUFQO0FBQ0Q7O0FBTUQsU0FBU2Usb0JBQVQsQ0FBK0JDLElBQS9CLEVBQXFDO0FBRW5DLFFBQU1DLGFBQWEsR0FBRyxDQUNwQixhQURvQixFQUVwQixnQkFGb0IsRUFHcEIsY0FIb0IsRUFJcEIscUJBSm9CLEVBS3BCLGtCQUxvQixFQU1wQixPQU5vQixFQU9wQixlQVBvQixFQVFwQixVQVJvQixFQVNwQix5QkFUb0IsQ0FBdEI7QUFZQSxNQUFJQyxZQUFZLEdBQUcsRUFBbkI7O0FBQ0EsT0FBSyxJQUFJLENBQUNDLElBQUQsRUFBT3ZELEtBQVAsQ0FBVCxJQUEwQkosZ0JBQUVLLE9BQUYsQ0FBVW1ELElBQVYsQ0FBMUIsRUFBMkM7QUFDekMsUUFBSUMsYUFBYSxDQUFDRyxRQUFkLENBQXVCRCxJQUF2QixLQUFnQ0EsSUFBSSxDQUFDQyxRQUFMLENBQWMsR0FBZCxDQUFwQyxFQUF3RDtBQUN0REYsTUFBQUEsWUFBWSxDQUFDQyxJQUFELENBQVosR0FBcUJ2RCxLQUFyQjtBQUNELEtBRkQsTUFFTztBQUNMc0QsTUFBQUEsWUFBWSxDQUFFLEdBQUVoRSxpQkFBa0IsSUFBR2lFLElBQUssRUFBOUIsQ0FBWixHQUErQ3ZELEtBQS9DO0FBQ0Q7QUFDRjs7QUFDRCxTQUFPc0QsWUFBUDtBQUNEOztBQUVELFNBQVNSLG9CQUFULENBQStCTSxJQUEvQixFQUFxQztBQUNuQyxNQUFJLENBQUN4RCxnQkFBRWUsYUFBRixDQUFnQnlDLElBQWhCLENBQUwsRUFBNEI7QUFDMUIsV0FBT0EsSUFBUDtBQUNEOztBQUVELFFBQU1LLFNBQVMsR0FBRyxFQUFsQjs7QUFDQSxPQUFLLElBQUksQ0FBQ0YsSUFBRCxFQUFPdkQsS0FBUCxDQUFULElBQTBCSixnQkFBRUssT0FBRixDQUFVbUQsSUFBVixDQUExQixFQUEyQztBQUN6Q0ssSUFBQUEsU0FBUyxDQUFDVixrQkFBa0IsQ0FBQ1EsSUFBRCxDQUFuQixDQUFULEdBQXNDdkQsS0FBdEM7QUFDRDs7QUFDRCxTQUFPeUQsU0FBUDtBQUNEOztBQUVELFNBQVNWLGtCQUFULENBQTZCVyxHQUE3QixFQUFrQztBQUNoQyxRQUFNQyxNQUFNLEdBQUksR0FBRXJFLGlCQUFrQixHQUFwQztBQUNBLFNBQU9NLGdCQUFFZ0UsVUFBRixDQUFhRixHQUFiLEVBQWtCQyxNQUFsQixJQUE0QkQsR0FBRyxDQUFDRyxTQUFKLENBQWNGLE1BQU0sQ0FBQ3ZDLE1BQXJCLENBQTVCLEdBQTJEc0MsR0FBbEU7QUFDRDs7QUFFRCxTQUFTSSxpQkFBVCxDQUE0QkMsT0FBNUIsRUFBcUM7QUFDbkMsUUFBTUMsT0FBTyxHQUFHQyxPQUFPLENBQUUsR0FBRUYsT0FBUSxlQUFaLENBQVAsSUFBc0MsRUFBdEQ7QUFDQSxTQUFPQyxPQUFPLENBQUNFLE9BQWY7QUFDRDs7QUFrQkQsU0FBU0MsWUFBVCxDQUF1QmYsSUFBdkIsRUFBNkI7QUFDM0IsTUFBSSxDQUFDeEQsZ0JBQUVlLGFBQUYsQ0FBZ0J5QyxJQUFoQixDQUFELElBQTBCeEQsZ0JBQUU2QixPQUFGLENBQVUyQixJQUFWLENBQTlCLEVBQStDO0FBQzdDLFdBQU8sRUFBUDtBQUNEOztBQUVELFFBQU1nQixNQUFNLEdBQUcsRUFBZjs7QUFDQSxPQUFLLE1BQU0sQ0FBQ1YsR0FBRCxFQUFNMUQsS0FBTixDQUFYLElBQTJCSixnQkFBRUssT0FBRixDQUFVbUQsSUFBVixDQUEzQixFQUE0QztBQUMxQyxVQUFNaUIsS0FBSyxHQUFHLHVCQUF1QkMsSUFBdkIsQ0FBNEJaLEdBQTVCLENBQWQ7O0FBQ0EsUUFBSSxDQUFDVyxLQUFMLEVBQVk7QUFDVjtBQUNEOztBQUVERCxJQUFBQSxNQUFNLENBQUNDLEtBQUssQ0FBQyxDQUFELENBQU4sQ0FBTixHQUFtQnJFLEtBQW5CO0FBQ0EsV0FBT29ELElBQUksQ0FBQ00sR0FBRCxDQUFYO0FBQ0Q7O0FBQ0QsU0FBT1UsTUFBUDtBQUNEOztBQUVELE1BQU1HLE9BQU8sR0FBR0MsWUFBR0MsUUFBSCxDQUFZQyxTQUFaLENBQWhCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgcHJvY2Vzc0NhcGFiaWxpdGllcywgUFJPVE9DT0xTLCB2YWxpZGF0ZUNhcHMgYXMgdmFsaWRhdGVBcmdzIH0gZnJvbSAnQGFwcGl1bS9iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5cbmNvbnN0IFczQ19BUFBJVU1fUFJFRklYID0gJ2FwcGl1bSc7XG5cbmZ1bmN0aW9uIGluc3BlY3RPYmplY3QgKGFyZ3MpIHtcbiAgZnVuY3Rpb24gZ2V0VmFsdWVBcnJheSAob2JqLCBpbmRlbnQgPSAnICAnKSB7XG4gICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHtcbiAgICAgIHJldHVybiBbb2JqXTtcbiAgICB9XG5cbiAgICBsZXQgc3RyQXJyID0gWyd7J107XG4gICAgZm9yIChsZXQgW2FyZywgdmFsdWVdIG9mIF8udG9QYWlycyhvYmopKSB7XG4gICAgICBpZiAoIV8uaXNPYmplY3QodmFsdWUpKSB7XG4gICAgICAgIHN0ckFyci5wdXNoKGAke2luZGVudH0gICR7YXJnfTogJHt2YWx1ZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhbHVlID0gZ2V0VmFsdWVBcnJheSh2YWx1ZSwgYCR7aW5kZW50fSAgYCk7XG4gICAgICAgIHN0ckFyci5wdXNoKGAke2luZGVudH0gICR7YXJnfTogJHt2YWx1ZS5zaGlmdCgpfWApO1xuICAgICAgICBzdHJBcnIucHVzaCguLi52YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHN0ckFyci5wdXNoKGAke2luZGVudH19YCk7XG4gICAgcmV0dXJuIHN0ckFycjtcbiAgfVxuICBmb3IgKGxldCBbYXJnLCB2YWx1ZV0gb2YgXy50b1BhaXJzKGFyZ3MpKSB7XG4gICAgdmFsdWUgPSBnZXRWYWx1ZUFycmF5KHZhbHVlKTtcbiAgICBsb2dnZXIuaW5mbyhgICAke2FyZ306ICR7dmFsdWUuc2hpZnQoKX1gKTtcbiAgICBmb3IgKGxldCB2YWwgb2YgdmFsdWUpIHtcbiAgICAgIGxvZ2dlci5pbmZvKHZhbCk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogR2l2ZW4gYSBzZXQgb2YgQ0xJIGFyZ3MgYW5kIHRoZSBuYW1lIG9mIGEgZHJpdmVyIG9yIHBsdWdpbiwgZXh0cmFjdCB0aG9zZSBhcmdzIGZvciB0aGF0IHBsdWdpblxuICogQHBhcmFtIHtPYmplY3R9IGV4dGVuc2lvbkFyZ3MgLSBhcmd1bWVudHMgb2YgdGhlIGZvcm0ge1tleHROYW1lXToge1thcmdOYW1lXTogW2FyZ1ZhbHVlXX19XG4gKiBAcGFyYW0ge3N0cmluZ30gZXh0ZW5zaW9uTmFtZSAtIHRoZSBuYW1lIG9mIHRoZSBleHRlbnNpb25cbiAqIEByZXR1cm4ge09iamVjdH0gdGhlIGFyZyBvYmplY3QgZm9yIHRoYXQgZXh0ZW5zaW9uIGFsb25lXG4gKi9cbmZ1bmN0aW9uIGdldEV4dGVuc2lvbkFyZ3MgKGV4dGVuc2lvbkFyZ3MsIGV4dGVuc2lvbk5hbWUpIHtcbiAgaWYgKCFfLmhhcyhleHRlbnNpb25BcmdzLCBleHRlbnNpb25OYW1lKSkge1xuICAgIHJldHVybiB7fTtcbiAgfVxuICBpZiAoIV8uaXNQbGFpbk9iamVjdChleHRlbnNpb25BcmdzW2V4dGVuc2lvbk5hbWVdKSkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYERyaXZlciBvciBwbHVnaW4gYXJndW1lbnRzIG11c3QgYmUgcGxhaW4gb2JqZWN0c2ApO1xuICB9XG4gIHJldHVybiBleHRlbnNpb25BcmdzW2V4dGVuc2lvbk5hbWVdO1xufVxuXG5cbi8qKlxuICogR2l2ZW4gYSBzZXQgb2YgYXJncyBhbmQgYSBzZXQgb2YgY29uc3RyYWludHMsIHRocm93IGFuIGVycm9yIGlmIGFueSBhcmdzIGFyZSBub3QgbWVudGlvbmVkIGluXG4gKiB0aGUgc2V0IG9mIGNvbnN0cmFpbnRzXG4gKiBAcGFyYW0ge09iamVjdH0gZXh0ZW5zaW9uQXJncyB0aGUgYXJnc1xuICogQHBhcmFtIHtPYmplY3R9IGFyZ3NDb25zdHJhaW50cyB0aGUgY29uc3RyYWludHMgb2JqZWN0XG4gKiBAdGhyb3dzIHtFcnJvcn0gaWYgYW55IGFyZ3Mgd2VyZSBub3QgcmVjb2duaXplZFxuICovXG5mdW5jdGlvbiBlbnN1cmVOb1Vua25vd25BcmdzIChleHRlbnNpb25BcmdzLCBhcmdzQ29uc3RyYWludHMpIHtcbiAgY29uc3Qga25vd25BcmdOYW1lcyA9IE9iamVjdC5rZXlzKGFyZ3NDb25zdHJhaW50cyk7XG4gIGNvbnN0IHVua25vd25BcmdzID0gXy5kaWZmZXJlbmNlKE9iamVjdC5rZXlzKGV4dGVuc2lvbkFyZ3MpLCBrbm93bkFyZ05hbWVzKTtcbiAgaWYgKHVua25vd25BcmdzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFNvbWUgYXJndW1lbnRzIHdlcmUgbm90IHJlY29nbml6ZWQ6ICR7SlNPTi5zdHJpbmdpZnkodW5rbm93bkFyZ3MpfS4gYCArXG4gICAgICAgICAgICAgICAgICAgIGBBcmUgeW91IHN1cmUgdGhleSBhcmUgaW4gdGhlIGxpc3Qgb2Ygc3VwcG9ydGVkIGFyZ3M/ICR7SlNPTi5zdHJpbmdpZnkoa25vd25BcmdOYW1lcyl9YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBUYWtlcyBpbiBhIHNldCBvZiBkcml2ZXIvcGx1Z2luIGFyZ3MgcGFzc2VkIGluIGJ5IHVzZXIsIGFuZCBhcmcgY29uc3RyYWludHNcbiAqIGFuZCB0aHJvd3MgYW4gZXJyb3IgaWYgYW55IGFyZyBpcyB1bmtub3duIG9yIG9mIHRoZSBpbmNvcnJlY3QgdHlwZVxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBleHRlbnNpb25BcmdzIC0gRHJpdmVyIG9yIFBsdWdpbiBzcGVjaWZpYyBhcmdzXG4gKiBAcGFyYW0ge29iamVjdH0gYXJnc0NvbnN0cmFpbnRzIC0gQ29uc3RyYWludHMgZm9yIGFyZ3VtZW50c1xuICogQHRocm93cyB7RXJyb3J9IGlmIGFueSBhcmdzIGFyZSBub3QgcmVjb2duaXplZCBvciBhcmUgb2YgYW4gaW52YWxpZCB0eXBlXG4qL1xuZnVuY3Rpb24gdmFsaWRhdGVFeHRlbnNpb25BcmdzIChleHRlbnNpb25BcmdzLCBhcmdzQ29uc3RyYWludHMpIHtcbiAgaWYgKCFfLmlzRW1wdHkoZXh0ZW5zaW9uQXJncykgJiYgIV8uaXNFbXB0eShhcmdzQ29uc3RyYWludHMpKSB7XG4gICAgZW5zdXJlTm9Vbmtub3duQXJncyhleHRlbnNpb25BcmdzLCBhcmdzQ29uc3RyYWludHMpO1xuICAgIHZhbGlkYXRlQXJncyhleHRlbnNpb25BcmdzLCBhcmdzQ29uc3RyYWludHMpO1xuICB9XG59XG5cblxuLyoqXG4gKiBUYWtlcyB0aGUgY2FwcyB0aGF0IHdlcmUgcHJvdmlkZWQgaW4gdGhlIHJlcXVlc3QgYW5kIHRyYW5zbGF0ZXMgdGhlbVxuICogaW50byBjYXBzIHRoYXQgY2FuIGJlIHVzZWQgYnkgdGhlIGlubmVyIGRyaXZlcnMuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGpzb253cENhcGFiaWxpdGllc1xuICogQHBhcmFtIHtPYmplY3R9IHczY0NhcGFiaWxpdGllc1xuICogQHBhcmFtIHtPYmplY3R9IGNvbnN0cmFpbnRzXG4gKiBAcGFyYW0ge09iamVjdH0gZGVmYXVsdENhcGFiaWxpdGllc1xuICovXG5mdW5jdGlvbiBwYXJzZUNhcHNGb3JJbm5lckRyaXZlciAoanNvbndwQ2FwYWJpbGl0aWVzLCB3M2NDYXBhYmlsaXRpZXMsIGNvbnN0cmFpbnRzID0ge30sIGRlZmF1bHRDYXBhYmlsaXRpZXMgPSB7fSkge1xuICAvLyBDaGVjayBpZiB0aGUgY2FsbGVyIHNlbnQgSlNPTldQIGNhcHMsIFczQyBjYXBzLCBvciBib3RoXG4gIGNvbnN0IGhhc1czQ0NhcHMgPSBfLmlzUGxhaW5PYmplY3QodzNjQ2FwYWJpbGl0aWVzKSAmJlxuICAgIChfLmhhcyh3M2NDYXBhYmlsaXRpZXMsICdhbHdheXNNYXRjaCcpIHx8IF8uaGFzKHczY0NhcGFiaWxpdGllcywgJ2ZpcnN0TWF0Y2gnKSk7XG4gIGNvbnN0IGhhc0pTT05XUENhcHMgPSBfLmlzUGxhaW5PYmplY3QoanNvbndwQ2FwYWJpbGl0aWVzKTtcbiAgbGV0IGRlc2lyZWRDYXBzID0ge307XG4gIGxldCBwcm9jZXNzZWRXM0NDYXBhYmlsaXRpZXMgPSBudWxsO1xuICBsZXQgcHJvY2Vzc2VkSnNvbndwQ2FwYWJpbGl0aWVzID0gbnVsbDtcblxuICBpZiAoIWhhc1czQ0NhcHMpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHJvdG9jb2w6IFBST1RPQ09MUy5XM0MsXG4gICAgICBlcnJvcjogbmV3IEVycm9yKCdXM0MgY2FwYWJpbGl0aWVzIHNob3VsZCBiZSBwcm92aWRlZCcpLFxuICAgIH07XG4gIH1cblxuICBjb25zdCB7VzNDfSA9IFBST1RPQ09MUztcbiAgY29uc3QgcHJvdG9jb2wgPSBXM0M7XG5cbiAgLy8gTWFrZSBzdXJlIHdlIGRvbid0IG11dGF0ZSB0aGUgb3JpZ2luYWwgYXJndW1lbnRzXG4gIGpzb253cENhcGFiaWxpdGllcyA9IF8uY2xvbmVEZWVwKGpzb253cENhcGFiaWxpdGllcyk7XG4gIHczY0NhcGFiaWxpdGllcyA9IF8uY2xvbmVEZWVwKHczY0NhcGFiaWxpdGllcyk7XG4gIGRlZmF1bHRDYXBhYmlsaXRpZXMgPSBfLmNsb25lRGVlcChkZWZhdWx0Q2FwYWJpbGl0aWVzKTtcblxuICBpZiAoIV8uaXNFbXB0eShkZWZhdWx0Q2FwYWJpbGl0aWVzKSkge1xuICAgIGlmIChoYXNXM0NDYXBzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtkZWZhdWx0Q2FwS2V5LCBkZWZhdWx0Q2FwVmFsdWVdIG9mIF8udG9QYWlycyhkZWZhdWx0Q2FwYWJpbGl0aWVzKSkge1xuICAgICAgICBsZXQgaXNDYXBBbHJlYWR5U2V0ID0gZmFsc2U7XG4gICAgICAgIC8vIENoZWNrIGlmIHRoZSBrZXkgaXMgYWxyZWFkeSBwcmVzZW50IGluIGZpcnN0TWF0Y2ggZW50cmllc1xuICAgICAgICBmb3IgKGNvbnN0IGZpcnN0TWF0Y2hFbnRyeSBvZiAodzNjQ2FwYWJpbGl0aWVzLmZpcnN0TWF0Y2ggfHwgW10pKSB7XG4gICAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChmaXJzdE1hdGNoRW50cnkpXG4gICAgICAgICAgICAgICYmIF8uaGFzKHJlbW92ZUFwcGl1bVByZWZpeGVzKGZpcnN0TWF0Y2hFbnRyeSksIHJlbW92ZUFwcGl1bVByZWZpeChkZWZhdWx0Q2FwS2V5KSkpIHtcbiAgICAgICAgICAgIGlzQ2FwQWxyZWFkeVNldCA9IHRydWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGtleSBpcyBhbHJlYWR5IHByZXNlbnQgaW4gYWx3YXlzTWF0Y2ggZW50cmllc1xuICAgICAgICBpc0NhcEFscmVhZHlTZXQgPSBpc0NhcEFscmVhZHlTZXQgfHwgKF8uaXNQbGFpbk9iamVjdCh3M2NDYXBhYmlsaXRpZXMuYWx3YXlzTWF0Y2gpXG4gICAgICAgICAgJiYgXy5oYXMocmVtb3ZlQXBwaXVtUHJlZml4ZXModzNjQ2FwYWJpbGl0aWVzLmFsd2F5c01hdGNoKSwgcmVtb3ZlQXBwaXVtUHJlZml4KGRlZmF1bHRDYXBLZXkpKSk7XG4gICAgICAgIGlmIChpc0NhcEFscmVhZHlTZXQpIHtcbiAgICAgICAgICAvLyBTa2lwIGlmIHRoZSBrZXkgaXMgYWxyZWFkeSBwcmVzZW50IGluIHRoZSBwcm92aWRlZCBjYXBzXG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBPbmx5IGFkZCB0aGUgZGVmYXVsdCBjYXBhYmlsaXR5IGlmIGl0IGlzIG5vdCBvdmVycmlkZGVuXG4gICAgICAgIGlmIChfLmlzRW1wdHkodzNjQ2FwYWJpbGl0aWVzLmZpcnN0TWF0Y2gpKSB7XG4gICAgICAgICAgdzNjQ2FwYWJpbGl0aWVzLmZpcnN0TWF0Y2ggPSBbe1tkZWZhdWx0Q2FwS2V5XTogZGVmYXVsdENhcFZhbHVlfV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdzNjQ2FwYWJpbGl0aWVzLmZpcnN0TWF0Y2hbMF1bZGVmYXVsdENhcEtleV0gPSBkZWZhdWx0Q2FwVmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGhhc0pTT05XUENhcHMpIHtcbiAgICAgIGpzb253cENhcGFiaWxpdGllcyA9IE9iamVjdC5hc3NpZ24oe30sIHJlbW92ZUFwcGl1bVByZWZpeGVzKGRlZmF1bHRDYXBhYmlsaXRpZXMpLCBqc29ud3BDYXBhYmlsaXRpZXMpO1xuICAgIH1cbiAgfVxuXG4gIC8vIEdldCBNSlNPTldQIGNhcHNcbiAgaWYgKGhhc0pTT05XUENhcHMpIHtcbiAgICBwcm9jZXNzZWRKc29ud3BDYXBhYmlsaXRpZXMgPSB7Li4uanNvbndwQ2FwYWJpbGl0aWVzfTtcbiAgfVxuXG4gIC8vIEdldCBXM0MgY2Fwc1xuICBpZiAoaGFzVzNDQ2Fwcykge1xuICAgIC8vIENhbGwgdGhlIHByb2Nlc3MgY2FwYWJpbGl0aWVzIGFsZ29yaXRobSB0byBmaW5kIG1hdGNoaW5nIGNhcHMgb24gdGhlIFczQ1xuICAgIC8vIChzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qbGlwcHMvc2ltcGxlLXdkLXNwZWMjcHJvY2Vzc2luZy1jYXBhYmlsaXRpZXMpXG4gICAgdHJ5IHtcbiAgICAgIGRlc2lyZWRDYXBzID0gcHJvY2Vzc0NhcGFiaWxpdGllcyh3M2NDYXBhYmlsaXRpZXMsIGNvbnN0cmFpbnRzLCB0cnVlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmluZm8oYENvdWxkIG5vdCBwYXJzZSBXM0MgY2FwYWJpbGl0aWVzOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBkZXNpcmVkQ2FwcyxcbiAgICAgICAgcHJvY2Vzc2VkSnNvbndwQ2FwYWJpbGl0aWVzLFxuICAgICAgICBwcm9jZXNzZWRXM0NDYXBhYmlsaXRpZXMsXG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICBlcnJvcixcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGEgbmV3IHczYyBjYXBhYmlsaXRpZXMgcGF5bG9hZCB0aGF0IGNvbnRhaW5zIG9ubHkgdGhlIG1hdGNoaW5nIGNhcHMgaW4gYGFsd2F5c01hdGNoYFxuICAgIHByb2Nlc3NlZFczQ0NhcGFiaWxpdGllcyA9IHtcbiAgICAgIGFsd2F5c01hdGNoOiB7Li4uaW5zZXJ0QXBwaXVtUHJlZml4ZXMoZGVzaXJlZENhcHMpfSxcbiAgICAgIGZpcnN0TWF0Y2g6IFt7fV0sXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB7ZGVzaXJlZENhcHMsIHByb2Nlc3NlZEpzb253cENhcGFiaWxpdGllcywgcHJvY2Vzc2VkVzNDQ2FwYWJpbGl0aWVzLCBwcm90b2NvbH07XG59XG5cbi8qKlxuICogVGFrZXMgYSBjYXBhYmlsaXRpZXMgb2JqZWN0cyBhbmQgcHJlZml4ZXMgY2FwYWJpbGl0aWVzIHdpdGggYGFwcGl1bTpgXG4gKiBAcGFyYW0ge09iamVjdH0gY2FwcyBEZXNpcmVkIGNhcGFiaWxpdGllcyBvYmplY3RcbiAqL1xuZnVuY3Rpb24gaW5zZXJ0QXBwaXVtUHJlZml4ZXMgKGNhcHMpIHtcbiAgLy8gU3RhbmRhcmQsIG5vbi1wcmVmaXhlZCBjYXBhYmlsaXRpZXMgKHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvd2ViZHJpdmVyLyNkZm4tdGFibGUtb2Ytc3RhbmRhcmQtY2FwYWJpbGl0aWVzKVxuICBjb25zdCBTVEFOREFSRF9DQVBTID0gW1xuICAgICdicm93c2VyTmFtZScsXG4gICAgJ2Jyb3dzZXJWZXJzaW9uJyxcbiAgICAncGxhdGZvcm1OYW1lJyxcbiAgICAnYWNjZXB0SW5zZWN1cmVDZXJ0cycsXG4gICAgJ3BhZ2VMb2FkU3RyYXRlZ3knLFxuICAgICdwcm94eScsXG4gICAgJ3NldFdpbmRvd1JlY3QnLFxuICAgICd0aW1lb3V0cycsXG4gICAgJ3VuaGFuZGxlZFByb21wdEJlaGF2aW9yJ1xuICBdO1xuXG4gIGxldCBwcmVmaXhlZENhcHMgPSB7fTtcbiAgZm9yIChsZXQgW25hbWUsIHZhbHVlXSBvZiBfLnRvUGFpcnMoY2FwcykpIHtcbiAgICBpZiAoU1RBTkRBUkRfQ0FQUy5pbmNsdWRlcyhuYW1lKSB8fCBuYW1lLmluY2x1ZGVzKCc6JykpIHtcbiAgICAgIHByZWZpeGVkQ2Fwc1tuYW1lXSA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcmVmaXhlZENhcHNbYCR7VzNDX0FQUElVTV9QUkVGSVh9OiR7bmFtZX1gXSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcHJlZml4ZWRDYXBzO1xufVxuXG5mdW5jdGlvbiByZW1vdmVBcHBpdW1QcmVmaXhlcyAoY2Fwcykge1xuICBpZiAoIV8uaXNQbGFpbk9iamVjdChjYXBzKSkge1xuICAgIHJldHVybiBjYXBzO1xuICB9XG5cbiAgY29uc3QgZml4ZWRDYXBzID0ge307XG4gIGZvciAobGV0IFtuYW1lLCB2YWx1ZV0gb2YgXy50b1BhaXJzKGNhcHMpKSB7XG4gICAgZml4ZWRDYXBzW3JlbW92ZUFwcGl1bVByZWZpeChuYW1lKV0gPSB2YWx1ZTtcbiAgfVxuICByZXR1cm4gZml4ZWRDYXBzO1xufVxuXG5mdW5jdGlvbiByZW1vdmVBcHBpdW1QcmVmaXggKGtleSkge1xuICBjb25zdCBwcmVmaXggPSBgJHtXM0NfQVBQSVVNX1BSRUZJWH06YDtcbiAgcmV0dXJuIF8uc3RhcnRzV2l0aChrZXksIHByZWZpeCkgPyBrZXkuc3Vic3RyaW5nKHByZWZpeC5sZW5ndGgpIDoga2V5O1xufVxuXG5mdW5jdGlvbiBnZXRQYWNrYWdlVmVyc2lvbiAocGtnTmFtZSkge1xuICBjb25zdCBwa2dJbmZvID0gcmVxdWlyZShgJHtwa2dOYW1lfS9wYWNrYWdlLmpzb25gKSB8fCB7fTtcbiAgcmV0dXJuIHBrZ0luZm8udmVyc2lvbjtcbn1cblxuLyoqXG4gKiBQdWxscyB0aGUgaW5pdGlhbCB2YWx1ZXMgb2YgQXBwaXVtIHNldHRpbmdzIGZyb20gdGhlIGdpdmVuIGNhcGFiaWxpdGllcyBhcmd1bWVudC5cbiAqIEVhY2ggc2V0dGluZyBpdGVtIG11c3Qgc2F0aXNmeSB0aGUgZm9sbG93aW5nIGZvcm1hdDpcbiAqIGBzZXR0aW5nW3NldHRpbmdfbmFtZV06IHNldHRpbmdfdmFsdWVgXG4gKiBUaGUgY2FwYWJpbGl0aWVzIGFyZ3VtZW50IGl0c2VsZiBnZXRzIG11dGF0ZWQsIHNvIGl0IGRvZXMgbm90IGNvbnRhaW4gcGFyc2VkXG4gKiBzZXR0aW5ncyBhbnltb3JlIHRvIGF2b2lkIGZ1cnRoZXIgcGFyc2luZyBpc3N1ZXMuXG4gKiBDaGVja1xuICogaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vYmxvYi9tYXN0ZXIvZG9jcy9lbi9hZHZhbmNlZC1jb25jZXB0cy9zZXR0aW5ncy5tZFxuICogZm9yIG1vcmUgZGV0YWlscyBvbiB0aGUgYXZhaWxhYmxlIHNldHRpbmdzLlxuICpcbiAqIEBwYXJhbSB7P09iamVjdH0gY2FwcyAtIENhcGFiaWxpdGllcyBkaWN0aW9uYXJ5LiBJdCBpcyBtdXRhdGVkIGlmXG4gKiBvbmUgb3IgbW9yZSBzZXR0aW5ncyBoYXZlIGJlZW4gcHVsbGVkIGZyb20gaXRcbiAqIEByZXR1cm4ge09iamVjdH0gLSBBbiBlbXB0eSBkaWN0aW9uYXJ5IGlmIHRoZSBnaXZlbiBjYXBzIGNvbnRhaW5zIG5vXG4gKiBzZXR0aW5nIGl0ZW1zIG9yIGEgZGljdGlvbmFyeSBjb250YWluaW5nIHBhcnNlZCBBcHBpdW0gc2V0dGluZyBuYW1lcyBhbG9uZyB3aXRoXG4gKiB0aGVpciB2YWx1ZXMuXG4gKi9cbmZ1bmN0aW9uIHB1bGxTZXR0aW5ncyAoY2Fwcykge1xuICBpZiAoIV8uaXNQbGFpbk9iamVjdChjYXBzKSB8fCBfLmlzRW1wdHkoY2FwcykpIHtcbiAgICByZXR1cm4ge307XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSB7fTtcbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgXy50b1BhaXJzKGNhcHMpKSB7XG4gICAgY29uc3QgbWF0Y2ggPSAvXFxic2V0dGluZ3NcXFsoXFxTKylcXF0kLy5leGVjKGtleSk7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgcmVzdWx0W21hdGNoWzFdXSA9IHZhbHVlO1xuICAgIGRlbGV0ZSBjYXBzW2tleV07XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuY29uc3Qgcm9vdERpciA9IGZzLmZpbmRSb290KF9fZGlybmFtZSk7XG5cbmV4cG9ydCB7XG4gIGluc3BlY3RPYmplY3QsIHBhcnNlQ2Fwc0ZvcklubmVyRHJpdmVyLCBpbnNlcnRBcHBpdW1QcmVmaXhlcywgcm9vdERpcixcbiAgZ2V0UGFja2FnZVZlcnNpb24sIHB1bGxTZXR0aW5ncywgcmVtb3ZlQXBwaXVtUHJlZml4ZXMsIGdldEV4dGVuc2lvbkFyZ3MsXG4gIHZhbGlkYXRlRXh0ZW5zaW9uQXJnc1xufTtcbiJdLCJmaWxlIjoibGliL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
