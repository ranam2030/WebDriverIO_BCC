"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PLUGIN_TYPE = exports.INSTALL_TYPE_NPM = exports.INSTALL_TYPE_LOCAL = exports.INSTALL_TYPE_GITHUB = exports.INSTALL_TYPE_GIT = exports.INSTALL_TYPES = exports.DRIVER_TYPE = exports.DEFAULT_APPIUM_HOME = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _support = require("@appium/support");

var _path = _interopRequireDefault(require("path"));

var _os = _interopRequireDefault(require("os"));

var _yaml = _interopRequireDefault(require("yaml"));

const DRIVER_TYPE = 'driver';
exports.DRIVER_TYPE = DRIVER_TYPE;
const PLUGIN_TYPE = 'plugin';
exports.PLUGIN_TYPE = PLUGIN_TYPE;

const DEFAULT_APPIUM_HOME = _path.default.resolve(_os.default.homedir(), '.appium');

exports.DEFAULT_APPIUM_HOME = DEFAULT_APPIUM_HOME;
const CONFIG_FILE_NAME = 'extensions.yaml';
const CONFIG_SCHEMA_REV = 2;
const INSTALL_TYPE_NPM = 'npm';
exports.INSTALL_TYPE_NPM = INSTALL_TYPE_NPM;
const INSTALL_TYPE_LOCAL = 'local';
exports.INSTALL_TYPE_LOCAL = INSTALL_TYPE_LOCAL;
const INSTALL_TYPE_GITHUB = 'github';
exports.INSTALL_TYPE_GITHUB = INSTALL_TYPE_GITHUB;
const INSTALL_TYPE_GIT = 'git';
exports.INSTALL_TYPE_GIT = INSTALL_TYPE_GIT;
const INSTALL_TYPES = [INSTALL_TYPE_GIT, INSTALL_TYPE_GITHUB, INSTALL_TYPE_LOCAL, INSTALL_TYPE_NPM];
exports.INSTALL_TYPES = INSTALL_TYPES;

class ExtensionConfig {
  constructor(appiumHome, extensionType, logFn = null) {
    if (logFn === null) {
      logFn = _logger.default.error.bind(_logger.default);
    }

    this.appiumHome = appiumHome;
    this.configFile = _path.default.resolve(this.appiumHome, CONFIG_FILE_NAME);
    this.installedExtensions = {};
    this.extensionType = extensionType;
    this.configKey = `${extensionType}s`;
    this.yamlData = {
      [`${DRIVER_TYPE}s`]: {},
      [`${PLUGIN_TYPE}s`]: {}
    };
    this.log = logFn;
  }

  validate(exts) {
    const foundProblems = {};

    for (const [extName, extData] of _lodash.default.toPairs(exts)) {
      foundProblems[extName] = [...this.getGenericConfigProblems(extData), ...this.getConfigProblems(extData)];
    }

    const problemSummaries = [];

    for (const [extName, problems] of _lodash.default.toPairs(foundProblems)) {
      if (_lodash.default.isEmpty(problems)) {
        continue;
      }

      delete exts[extName];
      problemSummaries.push(`${this.extensionType} ${extName} had errors and will not ` + `be available. Errors:`);

      for (const problem of problems) {
        problemSummaries.push(`  - ${problem.err} (Actual value: ` + `${JSON.stringify(problem.val)})`);
      }
    }

    if (!_lodash.default.isEmpty(problemSummaries)) {
      this.log(`Appium encountered one or more errors while validating ` + `the ${this.configKey} extension file (${this.configFile}):`);

      for (const summary of problemSummaries) {
        this.log(summary);
      }
    }

    return exts;
  }

  getGenericConfigProblems(ext) {
    const {
      version,
      pkgName,
      installSpec,
      installType,
      installPath,
      mainClass
    } = ext;
    const problems = [];

    if (!_lodash.default.isString(version)) {
      problems.push({
        err: 'Missing or incorrect version',
        val: version
      });
    }

    if (!_lodash.default.isString(pkgName)) {
      problems.push({
        err: 'Missing or incorrect NPM package name',
        val: pkgName
      });
    }

    if (!_lodash.default.isString(installSpec)) {
      problems.push({
        err: 'Missing or incorrect installation spec',
        val: installSpec
      });
    }

    if (!_lodash.default.includes(INSTALL_TYPES, installType)) {
      problems.push({
        err: 'Missing or incorrect install type',
        val: installType
      });
    }

    if (!_lodash.default.isString(installPath)) {
      problems.push({
        err: 'Missing or incorrect installation path',
        val: installPath
      });
    }

    if (!_lodash.default.isString(mainClass)) {
      problems.push({
        err: 'Missing or incorrect driver class name',
        val: mainClass
      });
    }

    return problems;
  }

  getConfigProblems() {
    return [];
  }

  applySchemaMigrations() {
    if (this.yamlData.schemaRev < 2 && _lodash.default.isUndefined(this.yamlData[PLUGIN_TYPE])) {
      this.yamlData[PLUGIN_TYPE] = {};
    }
  }

  async read() {
    await (0, _support.mkdirp)(this.appiumHome);

    try {
      this.yamlData = _yaml.default.parse(await _support.fs.readFile(this.configFile, 'utf8'));
      this.applySchemaMigrations();
      this.installedExtensions = this.validate(this.yamlData[this.configKey]);
    } catch (err) {
      if (await _support.fs.exists(this.configFile)) {
        throw new Error(`Appium had trouble loading the extension installation ` + `cache file (${this.configFile}). Ensure it exists and is ` + `readable. Specific error: ${err.message}`);
      }

      try {
        await this.write();
      } catch {
        throw new Error(`Appium could not read or write from the Appium Home directory ` + `(${this.appiumHome}). Please ensure it is writable.`);
      }
    }

    return this.installedExtensions;
  }

  async write() {
    const newYamlData = { ...this.yamlData,
      schemaRev: CONFIG_SCHEMA_REV,
      [this.configKey]: this.installedExtensions
    };
    await _support.fs.writeFile(this.configFile, _yaml.default.stringify(newYamlData), 'utf8');
  }

  async addExtension(extName, extData) {
    this.installedExtensions[extName] = extData;
    await this.write();
  }

  async updateExtension(extName, extData) {
    this.installedExtensions[extName] = { ...this.installedExtensions[extName],
      ...extData
    };
    await this.write();
  }

  async removeExtension(extName) {
    delete this.installedExtensions[extName];
    await this.write();
  }

  print() {
    const extNames = Object.keys(this.installedExtensions);

    if (_lodash.default.isEmpty(extNames)) {
      _logger.default.info(`No ${this.configKey} have been installed. Use the "appium ${this.extensionType}" ` + 'command to install the one(s) you want to use.');

      return;
    }

    _logger.default.info(`Available ${this.configKey}:`);

    for (const [extName, extData] of _lodash.default.toPairs(this.installedExtensions)) {
      _logger.default.info(`  - ${this.extensionDesc(extName, extData)}`);
    }
  }

  extensionDesc() {
    throw new Error('This must be implemented in a final class');
  }

  getExtensionRequirePath(extName) {
    const {
      pkgName,
      installPath
    } = this.installedExtensions[extName];
    return _path.default.resolve(this.appiumHome, installPath, 'node_modules', pkgName);
  }

  getInstallPath(extName) {
    const {
      installPath
    } = this.installedExtensions[extName];
    return _path.default.resolve(this.appiumHome, installPath);
  }

  require(extName) {
    const {
      mainClass
    } = this.installedExtensions[extName];
    const reqPath = this.getExtensionRequirePath(extName);

    const reqResolved = require.resolve(reqPath);

    if (process.env.APPIUM_RELOAD_EXTENSIONS && require.cache[reqResolved]) {
      _logger.default.debug(`Removing ${reqResolved} from require cache`);

      delete require.cache[reqResolved];
    }

    return require(reqPath)[mainClass];
  }

  isInstalled(extName) {
    return _lodash.default.includes(Object.keys(this.installedExtensions), extName);
  }

}

exports.default = ExtensionConfig;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHRlbnNpb24tY29uZmlnLmpzIl0sIm5hbWVzIjpbIkRSSVZFUl9UWVBFIiwiUExVR0lOX1RZUEUiLCJERUZBVUxUX0FQUElVTV9IT01FIiwicGF0aCIsInJlc29sdmUiLCJvcyIsImhvbWVkaXIiLCJDT05GSUdfRklMRV9OQU1FIiwiQ09ORklHX1NDSEVNQV9SRVYiLCJJTlNUQUxMX1RZUEVfTlBNIiwiSU5TVEFMTF9UWVBFX0xPQ0FMIiwiSU5TVEFMTF9UWVBFX0dJVEhVQiIsIklOU1RBTExfVFlQRV9HSVQiLCJJTlNUQUxMX1RZUEVTIiwiRXh0ZW5zaW9uQ29uZmlnIiwiY29uc3RydWN0b3IiLCJhcHBpdW1Ib21lIiwiZXh0ZW5zaW9uVHlwZSIsImxvZ0ZuIiwibG9nIiwiZXJyb3IiLCJiaW5kIiwiY29uZmlnRmlsZSIsImluc3RhbGxlZEV4dGVuc2lvbnMiLCJjb25maWdLZXkiLCJ5YW1sRGF0YSIsInZhbGlkYXRlIiwiZXh0cyIsImZvdW5kUHJvYmxlbXMiLCJleHROYW1lIiwiZXh0RGF0YSIsIl8iLCJ0b1BhaXJzIiwiZ2V0R2VuZXJpY0NvbmZpZ1Byb2JsZW1zIiwiZ2V0Q29uZmlnUHJvYmxlbXMiLCJwcm9ibGVtU3VtbWFyaWVzIiwicHJvYmxlbXMiLCJpc0VtcHR5IiwicHVzaCIsInByb2JsZW0iLCJlcnIiLCJKU09OIiwic3RyaW5naWZ5IiwidmFsIiwic3VtbWFyeSIsImV4dCIsInZlcnNpb24iLCJwa2dOYW1lIiwiaW5zdGFsbFNwZWMiLCJpbnN0YWxsVHlwZSIsImluc3RhbGxQYXRoIiwibWFpbkNsYXNzIiwiaXNTdHJpbmciLCJpbmNsdWRlcyIsImFwcGx5U2NoZW1hTWlncmF0aW9ucyIsInNjaGVtYVJldiIsImlzVW5kZWZpbmVkIiwicmVhZCIsIllBTUwiLCJwYXJzZSIsImZzIiwicmVhZEZpbGUiLCJleGlzdHMiLCJFcnJvciIsIm1lc3NhZ2UiLCJ3cml0ZSIsIm5ld1lhbWxEYXRhIiwid3JpdGVGaWxlIiwiYWRkRXh0ZW5zaW9uIiwidXBkYXRlRXh0ZW5zaW9uIiwicmVtb3ZlRXh0ZW5zaW9uIiwicHJpbnQiLCJleHROYW1lcyIsIk9iamVjdCIsImtleXMiLCJpbmZvIiwiZXh0ZW5zaW9uRGVzYyIsImdldEV4dGVuc2lvblJlcXVpcmVQYXRoIiwiZ2V0SW5zdGFsbFBhdGgiLCJyZXF1aXJlIiwicmVxUGF0aCIsInJlcVJlc29sdmVkIiwicHJvY2VzcyIsImVudiIsIkFQUElVTV9SRUxPQURfRVhURU5TSU9OUyIsImNhY2hlIiwiZGVidWciLCJpc0luc3RhbGxlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxXQUFXLEdBQUcsUUFBcEI7O0FBQ0EsTUFBTUMsV0FBVyxHQUFHLFFBQXBCOzs7QUFDQSxNQUFNQyxtQkFBbUIsR0FBR0MsY0FBS0MsT0FBTCxDQUFhQyxZQUFHQyxPQUFILEVBQWIsRUFBMkIsU0FBM0IsQ0FBNUI7OztBQUVBLE1BQU1DLGdCQUFnQixHQUFHLGlCQUF6QjtBQUNBLE1BQU1DLGlCQUFpQixHQUFHLENBQTFCO0FBRUEsTUFBTUMsZ0JBQWdCLEdBQUcsS0FBekI7O0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsT0FBM0I7O0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUcsUUFBNUI7O0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsS0FBekI7O0FBQ0EsTUFBTUMsYUFBYSxHQUFHLENBQ3BCRCxnQkFEb0IsRUFFcEJELG1CQUZvQixFQUdwQkQsa0JBSG9CLEVBSXBCRCxnQkFKb0IsQ0FBdEI7OztBQVFlLE1BQU1LLGVBQU4sQ0FBc0I7QUFDbkNDLEVBQUFBLFdBQVcsQ0FBRUMsVUFBRixFQUFjQyxhQUFkLEVBQTZCQyxLQUFLLEdBQUcsSUFBckMsRUFBMkM7QUFDcEQsUUFBSUEsS0FBSyxLQUFLLElBQWQsRUFBb0I7QUFDbEJBLE1BQUFBLEtBQUssR0FBR0MsZ0JBQUlDLEtBQUosQ0FBVUMsSUFBVixDQUFlRixlQUFmLENBQVI7QUFDRDs7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QUFFc0IsUUFBRixDQUFXb0IsTUFBTSxDQUFDQyxJQUFQLENBQVksS0FBS25ELG1CQUFqQixDQUFYLEVBQWtETSxPQUFsRCxDQUFQO0FBQ0Q7O0FBOUxrQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGZzLCBta2RpcnAgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IFlBTUwgZnJvbSAneWFtbCc7XG5cbmNvbnN0IERSSVZFUl9UWVBFID0gJ2RyaXZlcic7XG5jb25zdCBQTFVHSU5fVFlQRSA9ICdwbHVnaW4nO1xuY29uc3QgREVGQVVMVF9BUFBJVU1fSE9NRSA9IHBhdGgucmVzb2x2ZShvcy5ob21lZGlyKCksICcuYXBwaXVtJyk7XG5cbmNvbnN0IENPTkZJR19GSUxFX05BTUUgPSAnZXh0ZW5zaW9ucy55YW1sJztcbmNvbnN0IENPTkZJR19TQ0hFTUFfUkVWID0gMjtcblxuY29uc3QgSU5TVEFMTF9UWVBFX05QTSA9ICducG0nO1xuY29uc3QgSU5TVEFMTF9UWVBFX0xPQ0FMID0gJ2xvY2FsJztcbmNvbnN0IElOU1RBTExfVFlQRV9HSVRIVUIgPSAnZ2l0aHViJztcbmNvbnN0IElOU1RBTExfVFlQRV9HSVQgPSAnZ2l0JztcbmNvbnN0IElOU1RBTExfVFlQRVMgPSBbXG4gIElOU1RBTExfVFlQRV9HSVQsXG4gIElOU1RBTExfVFlQRV9HSVRIVUIsXG4gIElOU1RBTExfVFlQRV9MT0NBTCxcbiAgSU5TVEFMTF9UWVBFX05QTVxuXTtcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFeHRlbnNpb25Db25maWcge1xuICBjb25zdHJ1Y3RvciAoYXBwaXVtSG9tZSwgZXh0ZW5zaW9uVHlwZSwgbG9nRm4gPSBudWxsKSB7XG4gICAgaWYgKGxvZ0ZuID09PSBudWxsKSB7XG4gICAgICBsb2dGbiA9IGxvZy5lcnJvci5iaW5kKGxvZyk7XG4gICAgfVxuICAgIHRoaXMuYXBwaXVtSG9tZSA9IGFwcGl1bUhvbWU7XG4gICAgdGhpcy5jb25maWdGaWxlID0gcGF0aC5yZXNvbHZlKHRoaXMuYXBwaXVtSG9tZSwgQ09ORklHX0ZJTEVfTkFNRSk7XG4gICAgdGhpcy5pbnN0YWxsZWRFeHRlbnNpb25zID0ge307XG4gICAgdGhpcy5leHRlbnNpb25UeXBlID0gZXh0ZW5zaW9uVHlwZTtcbiAgICB0aGlzLmNvbmZpZ0tleSA9IGAke2V4dGVuc2lvblR5cGV9c2A7XG4gICAgdGhpcy55YW1sRGF0YSA9IHtbYCR7RFJJVkVSX1RZUEV9c2BdOiB7fSwgW2Ake1BMVUdJTl9UWVBFfXNgXToge319O1xuICAgIHRoaXMubG9nID0gbG9nRm47XG4gIH1cblxuICB2YWxpZGF0ZSAoZXh0cykge1xuICAgIGNvbnN0IGZvdW5kUHJvYmxlbXMgPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtleHROYW1lLCBleHREYXRhXSBvZiBfLnRvUGFpcnMoZXh0cykpIHtcbiAgICAgIGZvdW5kUHJvYmxlbXNbZXh0TmFtZV0gPSBbXG4gICAgICAgIC4uLnRoaXMuZ2V0R2VuZXJpY0NvbmZpZ1Byb2JsZW1zKGV4dERhdGEpLFxuICAgICAgICAuLi50aGlzLmdldENvbmZpZ1Byb2JsZW1zKGV4dERhdGEpXG4gICAgICBdO1xuICAgIH1cblxuICAgIGNvbnN0IHByb2JsZW1TdW1tYXJpZXMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IFtleHROYW1lLCBwcm9ibGVtc10gb2YgXy50b1BhaXJzKGZvdW5kUHJvYmxlbXMpKSB7XG4gICAgICBpZiAoXy5pc0VtcHR5KHByb2JsZW1zKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIC8vIHJlbW92ZSB0aGlzIGV4dGVuc2lvbiBmcm9tIHRoZSBsaXN0IHNpbmNlIGl0J3Mgbm90IHZhbGlkXG4gICAgICBkZWxldGUgZXh0c1tleHROYW1lXTtcbiAgICAgIHByb2JsZW1TdW1tYXJpZXMucHVzaChgJHt0aGlzLmV4dGVuc2lvblR5cGV9ICR7ZXh0TmFtZX0gaGFkIGVycm9ycyBhbmQgd2lsbCBub3QgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYGJlIGF2YWlsYWJsZS4gRXJyb3JzOmApO1xuICAgICAgZm9yIChjb25zdCBwcm9ibGVtIG9mIHByb2JsZW1zKSB7XG4gICAgICAgIHByb2JsZW1TdW1tYXJpZXMucHVzaChgICAtICR7cHJvYmxlbS5lcnJ9IChBY3R1YWwgdmFsdWU6IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7SlNPTi5zdHJpbmdpZnkocHJvYmxlbS52YWwpfSlgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIV8uaXNFbXB0eShwcm9ibGVtU3VtbWFyaWVzKSkge1xuICAgICAgdGhpcy5sb2coYEFwcGl1bSBlbmNvdW50ZXJlZCBvbmUgb3IgbW9yZSBlcnJvcnMgd2hpbGUgdmFsaWRhdGluZyBgICtcbiAgICAgICAgICAgICAgIGB0aGUgJHt0aGlzLmNvbmZpZ0tleX0gZXh0ZW5zaW9uIGZpbGUgKCR7dGhpcy5jb25maWdGaWxlfSk6YCk7XG4gICAgICBmb3IgKGNvbnN0IHN1bW1hcnkgb2YgcHJvYmxlbVN1bW1hcmllcykge1xuICAgICAgICB0aGlzLmxvZyhzdW1tYXJ5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZXh0cztcbiAgfVxuXG4gIGdldEdlbmVyaWNDb25maWdQcm9ibGVtcyAoZXh0KSB7XG4gICAgY29uc3Qge3ZlcnNpb24sIHBrZ05hbWUsIGluc3RhbGxTcGVjLCBpbnN0YWxsVHlwZSwgaW5zdGFsbFBhdGgsIG1haW5DbGFzc30gPSBleHQ7XG4gICAgY29uc3QgcHJvYmxlbXMgPSBbXTtcblxuICAgIGlmICghXy5pc1N0cmluZyh2ZXJzaW9uKSkge1xuICAgICAgcHJvYmxlbXMucHVzaCh7ZXJyOiAnTWlzc2luZyBvciBpbmNvcnJlY3QgdmVyc2lvbicsIHZhbDogdmVyc2lvbn0pO1xuICAgIH1cblxuICAgIGlmICghXy5pc1N0cmluZyhwa2dOYW1lKSkge1xuICAgICAgcHJvYmxlbXMucHVzaCh7ZXJyOiAnTWlzc2luZyBvciBpbmNvcnJlY3QgTlBNIHBhY2thZ2UgbmFtZScsIHZhbDogcGtnTmFtZX0pO1xuICAgIH1cblxuICAgIGlmICghXy5pc1N0cmluZyhpbnN0YWxsU3BlYykpIHtcbiAgICAgIHByb2JsZW1zLnB1c2goe2VycjogJ01pc3Npbmcgb3IgaW5jb3JyZWN0IGluc3RhbGxhdGlvbiBzcGVjJywgdmFsOiBpbnN0YWxsU3BlY30pO1xuICAgIH1cblxuICAgIGlmICghXy5pbmNsdWRlcyhJTlNUQUxMX1RZUEVTLCBpbnN0YWxsVHlwZSkpIHtcbiAgICAgIHByb2JsZW1zLnB1c2goe2VycjogJ01pc3Npbmcgb3IgaW5jb3JyZWN0IGluc3RhbGwgdHlwZScsIHZhbDogaW5zdGFsbFR5cGV9KTtcbiAgICB9XG5cbiAgICBpZiAoIV8uaXNTdHJpbmcoaW5zdGFsbFBhdGgpKSB7XG4gICAgICBwcm9ibGVtcy5wdXNoKHtlcnI6ICdNaXNzaW5nIG9yIGluY29ycmVjdCBpbnN0YWxsYXRpb24gcGF0aCcsIHZhbDogaW5zdGFsbFBhdGh9KTtcbiAgICB9XG5cbiAgICBpZiAoIV8uaXNTdHJpbmcobWFpbkNsYXNzKSkge1xuICAgICAgcHJvYmxlbXMucHVzaCh7ZXJyOiAnTWlzc2luZyBvciBpbmNvcnJlY3QgZHJpdmVyIGNsYXNzIG5hbWUnLCB2YWw6IG1haW5DbGFzc30pO1xuICAgIH1cblxuICAgIHJldHVybiBwcm9ibGVtcztcbiAgfVxuXG4gIGdldENvbmZpZ1Byb2JsZW1zICgvKmV4dCovKSB7XG4gICAgLy8gc2hvdWQgb3ZlcnJpZGUgdGhpcyBtZXRob2QgaWYgc3BlY2lhbCB2YWxpZGF0aW9uIGlzIG5lY2Vzc2FyeSBmb3IgdGhpcyBleHRlbnNpb24gdHlwZVxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGFwcGx5U2NoZW1hTWlncmF0aW9ucyAoKSB7XG4gICAgaWYgKHRoaXMueWFtbERhdGEuc2NoZW1hUmV2IDwgMiAmJiBfLmlzVW5kZWZpbmVkKHRoaXMueWFtbERhdGFbUExVR0lOX1RZUEVdKSkge1xuICAgICAgLy8gYXQgc2NoZW1hIHJldmlzaW9uIDIsIHdlIHN0YXJ0ZWQgaW5jbHVkaW5nIHBsdWdpbnMgYXMgd2VsbCBhcyBkcml2ZXJzIGluIHRoZSBmaWxlLFxuICAgICAgLy8gc28gbWFrZSBzdXJlIHdlIGF0IGxlYXN0IGhhdmUgYW4gZW1wdHkgc2VjdGlvbiBmb3IgaXRcbiAgICAgIHRoaXMueWFtbERhdGFbUExVR0lOX1RZUEVdID0ge307XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVhZCAoKSB7XG4gICAgYXdhaXQgbWtkaXJwKHRoaXMuYXBwaXVtSG9tZSk7IC8vIGVuc3VyZSBhcHBpdW0gaG9tZSBleGlzdHNcbiAgICB0cnkge1xuICAgICAgdGhpcy55YW1sRGF0YSA9IFlBTUwucGFyc2UoYXdhaXQgZnMucmVhZEZpbGUodGhpcy5jb25maWdGaWxlLCAndXRmOCcpKTtcbiAgICAgIHRoaXMuYXBwbHlTY2hlbWFNaWdyYXRpb25zKCk7XG5cbiAgICAgIC8vIHNldCB0aGUgbGlzdCBvZiBkcml2ZXJzIHRoZSB1c2VyIGhhcyBpbnN0YWxsZWRcbiAgICAgIHRoaXMuaW5zdGFsbGVkRXh0ZW5zaW9ucyA9IHRoaXMudmFsaWRhdGUodGhpcy55YW1sRGF0YVt0aGlzLmNvbmZpZ0tleV0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyh0aGlzLmNvbmZpZ0ZpbGUpKSB7XG4gICAgICAgIC8vIGlmIHRoZSBmaWxlIGV4aXN0cyBhbmQgd2UgY291bGRuJ3QgcGFyc2UgaXQsIHRoYXQncyBhIHByb2JsZW1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBcHBpdW0gaGFkIHRyb3VibGUgbG9hZGluZyB0aGUgZXh0ZW5zaW9uIGluc3RhbGxhdGlvbiBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGBjYWNoZSBmaWxlICgke3RoaXMuY29uZmlnRmlsZX0pLiBFbnN1cmUgaXQgZXhpc3RzIGFuZCBpcyBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGByZWFkYWJsZS4gU3BlY2lmaWMgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIHRoZSBjb25maWcgZmlsZSBkb2Vzbid0IGV4aXN0LCB0cnkgdG8gd3JpdGUgYW4gZW1wdHkgb25lLCB0byBtYWtlXG4gICAgICAvLyBzdXJlIHdlIGFjdHVhbGx5IGhhdmUgd3JpdGUgcHJpdmlsZWdlcywgYW5kIGNvbXBsYWluIGlmIHdlIGRvbid0XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLndyaXRlKCk7XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBcHBpdW0gY291bGQgbm90IHJlYWQgb3Igd3JpdGUgZnJvbSB0aGUgQXBwaXVtIEhvbWUgZGlyZWN0b3J5IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYCgke3RoaXMuYXBwaXVtSG9tZX0pLiBQbGVhc2UgZW5zdXJlIGl0IGlzIHdyaXRhYmxlLmApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5pbnN0YWxsZWRFeHRlbnNpb25zO1xuICB9XG5cblxuICBhc3luYyB3cml0ZSAoKSB7XG4gICAgY29uc3QgbmV3WWFtbERhdGEgPSB7XG4gICAgICAuLi50aGlzLnlhbWxEYXRhLFxuICAgICAgc2NoZW1hUmV2OiBDT05GSUdfU0NIRU1BX1JFVixcbiAgICAgIFt0aGlzLmNvbmZpZ0tleV06IHRoaXMuaW5zdGFsbGVkRXh0ZW5zaW9uc1xuICAgIH07XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHRoaXMuY29uZmlnRmlsZSwgWUFNTC5zdHJpbmdpZnkobmV3WWFtbERhdGEpLCAndXRmOCcpO1xuICB9XG5cbiAgYXN5bmMgYWRkRXh0ZW5zaW9uIChleHROYW1lLCBleHREYXRhKSB7XG4gICAgdGhpcy5pbnN0YWxsZWRFeHRlbnNpb25zW2V4dE5hbWVdID0gZXh0RGF0YTtcbiAgICBhd2FpdCB0aGlzLndyaXRlKCk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVFeHRlbnNpb24gKGV4dE5hbWUsIGV4dERhdGEpIHtcbiAgICB0aGlzLmluc3RhbGxlZEV4dGVuc2lvbnNbZXh0TmFtZV0gPSB7XG4gICAgICAuLi50aGlzLmluc3RhbGxlZEV4dGVuc2lvbnNbZXh0TmFtZV0sXG4gICAgICAuLi5leHREYXRhLFxuICAgIH07XG4gICAgYXdhaXQgdGhpcy53cml0ZSgpO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlRXh0ZW5zaW9uIChleHROYW1lKSB7XG4gICAgZGVsZXRlIHRoaXMuaW5zdGFsbGVkRXh0ZW5zaW9uc1tleHROYW1lXTtcbiAgICBhd2FpdCB0aGlzLndyaXRlKCk7XG4gIH1cblxuICBwcmludCAoKSB7XG4gICAgY29uc3QgZXh0TmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLmluc3RhbGxlZEV4dGVuc2lvbnMpO1xuICAgIGlmIChfLmlzRW1wdHkoZXh0TmFtZXMpKSB7XG4gICAgICBsb2cuaW5mbyhgTm8gJHt0aGlzLmNvbmZpZ0tleX0gaGF2ZSBiZWVuIGluc3RhbGxlZC4gVXNlIHRoZSBcImFwcGl1bSAke3RoaXMuZXh0ZW5zaW9uVHlwZX1cIiBgICtcbiAgICAgICAgICAgICAgICdjb21tYW5kIHRvIGluc3RhbGwgdGhlIG9uZShzKSB5b3Ugd2FudCB0byB1c2UuJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbG9nLmluZm8oYEF2YWlsYWJsZSAke3RoaXMuY29uZmlnS2V5fTpgKTtcbiAgICBmb3IgKGNvbnN0IFtleHROYW1lLCBleHREYXRhXSBvZiBfLnRvUGFpcnModGhpcy5pbnN0YWxsZWRFeHRlbnNpb25zKSkge1xuICAgICAgbG9nLmluZm8oYCAgLSAke3RoaXMuZXh0ZW5zaW9uRGVzYyhleHROYW1lLCBleHREYXRhKX1gKTtcbiAgICB9XG4gIH1cblxuICBleHRlbnNpb25EZXNjICgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoaXMgbXVzdCBiZSBpbXBsZW1lbnRlZCBpbiBhIGZpbmFsIGNsYXNzJyk7XG4gIH1cblxuICBnZXRFeHRlbnNpb25SZXF1aXJlUGF0aCAoZXh0TmFtZSkge1xuICAgIGNvbnN0IHtwa2dOYW1lLCBpbnN0YWxsUGF0aH0gPSB0aGlzLmluc3RhbGxlZEV4dGVuc2lvbnNbZXh0TmFtZV07XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZSh0aGlzLmFwcGl1bUhvbWUsIGluc3RhbGxQYXRoLCAnbm9kZV9tb2R1bGVzJywgcGtnTmFtZSk7XG4gIH1cblxuICBnZXRJbnN0YWxsUGF0aCAoZXh0TmFtZSkge1xuICAgIGNvbnN0IHtpbnN0YWxsUGF0aH0gPSB0aGlzLmluc3RhbGxlZEV4dGVuc2lvbnNbZXh0TmFtZV07XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZSh0aGlzLmFwcGl1bUhvbWUsIGluc3RhbGxQYXRoKTtcbiAgfVxuXG4gIHJlcXVpcmUgKGV4dE5hbWUpIHtcbiAgICBjb25zdCB7bWFpbkNsYXNzfSA9IHRoaXMuaW5zdGFsbGVkRXh0ZW5zaW9uc1tleHROYW1lXTtcbiAgICBjb25zdCByZXFQYXRoID0gdGhpcy5nZXRFeHRlbnNpb25SZXF1aXJlUGF0aChleHROYW1lKTtcbiAgICBjb25zdCByZXFSZXNvbHZlZCA9IHJlcXVpcmUucmVzb2x2ZShyZXFQYXRoKTtcbiAgICBpZiAocHJvY2Vzcy5lbnYuQVBQSVVNX1JFTE9BRF9FWFRFTlNJT05TICYmIHJlcXVpcmUuY2FjaGVbcmVxUmVzb2x2ZWRdKSB7XG4gICAgICBsb2cuZGVidWcoYFJlbW92aW5nICR7cmVxUmVzb2x2ZWR9IGZyb20gcmVxdWlyZSBjYWNoZWApO1xuICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVxUmVzb2x2ZWRdO1xuICAgIH1cbiAgICByZXR1cm4gcmVxdWlyZShyZXFQYXRoKVttYWluQ2xhc3NdO1xuICB9XG5cbiAgaXNJbnN0YWxsZWQgKGV4dE5hbWUpIHtcbiAgICByZXR1cm4gXy5pbmNsdWRlcyhPYmplY3Qua2V5cyh0aGlzLmluc3RhbGxlZEV4dGVuc2lvbnMpLCBleHROYW1lKTtcbiAgfVxufVxuXG5leHBvcnQge1xuICBJTlNUQUxMX1RZUEVfTlBNLCBJTlNUQUxMX1RZUEVfR0lULCBJTlNUQUxMX1RZUEVfTE9DQUwsIElOU1RBTExfVFlQRV9HSVRIVUIsXG4gIElOU1RBTExfVFlQRVMsIERFRkFVTFRfQVBQSVVNX0hPTUUsIERSSVZFUl9UWVBFLCBQTFVHSU5fVFlQRSxcbn07XG4iXSwiZmlsZSI6ImxpYi9leHRlbnNpb24tY29uZmlnLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
