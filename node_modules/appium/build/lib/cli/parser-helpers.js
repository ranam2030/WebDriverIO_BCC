"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseDriverNames = parseDriverNames;
exports.parseInstallTypes = parseInstallTypes;
exports.parseJsonStringOrFile = parseJsonStringOrFile;
exports.parsePluginNames = parsePluginNames;
exports.parseSecurityFeatures = parseSecurityFeatures;

require("source-map-support/register");

var _fs = _interopRequireDefault(require("fs"));

var _lodash = _interopRequireDefault(require("lodash"));

var _extensionConfig = require("../extension-config");

function parseSecurityFeatures(features) {
  const splitter = (splitOn, str) => `${str}`.split(splitOn).map(s => s.trim()).filter(Boolean);

  let parsedFeatures;

  try {
    parsedFeatures = splitter(',', features);
  } catch (err) {
    throw new TypeError('Could not parse value of --allow/deny-insecure. Should be ' + 'a list of strings separated by commas, or a path to a file ' + 'listing one feature name per line.');
  }

  if (parsedFeatures.length === 1 && _fs.default.existsSync(parsedFeatures[0])) {
    try {
      const fileFeatures = _fs.default.readFileSync(parsedFeatures[0], 'utf8');

      parsedFeatures = splitter('\n', fileFeatures);
    } catch (err) {
      throw new TypeError(`Attempted to read --allow/deny-insecure feature names ` + `from file ${parsedFeatures[0]} but got error: ${err.message}`);
    }
  }

  return parsedFeatures;
}

function parseDriverNames(names) {
  if (!_lodash.default.isString(names)) {
    throw new TypeError('To parse driver names, names must be a CSV string');
  }

  try {
    return names.split(',').map(s => s.trim()).filter(Boolean);
  } catch (err) {
    throw new TypeError('Could not parse value of --drivers. Should be a list of driver names ' + 'separated by commas. Driver names are those found when running `appium ' + 'driver list`');
  }
}

function parsePluginNames(names) {
  if (!_lodash.default.isString(names)) {
    throw new TypeError('To parse plugin names, names must be a CSV string');
  }

  try {
    return names.split(',').map(s => s.trim()).filter(Boolean);
  } catch (err) {
    throw new TypeError('Could not parse value of --plugins. Should be a list of plugin names ' + 'separated by commas. Plugin names are those found when running `appium ' + 'plugin list`');
  }
}

function parseJsonStringOrFile(capsOrPath) {
  let caps = capsOrPath;
  let loadedFromFile = false;

  try {
    if (_lodash.default.isString(capsOrPath) && _fs.default.statSync(capsOrPath).isFile()) {
      caps = _fs.default.readFileSync(capsOrPath, 'utf8');
      loadedFromFile = true;
    }
  } catch (err) {}

  try {
    const result = JSON.parse(caps);

    if (!_lodash.default.isPlainObject(result)) {
      throw new Error(`'${_lodash.default.truncate(result, {
        length: 100
      })}' is not an object`);
    }

    return result;
  } catch (e) {
    const msg = loadedFromFile ? `The provided value of '${capsOrPath}' must be a valid JSON` : `The provided value must be a valid JSON`;
    throw new TypeError(`${msg}. Original error: ${e.message}`);
  }
}

function parseInstallTypes(source) {
  if (!_lodash.default.includes(_extensionConfig.INSTALL_TYPES, source)) {
    throw `Argument to --source was '${source}', which is not a valid ` + `driver source type. It must be one of ${JSON.stringify(_extensionConfig.INSTALL_TYPES)}`;
  }

  return source;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jbGkvcGFyc2VyLWhlbHBlcnMuanMiXSwibmFtZXMiOlsicGFyc2VTZWN1cml0eUZlYXR1cmVzIiwiZmVhdHVyZXMiLCJzcGxpdHRlciIsInNwbGl0T24iLCJzdHIiLCJzcGxpdCIsIm1hcCIsInMiLCJ0cmltIiwiZmlsdGVyIiwiQm9vbGVhbiIsInBhcnNlZEZlYXR1cmVzIiwiZXJyIiwiVHlwZUVycm9yIiwibGVuZ3RoIiwiZnMiLCJleGlzdHNTeW5jIiwiZmlsZUZlYXR1cmVzIiwicmVhZEZpbGVTeW5jIiwibWVzc2FnZSIsInBhcnNlRHJpdmVyTmFtZXMiLCJuYW1lcyIsIl8iLCJpc1N0cmluZyIsInBhcnNlUGx1Z2luTmFtZXMiLCJwYXJzZUpzb25TdHJpbmdPckZpbGUiLCJjYXBzT3JQYXRoIiwiY2FwcyIsImxvYWRlZEZyb21GaWxlIiwic3RhdFN5bmMiLCJpc0ZpbGUiLCJyZXN1bHQiLCJKU09OIiwicGFyc2UiLCJpc1BsYWluT2JqZWN0IiwiRXJyb3IiLCJ0cnVuY2F0ZSIsImUiLCJtc2ciLCJwYXJzZUluc3RhbGxUeXBlcyIsInNvdXJjZSIsImluY2x1ZGVzIiwiSU5TVEFMTF9UWVBFUyIsInN0cmluZ2lmeSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBR0EsU0FBU0EscUJBQVQsQ0FBZ0NDLFFBQWhDLEVBQTBDO0FBQ3hDLFFBQU1DLFFBQVEsR0FBRyxDQUFDQyxPQUFELEVBQVVDLEdBQVYsS0FBbUIsR0FBRUEsR0FBSSxFQUFQLENBQVNDLEtBQVQsQ0FBZUYsT0FBZixFQUNoQ0csR0FEZ0MsQ0FDM0JDLENBQUQsSUFBT0EsQ0FBQyxDQUFDQyxJQUFGLEVBRHFCLEVBRWhDQyxNQUZnQyxDQUV6QkMsT0FGeUIsQ0FBbkM7O0FBR0EsTUFBSUMsY0FBSjs7QUFDQSxNQUFJO0FBQ0ZBLElBQUFBLGNBQWMsR0FBR1QsUUFBUSxDQUFDLEdBQUQsRUFBTUQsUUFBTixDQUF6QjtBQUNELEdBRkQsQ0FF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QU9NLENBQVAsRUFBVTtBQUNWLFVBQU1DLEdBQUcsR0FBR1YsY0FBYyxHQUNyQiwwQkFBeUJGLFVBQVcsd0JBRGYsR0FFckIseUNBRkw7QUFHQSxVQUFNLElBQUliLFNBQUosQ0FBZSxHQUFFeUIsR0FBSSxxQkFBb0JELENBQUMsQ0FBQ2xCLE9BQVEsRUFBbkQsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsU0FBU29CLGlCQUFULENBQTRCQyxNQUE1QixFQUFvQztBQUNsQyxNQUFJLENBQUNsQixnQkFBRW1CLFFBQUYsQ0FBV0MsOEJBQVgsRUFBMEJGLE1BQTFCLENBQUwsRUFBd0M7QUFDdEMsVUFBTyw2QkFBNEJBLE1BQU8sMEJBQXBDLEdBQ0MseUNBQXdDUixJQUFJLENBQUNXLFNBQUwsQ0FBZUQsOEJBQWYsQ0FBOEIsRUFEN0U7QUFFRDs7QUFFRCxTQUFPRixNQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IElOU1RBTExfVFlQRVMgfSBmcm9tICcuLi9leHRlbnNpb24tY29uZmlnJztcblxuLy8gc2VydmVyQXJncyB3aWxsIGJlIGFkZGVkIHRvIHRoZSBgc2VydmVyYCAoZGVmYXVsdCkgc3ViY29tbWFuZFxuZnVuY3Rpb24gcGFyc2VTZWN1cml0eUZlYXR1cmVzIChmZWF0dXJlcykge1xuICBjb25zdCBzcGxpdHRlciA9IChzcGxpdE9uLCBzdHIpID0+IGAke3N0cn1gLnNwbGl0KHNwbGl0T24pXG4gICAgLm1hcCgocykgPT4gcy50cmltKCkpXG4gICAgLmZpbHRlcihCb29sZWFuKTtcbiAgbGV0IHBhcnNlZEZlYXR1cmVzO1xuICB0cnkge1xuICAgIHBhcnNlZEZlYXR1cmVzID0gc3BsaXR0ZXIoJywnLCBmZWF0dXJlcyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0NvdWxkIG5vdCBwYXJzZSB2YWx1ZSBvZiAtLWFsbG93L2RlbnktaW5zZWN1cmUuIFNob3VsZCBiZSAnICtcbiAgICAgICdhIGxpc3Qgb2Ygc3RyaW5ncyBzZXBhcmF0ZWQgYnkgY29tbWFzLCBvciBhIHBhdGggdG8gYSBmaWxlICcgK1xuICAgICAgJ2xpc3Rpbmcgb25lIGZlYXR1cmUgbmFtZSBwZXIgbGluZS4nKTtcbiAgfVxuXG4gIGlmIChwYXJzZWRGZWF0dXJlcy5sZW5ndGggPT09IDEgJiYgZnMuZXhpc3RzU3luYyhwYXJzZWRGZWF0dXJlc1swXSkpIHtcbiAgICAvLyB3ZSBtaWdodCBoYXZlIGEgZmlsZSB3aGljaCBpcyBhIGxpc3Qgb2YgZmVhdHVyZXNcbiAgICB0cnkge1xuICAgICAgY29uc3QgZmlsZUZlYXR1cmVzID0gZnMucmVhZEZpbGVTeW5jKHBhcnNlZEZlYXR1cmVzWzBdLCAndXRmOCcpO1xuICAgICAgcGFyc2VkRmVhdHVyZXMgPSBzcGxpdHRlcignXFxuJywgZmlsZUZlYXR1cmVzKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYEF0dGVtcHRlZCB0byByZWFkIC0tYWxsb3cvZGVueS1pbnNlY3VyZSBmZWF0dXJlIG5hbWVzIGAgK1xuICAgICAgICBgZnJvbSBmaWxlICR7cGFyc2VkRmVhdHVyZXNbMF19IGJ1dCBnb3QgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHBhcnNlZEZlYXR1cmVzO1xufVxuXG5mdW5jdGlvbiBwYXJzZURyaXZlck5hbWVzIChuYW1lcykge1xuICBpZiAoIV8uaXNTdHJpbmcobmFtZXMpKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVG8gcGFyc2UgZHJpdmVyIG5hbWVzLCBuYW1lcyBtdXN0IGJlIGEgQ1NWIHN0cmluZycpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICByZXR1cm4gbmFtZXMuc3BsaXQoJywnKS5tYXAoKHMpID0+IHMudHJpbSgpKS5maWx0ZXIoQm9vbGVhbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0NvdWxkIG5vdCBwYXJzZSB2YWx1ZSBvZiAtLWRyaXZlcnMuIFNob3VsZCBiZSBhIGxpc3Qgb2YgZHJpdmVyIG5hbWVzICcgK1xuICAgICAgICAgICAgICAgICAgICAnc2VwYXJhdGVkIGJ5IGNvbW1hcy4gRHJpdmVyIG5hbWVzIGFyZSB0aG9zZSBmb3VuZCB3aGVuIHJ1bm5pbmcgYGFwcGl1bSAnICtcbiAgICAgICAgICAgICAgICAgICAgJ2RyaXZlciBsaXN0YCcpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlUGx1Z2luTmFtZXMgKG5hbWVzKSB7XG4gIGlmICghXy5pc1N0cmluZyhuYW1lcykpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUbyBwYXJzZSBwbHVnaW4gbmFtZXMsIG5hbWVzIG11c3QgYmUgYSBDU1Ygc3RyaW5nJyk7XG4gIH1cblxuICB0cnkge1xuICAgIHJldHVybiBuYW1lcy5zcGxpdCgnLCcpLm1hcCgocykgPT4gcy50cmltKCkpLmZpbHRlcihCb29sZWFuKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ291bGQgbm90IHBhcnNlIHZhbHVlIG9mIC0tcGx1Z2lucy4gU2hvdWxkIGJlIGEgbGlzdCBvZiBwbHVnaW4gbmFtZXMgJyArXG4gICAgICAgICAgICAgICAgICAgICdzZXBhcmF0ZWQgYnkgY29tbWFzLiBQbHVnaW4gbmFtZXMgYXJlIHRob3NlIGZvdW5kIHdoZW4gcnVubmluZyBgYXBwaXVtICcgK1xuICAgICAgICAgICAgICAgICAgICAncGx1Z2luIGxpc3RgJyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VKc29uU3RyaW5nT3JGaWxlIChjYXBzT3JQYXRoKSB7XG4gIGxldCBjYXBzID0gY2Fwc09yUGF0aDtcbiAgbGV0IGxvYWRlZEZyb21GaWxlID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgLy8gdXNlIHN5bmNocm9ub3VzIGZpbGUgYWNjZXNzLCBhcyBgYXJncGFyc2VgIHByb3ZpZGVzIG5vIHdheSBvZiBlaXRoZXJcbiAgICAvLyBhd2FpdGluZyBvciB1c2luZyBjYWxsYmFja3MuIFRoaXMgc3RlcCBoYXBwZW5zIGluIHN0YXJ0dXAsIGluIHdoYXQgaXNcbiAgICAvLyBlZmZlY3RpdmVseSBjb21tYW5kLWxpbmUgY29kZSwgc28gbm90aGluZyBpcyBibG9ja2VkIGluIHRlcm1zIG9mXG4gICAgLy8gc2Vzc2lvbnMsIHNvIGhvbGRpbmcgdXAgdGhlIGV2ZW50IGxvb3AgZG9lcyBub3QgaW5jdXIgdGhlIHVzdWFsXG4gICAgLy8gZHJhd2JhY2tzLlxuICAgIGlmIChfLmlzU3RyaW5nKGNhcHNPclBhdGgpICYmIGZzLnN0YXRTeW5jKGNhcHNPclBhdGgpLmlzRmlsZSgpKSB7XG4gICAgICBjYXBzID0gZnMucmVhZEZpbGVTeW5jKGNhcHNPclBhdGgsICd1dGY4Jyk7XG4gICAgICBsb2FkZWRGcm9tRmlsZSA9IHRydWU7XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBub3QgYSBmaWxlLCBvciBub3QgcmVhZGFibGVcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHJlc3VsdCA9IEpTT04ucGFyc2UoY2Fwcyk7XG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QocmVzdWx0KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtfLnRydW5jYXRlKHJlc3VsdCwge2xlbmd0aDogMTAwfSl9JyBpcyBub3QgYW4gb2JqZWN0YCk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zdCBtc2cgPSBsb2FkZWRGcm9tRmlsZVxuICAgICAgPyBgVGhlIHByb3ZpZGVkIHZhbHVlIG9mICcke2NhcHNPclBhdGh9JyBtdXN0IGJlIGEgdmFsaWQgSlNPTmBcbiAgICAgIDogYFRoZSBwcm92aWRlZCB2YWx1ZSBtdXN0IGJlIGEgdmFsaWQgSlNPTmA7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgJHttc2d9LiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VJbnN0YWxsVHlwZXMgKHNvdXJjZSkge1xuICBpZiAoIV8uaW5jbHVkZXMoSU5TVEFMTF9UWVBFUywgc291cmNlKSkge1xuICAgIHRocm93IGBBcmd1bWVudCB0byAtLXNvdXJjZSB3YXMgJyR7c291cmNlfScsIHdoaWNoIGlzIG5vdCBhIHZhbGlkIGAgK1xuICAgICAgICAgIGBkcml2ZXIgc291cmNlIHR5cGUuIEl0IG11c3QgYmUgb25lIG9mICR7SlNPTi5zdHJpbmdpZnkoSU5TVEFMTF9UWVBFUyl9YDtcbiAgfVxuXG4gIHJldHVybiBzb3VyY2U7XG59XG5cbmV4cG9ydCB7XG4gIHBhcnNlU2VjdXJpdHlGZWF0dXJlcyxcbiAgcGFyc2VKc29uU3RyaW5nT3JGaWxlLFxuICBwYXJzZUluc3RhbGxUeXBlcyxcbiAgcGFyc2VQbHVnaW5OYW1lcyxcbiAgcGFyc2VEcml2ZXJOYW1lcyxcbn07XG4iXSwiZmlsZSI6ImxpYi9jbGkvcGFyc2VyLWhlbHBlcnMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
