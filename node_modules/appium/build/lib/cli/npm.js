"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _semver = _interopRequireDefault(require("semver"));

var _teen_process = require("teen_process");

var _support = require("@appium/support");

const INSTALL_LOCKFILE = '.appium.install.lock';
const LINK_LOCKFILE = '.appium.link.lock';

class NPM {
  constructor(appiumHome) {
    this.appiumHome = appiumHome;
  }

  async exec(cmd, args, opts, execOpts = {}) {
    let {
      cwd,
      json,
      lockFile
    } = opts;

    if (!cwd) {
      cwd = this.appiumHome;
    }

    await (0, _support.mkdirp)(cwd);

    const dummyPkgJson = _path.default.resolve(cwd, 'package.json');

    if (!(await _support.fs.exists(dummyPkgJson))) {
      await _support.fs.writeFile(dummyPkgJson, '{}');
    }

    execOpts = { ...execOpts,
      cwd
    };
    args.unshift(cmd);

    if (json) {
      args.push('-json');
    }

    const npmCmd = _support.system.isWindows() ? 'npm.cmd' : 'npm';

    let runner = async () => await (0, _teen_process.exec)(npmCmd, args, execOpts);

    if (lockFile) {
      const acquireLock = _support.util.getLockFileGuard(_path.default.resolve(cwd, lockFile));

      const _runner = runner;

      runner = async () => await acquireLock(_runner);
    }

    const {
      stdout,
      stderr,
      code
    } = await runner();
    const ret = {
      stdout,
      stderr,
      code,
      json: null
    };

    if (json) {
      try {
        ret.json = JSON.parse(stdout);
      } catch (ign) {}
    }

    return ret;
  }

  async getLatestVersion(pkg) {
    return (await this.exec('view', [pkg, 'dist-tags'], {
      json: true
    })).json.latest;
  }

  async getLatestSafeUpgradeVersion(pkg, curVersion) {
    const allVersions = (await this.exec('view', [pkg, 'versions'], {
      json: true
    })).json;
    return this.getLatestSafeUpgradeFromVersions(curVersion, allVersions);
  }

  getLatestSafeUpgradeFromVersions(curVersion, allVersions) {
    let safeUpgradeVer = null;

    const curSemver = _semver.default.parse(curVersion);

    if (curSemver === null) {
      throw new Error(`Could not parse current version '${curVersion}'`);
    }

    for (const testVer of allVersions) {
      const testSemver = _semver.default.parse(testVer);

      if (testSemver === null) {
        throw new Error(`Could not parse version to test against: '${testVer}'`);
      }

      if (testSemver.prerelease.length > 0) {
        continue;
      }

      if (curSemver.compare(testSemver) === 1) {
        continue;
      }

      if (testSemver.major > curSemver.major) {
        continue;
      }

      if (safeUpgradeVer === null || testSemver.compare(safeUpgradeVer) === 1) {
        safeUpgradeVer = testSemver;
      }
    }

    if (safeUpgradeVer) {
      safeUpgradeVer = safeUpgradeVer.format();
    }

    return safeUpgradeVer;
  }

  async installPackage({
    pkgDir,
    pkgName,
    pkgVer
  }) {
    const res = await this.exec('install', ['--no-save', '--no-package-lock', pkgVer ? `${pkgName}@${pkgVer}` : pkgName], {
      cwd: pkgDir,
      json: true,
      lockFile: INSTALL_LOCKFILE
    });

    if (res.json) {
      if (res.json.error) {
        throw new Error(res.json.error);
      }
    }

    const pkgJson = _path.default.resolve(pkgDir, 'node_modules', pkgName, 'package.json');

    try {
      return require(pkgJson);
    } catch {
      throw new Error('The package was not downloaded correctly; its package.json ' + 'did not exist or was unreadable. We looked for it at ' + pkgJson);
    }
  }

  async linkPackage(pkgPath) {
    let pkgName;

    try {
      pkgName = require(_path.default.resolve(pkgPath, 'package.json')).name;
    } catch {
      throw new Error('Could not find package.json inside the package path ' + `provided: ${pkgPath}`);
    }

    pkgPath = _path.default.resolve(process.cwd(), pkgPath);

    const pkgHome = _path.default.resolve(this.appiumHome, pkgName);

    const res = await this.exec('link', ['--no-package-lock', pkgPath], {
      cwd: pkgHome,
      lockFile: LINK_LOCKFILE
    });

    if (res.json && res.json.error) {
      throw new Error(res.json.error);
    }

    try {
      return require(_path.default.resolve(pkgHome, 'node_modules', pkgName, 'package.json'));
    } catch {
      throw new Error('The package was not linked correctly; its package.json ' + 'did not exist or was unreadable');
    }
  }

  async uninstallPackage(pkgDir, pkg) {
    await this.exec('uninstall', [pkg], {
      cwd: pkgDir,
      lockFile: INSTALL_LOCKFILE
    });
  }

}

exports.default = NPM;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jbGkvbnBtLmpzIl0sIm5hbWVzIjpbIklOU1RBTExfTE9DS0ZJTEUiLCJMSU5LX0xPQ0tGSUxFIiwiTlBNIiwiY29uc3RydWN0b3IiLCJhcHBpdW1Ib21lIiwiZXhlYyIsImNtZCIsImFyZ3MiLCJvcHRzIiwiZXhlY09wdHMiLCJjd2QiLCJqc29uIiwibG9ja0ZpbGUiLCJkdW1teVBrZ0pzb24iLCJwYXRoIiwicmVzb2x2ZSIsImZzIiwiZXhpc3RzIiwid3JpdGVGaWxlIiwidW5zaGlmdCIsInB1c2giLCJucG1DbWQiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJydW5uZXIiLCJhY3F1aXJlTG9jayIsInV0aWwiLCJnZXRMb2NrRmlsZUd1YXJkIiwiX3J1bm5lciIsInN0ZG91dCIsInN0ZGVyciIsImNvZGUiLCJyZXQiLCJKU09OIiwicGFyc2UiLCJpZ24iLCJnZXRMYXRlc3RWZXJzaW9uIiwicGtnIiwibGF0ZXN0IiwiZ2V0TGF0ZXN0U2FmZVVwZ3JhZGVWZXJzaW9uIiwiY3VyVmVyc2lvbiIsImFsbFZlcnNpb25zIiwiZ2V0TGF0ZXN0U2FmZVVwZ3JhZGVGcm9tVmVyc2lvbnMiLCJzYWZlVXBncmFkZVZlciIsImN1clNlbXZlciIsInNlbXZlciIsIkVycm9yIiwidGVzdFZlciIsInRlc3RTZW12ZXIiLCJwcmVyZWxlYXNlIiwibGVuZ3RoIiwiY29tcGFyZSIsIm1ham9yIiwiZm9ybWF0IiwiaW5zdGFsbFBhY2thZ2UiLCJwa2dEaXIiLCJwa2dOYW1lIiwicGtnVmVyIiwicmVzIiwiZXJyb3IiLCJwa2dKc29uIiwicmVxdWlyZSIsImxpbmtQYWNrYWdlIiwicGtnUGF0aCIsIm5hbWUiLCJwcm9jZXNzIiwicGtnSG9tZSIsInVuaW5zdGFsbFBhY2thZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUcsc0JBQXpCO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLG1CQUF0Qjs7QUFF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QUFPLEdBQUdqRCxjQUFLQyxPQUFMLENBQWFrRCxPQUFPLENBQUN2RCxHQUFSLEVBQWIsRUFBNEJxRCxPQUE1QixDQUFWOztBQUVBLFVBQU1HLE9BQU8sR0FBR3BELGNBQUtDLE9BQUwsQ0FBYSxLQUFLWCxVQUFsQixFQUE4Qm9ELE9BQTlCLENBQWhCOztBQUdBLFVBQU1FLEdBQUcsR0FBRyxNQUFNLEtBQUtyRCxJQUFMLENBQVUsTUFBVixFQUFrQixDQUFDLG1CQUFELEVBQXNCMEQsT0FBdEIsQ0FBbEIsRUFBa0Q7QUFBQ3JELE1BQUFBLEdBQUcsRUFBRXdELE9BQU47QUFBZXRELE1BQUFBLFFBQVEsRUFBRVg7QUFBekIsS0FBbEQsQ0FBbEI7O0FBQ0EsUUFBSXlELEdBQUcsQ0FBQy9DLElBQUosSUFBWStDLEdBQUcsQ0FBQy9DLElBQUosQ0FBU2dELEtBQXpCLEVBQWdDO0FBQzlCLFlBQU0sSUFBSWIsS0FBSixDQUFVWSxHQUFHLENBQUMvQyxJQUFKLENBQVNnRCxLQUFuQixDQUFOO0FBQ0Q7O0FBR0QsUUFBSTtBQUNGLGFBQU9FLE9BQU8sQ0FBQy9DLGNBQUtDLE9BQUwsQ0FBYW1ELE9BQWIsRUFBc0IsY0FBdEIsRUFBc0NWLE9BQXRDLEVBQStDLGNBQS9DLENBQUQsQ0FBZDtBQUNELEtBRkQsQ0FFRSxNQUFNO0FBQ04sWUFBTSxJQUFJVixLQUFKLENBQVUsNERBQ0EsaUNBRFYsQ0FBTjtBQUVEO0FBQ0Y7O0FBRXFCLFFBQWhCcUIsZ0JBQWdCLENBQUVaLE1BQUYsRUFBVWxCLEdBQVYsRUFBZTtBQUNuQyxVQUFNLEtBQUtoQyxJQUFMLENBQVUsV0FBVixFQUF1QixDQUFDZ0MsR0FBRCxDQUF2QixFQUE4QjtBQUNsQzNCLE1BQUFBLEdBQUcsRUFBRTZDLE1BRDZCO0FBRWxDM0MsTUFBQUEsUUFBUSxFQUFFWjtBQUZ3QixLQUE5QixDQUFOO0FBSUQ7O0FBbkxzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcywgbWtkaXJwLCB1dGlsLCBzeXN0ZW0gfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuXG5jb25zdCBJTlNUQUxMX0xPQ0tGSUxFID0gJy5hcHBpdW0uaW5zdGFsbC5sb2NrJztcbmNvbnN0IExJTktfTE9DS0ZJTEUgPSAnLmFwcGl1bS5saW5rLmxvY2snO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBOUE0ge1xuXG4gIGNvbnN0cnVjdG9yIChhcHBpdW1Ib21lKSB7XG4gICAgdGhpcy5hcHBpdW1Ib21lID0gYXBwaXVtSG9tZTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWMgKGNtZCwgYXJncywgb3B0cywgZXhlY09wdHMgPSB7fSkge1xuICAgIGxldCB7IGN3ZCwganNvbiwgbG9ja0ZpbGUgfSA9IG9wdHM7XG4gICAgaWYgKCFjd2QpIHtcbiAgICAgIGN3ZCA9IHRoaXMuYXBwaXVtSG9tZTtcbiAgICB9XG4gICAgLy8gZW5zdXJlIHRoZSBkaXJlY3Rvcnkgd2Ugd2FudCB0byBpbnN0YWxsIGluc2lkZSBvZiBleGlzdHNcbiAgICBhd2FpdCBta2RpcnAoY3dkKTtcblxuICAgIC8vIG5vdCBvbmx5IHRoaXMsIHRoaXMgZGlyZWN0b3J5IG5lZWRzIGEgJ3BhY2thZ2UuanNvbicgaW5zaWRlIG9mIGl0LCBvdGhlcndpc2UsIGlmIGFueVxuICAgIC8vIGRpcmVjdG9yeSBpbiB0aGUgZmlsZXN5c3RlbSB0cmVlIEFCT1ZFIGN3ZCBoYXBwZW5zIHRvIGhhdmUgYSBwYWNrYWdlLmpzb24gb3IgYSBub2RlX21vZHVsZXNcbiAgICAvLyBkaXIgaW4gaXQsIE5QTSB3aWxsIGluc3RhbGwgdGhlIG1vZHVsZSB1cCB0aGVyZSBpbnN0ZWFkIChzaWxseSBOUE0pXG4gICAgY29uc3QgZHVtbXlQa2dKc29uID0gcGF0aC5yZXNvbHZlKGN3ZCwgJ3BhY2thZ2UuanNvbicpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGR1bW15UGtnSnNvbikpIHtcbiAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShkdW1teVBrZ0pzb24sICd7fScpO1xuICAgIH1cblxuICAgIC8vIG1ha2Ugc3VyZSB3ZSBwZXJmb3JtIHRoZSBjdXJyZW50IG9wZXJhdGlvbiBpbiBjd2RcbiAgICBleGVjT3B0cyA9IHsuLi5leGVjT3B0cywgY3dkfTtcblxuICAgIGFyZ3MudW5zaGlmdChjbWQpO1xuICAgIGlmIChqc29uKSB7XG4gICAgICBhcmdzLnB1c2goJy1qc29uJyk7XG4gICAgfVxuICAgIGNvbnN0IG5wbUNtZCA9IHN5c3RlbS5pc1dpbmRvd3MoKSA/ICducG0uY21kJyA6ICducG0nO1xuICAgIGxldCBydW5uZXIgPSBhc3luYyAoKSA9PiBhd2FpdCBleGVjKG5wbUNtZCwgYXJncywgZXhlY09wdHMpO1xuICAgIGlmIChsb2NrRmlsZSkge1xuICAgICAgY29uc3QgYWNxdWlyZUxvY2sgPSB1dGlsLmdldExvY2tGaWxlR3VhcmQocGF0aC5yZXNvbHZlKGN3ZCwgbG9ja0ZpbGUpKTtcbiAgICAgIGNvbnN0IF9ydW5uZXIgPSBydW5uZXI7XG4gICAgICBydW5uZXIgPSBhc3luYyAoKSA9PiBhd2FpdCBhY3F1aXJlTG9jayhfcnVubmVyKTtcbiAgICB9XG4gICAgY29uc3Qge3N0ZG91dCwgc3RkZXJyLCBjb2RlfSA9IGF3YWl0IHJ1bm5lcigpO1xuICAgIGNvbnN0IHJldCA9IHtzdGRvdXQsIHN0ZGVyciwgY29kZSwganNvbjogbnVsbH07XG5cbiAgICBpZiAoanNvbikge1xuICAgICAgLy8gaWYgcG9zc2libGUsIHBhcnNlIE5QTSdzIGpzb24gb3V0cHV0LiBEdXJpbmcgTlBNIGluc3RhbGwgM3JkLXBhcnR5XG4gICAgICAvLyBwYWNrYWdlcyBjYW4gd3JpdGUgdG8gc3Rkb3V0LCBzbyBzb21ldGltZXMgdGhlIGpzb24gb3V0cHV0IGNhbid0IGJlXG4gICAgICAvLyBndWFyYW50ZWVkIHRvIGJlIHBhcnNlYWJsZVxuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0Lmpzb24gPSBKU09OLnBhcnNlKHN0ZG91dCk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG4gIGFzeW5jIGdldExhdGVzdFZlcnNpb24gKHBrZykge1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5leGVjKCd2aWV3JywgW3BrZywgJ2Rpc3QtdGFncyddLCB7XG4gICAgICBqc29uOiB0cnVlXG4gICAgfSkpLmpzb24ubGF0ZXN0O1xuICB9XG5cbiAgYXN5bmMgZ2V0TGF0ZXN0U2FmZVVwZ3JhZGVWZXJzaW9uIChwa2csIGN1clZlcnNpb24pIHtcbiAgICBjb25zdCBhbGxWZXJzaW9ucyA9IChhd2FpdCB0aGlzLmV4ZWMoJ3ZpZXcnLCBbcGtnLCAndmVyc2lvbnMnXSwge1xuICAgICAganNvbjogdHJ1ZVxuICAgIH0pKS5qc29uO1xuICAgIHJldHVybiB0aGlzLmdldExhdGVzdFNhZmVVcGdyYWRlRnJvbVZlcnNpb25zKGN1clZlcnNpb24sIGFsbFZlcnNpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHaXZlbiBhIGN1cnJlbnQgdmVyc2lvbiBhbmQgYSBsaXN0IG9mIGFsbCB2ZXJzaW9ucyBmb3IgYSBwYWNrYWdlLCByZXR1cm4gdGhlIHZlcnNpb24gd2hpY2ggaXNcbiAgICogdGhlIGhpZ2hlc3Qgc2FmZWx5LXVwZ3JhZGFibGUgdmVyc2lvbiAobWVhbmluZyBub3QgY3Jvc3NpbmcgYW55IG1ham9yIHJldmlzaW9uIGJvdW5kYXJpZXMsIGFuZFxuICAgKiBub3QgaW5jbHVkaW5nIGFueSBhbHBoYS9iZXRhL3JjIHZlcnNpb25zKVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY3VyVmVyc2lvbiAtIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgYSBwYWNrYWdlXG4gICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gYWxsVmVyc2lvbnMgLSBhIGxpc3Qgb2YgdmVyc2lvbiBzdHJpbmdzXG4gICAqXG4gICAqIEByZXR1cm4ge3N0cmluZ3xudWxsfSAtIHRoZSBoaWdoZXN0IHNhZmVseS11cGdyYWRhYmxlIHZlcnNpb24sIG9yIG51bGwgaWYgdGhlcmUgaXNuJ3Qgb25lXG4gICAqL1xuICBnZXRMYXRlc3RTYWZlVXBncmFkZUZyb21WZXJzaW9ucyAoY3VyVmVyc2lvbiwgYWxsVmVyc2lvbnMpIHtcbiAgICBsZXQgc2FmZVVwZ3JhZGVWZXIgPSBudWxsO1xuICAgIGNvbnN0IGN1clNlbXZlciA9IHNlbXZlci5wYXJzZShjdXJWZXJzaW9uKTtcbiAgICBpZiAoY3VyU2VtdmVyID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBwYXJzZSBjdXJyZW50IHZlcnNpb24gJyR7Y3VyVmVyc2lvbn0nYCk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgdGVzdFZlciBvZiBhbGxWZXJzaW9ucykge1xuICAgICAgY29uc3QgdGVzdFNlbXZlciA9IHNlbXZlci5wYXJzZSh0ZXN0VmVyKTtcbiAgICAgIGlmICh0ZXN0U2VtdmVyID09PSBudWxsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHBhcnNlIHZlcnNpb24gdG8gdGVzdCBhZ2FpbnN0OiAnJHt0ZXN0VmVyfSdgKTtcbiAgICAgIH1cbiAgICAgIC8vIGlmIHRoZSB0ZXN0IHZlcnNpb24gaXMgYSBwcmVyZWxlYXNlLCBpZ25vcmUgaXRcbiAgICAgIGlmICh0ZXN0U2VtdmVyLnByZXJlbGVhc2UubGVuZ3RoID4gMCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIC8vIGlmIHRoZSBjdXJyZW50IHZlcnNpb24gaXMgbGF0ZXIgdGhhbiB0aGUgdGVzdCB2ZXJzaW9uLCBza2lwIHRoaXMgdGVzdCB2ZXJzaW9uXG4gICAgICBpZiAoY3VyU2VtdmVyLmNvbXBhcmUodGVzdFNlbXZlcikgPT09IDEpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyBpZiB0aGUgdGVzdCB2ZXJzaW9uIGlzIG5ld2VyLCBidXQgY3Jvc3NlcyBhIG1ham9yIHJldmlzaW9uIGJvdW5kYXJ5LCBhbHNvIHNraXAgaXRcbiAgICAgIGlmICh0ZXN0U2VtdmVyLm1ham9yID4gY3VyU2VtdmVyLm1ham9yKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgLy8gb3RoZXJ3aXNlIHRoaXMgdmVyc2lvbiBpcyBzYWZlIHRvIHVwZ3JhZGUgdG8uIEJ1dCB0aGVyZSBtaWdodCBiZSBtdWx0aXBsZSBvbmVzIG9mIHRoaXNcbiAgICAgIC8vIGtpbmQsIHNvIGtlZXAgaXRlcmF0aW5nIGFuZCBrZWVwaW5nIHRoZSBoaWdoZXN0XG4gICAgICBpZiAoc2FmZVVwZ3JhZGVWZXIgPT09IG51bGwgfHwgdGVzdFNlbXZlci5jb21wYXJlKHNhZmVVcGdyYWRlVmVyKSA9PT0gMSkge1xuICAgICAgICBzYWZlVXBncmFkZVZlciA9IHRlc3RTZW12ZXI7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzYWZlVXBncmFkZVZlcikge1xuICAgICAgc2FmZVVwZ3JhZGVWZXIgPSBzYWZlVXBncmFkZVZlci5mb3JtYXQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHNhZmVVcGdyYWRlVmVyO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFBhY2thZ2UgKHtwa2dEaXIsIHBrZ05hbWUsIHBrZ1Zlcn0pIHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmV4ZWMoJ2luc3RhbGwnLCBbXG4gICAgICAnLS1uby1zYXZlJyxcbiAgICAgICctLW5vLXBhY2thZ2UtbG9jaycsXG4gICAgICBwa2dWZXIgPyBgJHtwa2dOYW1lfUAke3BrZ1Zlcn1gIDogcGtnTmFtZVxuICAgIF0sIHtcbiAgICAgIGN3ZDogcGtnRGlyLFxuICAgICAganNvbjogdHJ1ZSxcbiAgICAgIGxvY2tGaWxlOiBJTlNUQUxMX0xPQ0tGSUxFXG4gICAgfSk7XG5cbiAgICBpZiAocmVzLmpzb24pIHtcbiAgICAgIC8vIHdlIHBhcnNlZCBhIHZhbGlkIGpzb24gcmVzcG9uc2UsIHNvIGlmIHdlIGdvdCBhbiBlcnJvciBoZXJlLCByZXR1cm4gdGhhdFxuICAgICAgLy8gbWVzc2FnZSBzdHJhaWdodGF3YXlcbiAgICAgIGlmIChyZXMuanNvbi5lcnJvcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzLmpzb24uZXJyb3IpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5vdyByZWFkIHBhY2thZ2UgZGF0YSBmcm9tIHRoZSBpbnN0YWxsZWQgcGFja2FnZSB0byByZXR1cm4sIGFuZCBtYWtlIHN1cmVcbiAgICAvLyBldmVyeXRoaW5nIGdvdCBpbnN0YWxsZWQgb2suIFJlbWVtYmVyLCBwa2dOYW1lIG1pZ2h0IGVuZCB1cCB3aXRoIGEgLyBpbiBpdCBkdWUgdG8gYW4gbnBtXG4gICAgLy8gb3JnLCBzbyBpZiBzbywgdGhhdCB3aWxsIGdldCBjb3JyZWN0bHkgZXhwbG9kZWQgaW50byBtdWx0aXBsZSBkaXJlY3RvcmllcywgYnkgcGF0aC5yZXNvbHZlIGhlcmVcbiAgICAvLyAoZXZlbiBvbiBXaW5kb3dzISlcbiAgICBjb25zdCBwa2dKc29uID0gcGF0aC5yZXNvbHZlKHBrZ0RpciwgJ25vZGVfbW9kdWxlcycsIHBrZ05hbWUsICdwYWNrYWdlLmpzb24nKTtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHJlcXVpcmUocGtnSnNvbik7XG4gICAgfSBjYXRjaCB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBwYWNrYWdlIHdhcyBub3QgZG93bmxvYWRlZCBjb3JyZWN0bHk7IGl0cyBwYWNrYWdlLmpzb24gJyArXG4gICAgICAgICAgICAgICAgICAgICAgJ2RpZCBub3QgZXhpc3Qgb3Igd2FzIHVucmVhZGFibGUuIFdlIGxvb2tlZCBmb3IgaXQgYXQgJyArXG4gICAgICAgICAgICAgICAgICAgICAgcGtnSnNvbik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbGlua1BhY2thZ2UgKHBrZ1BhdGgpIHtcbiAgICAvLyBmcm9tIHRoZSBwYXRoIGFsb25lIHdlIGRvbid0IGtub3cgdGhlIG5wbSBwYWNrYWdlIG5hbWUsIHNvIHdlIG5lZWQgdG9cbiAgICAvLyBsb29rIGluIHBhY2thZ2UuanNvblxuICAgIGxldCBwa2dOYW1lO1xuICAgIHRyeSB7XG4gICAgICBwa2dOYW1lID0gcmVxdWlyZShwYXRoLnJlc29sdmUocGtnUGF0aCwgJ3BhY2thZ2UuanNvbicpKS5uYW1lO1xuICAgIH0gY2F0Y2gge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBwYWNrYWdlLmpzb24gaW5zaWRlIHRoZSBwYWNrYWdlIHBhdGggJyArXG4gICAgICAgICAgICAgICAgICAgICAgYHByb3ZpZGVkOiAke3BrZ1BhdGh9YCk7XG4gICAgfVxuXG4gICAgLy8gdGhpcyBpcyBhZGRlZCB0byBoYW5kbGUgY29tbWFuZHMgd2l0aCByZWxhdGl2ZSBwYXRoc1xuICAgIC8vIGllOiBcIm5vZGUgLiBkcml2ZXIgaW5zdGFsbCAtLXNvdXJjZT1sb2NhbCAuLi9mYWtlLWRyaXZlclwiXG4gICAgcGtnUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBwa2dQYXRoKTtcblxuICAgIGNvbnN0IHBrZ0hvbWUgPSBwYXRoLnJlc29sdmUodGhpcy5hcHBpdW1Ib21lLCBwa2dOYW1lKTtcblxuICAgIC8vIGNhbGwgbGluayB3aXRoIC0tbm8tcGFja2FnZS1sb2NrIHRvIGVuc3VyZSBubyBjb3JydXB0aW9uIHdoaWxlIGluc3RhbGxpbmcgbG9jYWwgcGFja2FnZXNcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmV4ZWMoJ2xpbmsnLCBbJy0tbm8tcGFja2FnZS1sb2NrJywgcGtnUGF0aF0sIHtjd2Q6IHBrZ0hvbWUsIGxvY2tGaWxlOiBMSU5LX0xPQ0tGSUxFfSk7XG4gICAgaWYgKHJlcy5qc29uICYmIHJlcy5qc29uLmVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IocmVzLmpzb24uZXJyb3IpO1xuICAgIH1cblxuICAgIC8vIG5vdyBlbnN1cmUgaXQgd2FzIGxpbmtlZCB0byB0aGUgY29ycmVjdCBwbGFjZVxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gcmVxdWlyZShwYXRoLnJlc29sdmUocGtnSG9tZSwgJ25vZGVfbW9kdWxlcycsIHBrZ05hbWUsICdwYWNrYWdlLmpzb24nKSk7XG4gICAgfSBjYXRjaCB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBwYWNrYWdlIHdhcyBub3QgbGlua2VkIGNvcnJlY3RseTsgaXRzIHBhY2thZ2UuanNvbiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnZGlkIG5vdCBleGlzdCBvciB3YXMgdW5yZWFkYWJsZScpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVuaW5zdGFsbFBhY2thZ2UgKHBrZ0RpciwgcGtnKSB7XG4gICAgYXdhaXQgdGhpcy5leGVjKCd1bmluc3RhbGwnLCBbcGtnXSwge1xuICAgICAgY3dkOiBwa2dEaXIsXG4gICAgICBsb2NrRmlsZTogSU5TVEFMTF9MT0NLRklMRVxuICAgIH0pO1xuICB9XG59XG4iXSwiZmlsZSI6ImxpYi9jbGkvbnBtLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
