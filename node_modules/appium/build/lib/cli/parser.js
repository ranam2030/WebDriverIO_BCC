"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.getDefaultServerArgs = getDefaultServerArgs;
exports.getParser = getParser;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _argparse = require("argparse");

var _args = require("./args");

var _extensionConfig = require("../extension-config");

var _utils = require("../utils");

var _support = require("@appium/support");

function makeDebugParser(parser) {
  parser.exit = (status, message = undefined) => {
    throw new Error(message);
  };
}

function getParser(debug = false) {
  const parser = new _argparse.ArgumentParser({
    add_help: true,
    description: 'A webdriver-compatible server for use with native and hybrid iOS and Android applications.',
    prog: process.argv[1] ? _path.default.basename(process.argv[1]) : 'appium'
  });

  if (debug) {
    makeDebugParser(parser);
  }

  parser.add_argument('-v', '--version', {
    action: 'version',
    version: _support.fs.readPackageJsonFrom(_utils.rootDir).version
  });
  const subParsers = parser.add_subparsers({
    dest: 'subcommand'
  });
  const serverArgs = addServerToParser(_args.sharedArgs, subParsers, debug);
  parser.rawArgs = serverArgs;
  addExtensionsToParser(_args.sharedArgs, subParsers, debug);
  parser._parse_args = parser.parse_args.bind(parser);

  parser.parse_args = function (args, namespace) {
    if (_lodash.default.isUndefined(args)) {
      args = [...process.argv.slice(2)];
    }

    if (!_lodash.default.includes([_extensionConfig.DRIVER_TYPE, _extensionConfig.PLUGIN_TYPE, 'server', '-h', '--help', '-v', '--version'], args[0])) {
      args.splice(0, 0, 'server');
    }

    return this._parse_args(args, namespace);
  }.bind(parser);

  return parser;
}

function addServerToParser(sharedArgs, subParsers, debug = false) {
  const serverParser = subParsers.add_parser('server', {
    add_help: true,
    help: 'Run an Appium server'
  });

  if (debug) {
    makeDebugParser(serverParser);
  }

  for (const [flagsOrNames, opts] of [...sharedArgs, ..._args.serverArgs]) {
    serverParser.add_argument(...flagsOrNames, { ...opts
    });
  }

  return _args.serverArgs;
}

function getDefaultServerArgs() {
  let defaults = {};

  for (let [, arg] of _args.serverArgs) {
    defaults[arg.dest] = arg.default;
  }

  return defaults;
}

function addExtensionsToParser(sharedArgs, subParsers, debug = false) {
  for (const type of [_extensionConfig.DRIVER_TYPE, _extensionConfig.PLUGIN_TYPE]) {
    const extParser = subParsers.add_parser(type, {
      add_help: true,
      help: `Access the ${type} management CLI commands`
    });

    if (debug) {
      makeDebugParser(extParser);
    }

    const extSubParsers = extParser.add_subparsers({
      dest: `${type}Command`
    });
    const parserSpecs = [{
      command: 'list',
      args: _args.extensionArgs[type].list,
      help: `List available and installed ${type}s`
    }, {
      command: 'install',
      args: _args.extensionArgs[type].install,
      help: `Install a ${type}`
    }, {
      command: 'uninstall',
      args: _args.extensionArgs[type].uninstall,
      help: `Uninstall a ${type}`
    }, {
      command: 'update',
      args: _args.extensionArgs[type].update,
      help: `Update installed ${type}s to the latest version`
    }, {
      command: 'run',
      args: _args.extensionArgs[type].run,
      help: `Run a script (defined inside the ${type}'s package.json under the ` + `“scripts” field inside the “appium” field) from an installed ${type}`
    }];

    for (const {
      command,
      args,
      help
    } of parserSpecs) {
      const parser = extSubParsers.add_parser(command, {
        help
      });

      if (debug) {
        makeDebugParser(parser);
      }

      for (const [flagsOrNames, opts] of [...sharedArgs, ...args]) {
        parser.add_argument(...flagsOrNames, { ...opts
        });
      }
    }
  }
}

var _default = getParser;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jbGkvcGFyc2VyLmpzIl0sIm5hbWVzIjpbIm1ha2VEZWJ1Z1BhcnNlciIsInBhcnNlciIsImV4aXQiLCJzdGF0dXMiLCJtZXNzYWdlIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJnZXRQYXJzZXIiLCJkZWJ1ZyIsIkFyZ3VtZW50UGFyc2VyIiwiYWRkX2hlbHAiLCJkZXNjcmlwdGlvbiIsInByb2ciLCJwcm9jZXNzIiwiYXJndiIsInBhdGgiLCJiYXNlbmFtZSIsImFkZF9hcmd1bWVudCIsImFjdGlvbiIsInZlcnNpb24iLCJmcyIsInJlYWRQYWNrYWdlSnNvbkZyb20iLCJyb290RGlyIiwic3ViUGFyc2VycyIsImFkZF9zdWJwYXJzZXJzIiwiZGVzdCIsInNlcnZlckFyZ3MiLCJhZGRTZXJ2ZXJUb1BhcnNlciIsInNoYXJlZEFyZ3MiLCJyYXdBcmdzIiwiYWRkRXh0ZW5zaW9uc1RvUGFyc2VyIiwiX3BhcnNlX2FyZ3MiLCJwYXJzZV9hcmdzIiwiYmluZCIsImFyZ3MiLCJuYW1lc3BhY2UiLCJfIiwiaXNVbmRlZmluZWQiLCJzbGljZSIsImluY2x1ZGVzIiwiRFJJVkVSX1RZUEUiLCJQTFVHSU5fVFlQRSIsInNwbGljZSIsInNlcnZlclBhcnNlciIsImFkZF9wYXJzZXIiLCJoZWxwIiwiZmxhZ3NPck5hbWVzIiwib3B0cyIsImdldERlZmF1bHRTZXJ2ZXJBcmdzIiwiZGVmYXVsdHMiLCJhcmciLCJkZWZhdWx0IiwidHlwZSIsImV4dFBhcnNlciIsImV4dFN1YlBhcnNlcnMiLCJwYXJzZXJTcGVjcyIsImNvbW1hbmQiLCJleHRlbnNpb25BcmdzIiwibGlzdCIsImluc3RhbGwiLCJ1bmluc3RhbGwiLCJ1cGRhdGUiLCJydW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxTQUFTQSxlQUFULENBQTBCQyxNQUExQixFQUFrQztBQUNoQ0EsRUFBQUEsTUFBTSxDQUFDQyxJ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LElBQW1DLENBQUMsR0FBR25CLFVBQUosRUFBZ0IsR0FBR00sSUFBbkIsQ0FBbkMsRUFBNkQ7QUFFM0RqQyxRQUFBQSxNQUFNLENBQUNnQixZQUFQLENBQW9CLEdBQUc2QixZQUF2QixFQUFxQyxFQUFDLEdBQUdDO0FBQUosU0FBckM7QUFDRDtBQUNGO0FBQ0Y7QUFDRjs7ZUFFY3hDLFMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBBcmd1bWVudFBhcnNlciB9IGZyb20gJ2FyZ3BhcnNlJztcbmltcG9ydCB7IHNoYXJlZEFyZ3MsIHNlcnZlckFyZ3MsIGV4dGVuc2lvbkFyZ3MgfSBmcm9tICcuL2FyZ3MnO1xuaW1wb3J0IHsgRFJJVkVSX1RZUEUsIFBMVUdJTl9UWVBFIH0gZnJvbSAnLi4vZXh0ZW5zaW9uLWNvbmZpZyc7XG5pbXBvcnQgeyByb290RGlyIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuXG5cbmZ1bmN0aW9uIG1ha2VEZWJ1Z1BhcnNlciAocGFyc2VyKSB7XG4gIHBhcnNlci5leGl0ID0gKHN0YXR1cywgbWVzc2FnZSA9IHVuZGVmaW5lZCkgPT4ge1xuICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0UGFyc2VyIChkZWJ1ZyA9IGZhbHNlKSB7XG4gIGNvbnN0IHBhcnNlciA9IG5ldyBBcmd1bWVudFBhcnNlcih7XG4gICAgYWRkX2hlbHA6IHRydWUsXG4gICAgZGVzY3JpcHRpb246ICdBIHdlYmRyaXZlci1jb21wYXRpYmxlIHNlcnZlciBmb3IgdXNlIHdpdGggbmF0aXZlIGFuZCBoeWJyaWQgaU9TIGFuZCBBbmRyb2lkIGFwcGxpY2F0aW9ucy4nLFxuICAgIHByb2c6IHByb2Nlc3MuYXJndlsxXSA/IHBhdGguYmFzZW5hbWUocHJvY2Vzcy5hcmd2WzFdKSA6ICdhcHBpdW0nLFxuICB9KTtcbiAgaWYgKGRlYnVnKSB7XG4gICAgbWFrZURlYnVnUGFyc2VyKHBhcnNlcik7XG4gIH1cbiAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLXYnLCAnLS12ZXJzaW9uJywge1xuICAgIGFjdGlvbjogJ3ZlcnNpb24nLFxuICAgIHZlcnNpb246IGZzLnJlYWRQYWNrYWdlSnNvbkZyb20ocm9vdERpcikudmVyc2lvblxuICB9KTtcbiAgY29uc3Qgc3ViUGFyc2VycyA9IHBhcnNlci5hZGRfc3VicGFyc2Vycyh7ZGVzdDogJ3N1YmNvbW1hbmQnfSk7XG5cbiAgLy8gYWRkIHRoZSAnc2VydmVyJyBzdWJjb21tYW5kLCBhbmQgc3RvcmUgdGhlIHJhdyBhcmd1bWVudHMgb24gdGhlIHBhcnNlclxuICAvLyBvYmplY3QgYXMgYSB3YXkgZm9yIG90aGVyIHBhcnRzIG9mIHRoZSBjb2RlIHRvIHdvcmsgd2l0aCB0aGUgYXJndW1lbnRzXG4gIC8vIGNvbmNlcHR1YWxseSByYXRoZXIgdGhhbiBqdXN0IHRocm91Z2ggYXJncGFyc2VcbiAgY29uc3Qgc2VydmVyQXJncyA9IGFkZFNlcnZlclRvUGFyc2VyKHNoYXJlZEFyZ3MsIHN1YlBhcnNlcnMsIGRlYnVnKTtcbiAgcGFyc2VyLnJhd0FyZ3MgPSBzZXJ2ZXJBcmdzO1xuXG4gIC8vIGFkZCB0aGUgJ2RyaXZlcicgYW5kICdwbHVnaW4nIHN1YmNvbW1hbmRzXG4gIGFkZEV4dGVuc2lvbnNUb1BhcnNlcihzaGFyZWRBcmdzLCBzdWJQYXJzZXJzLCBkZWJ1Zyk7XG5cbiAgLy8gbW9kaWZ5IHRoZSBwYXJzZV9hcmdzIGZ1bmN0aW9uIHRvIGluc2VydCB0aGUgJ3NlcnZlcicgc3ViY29tbWFuZCBpZiB0aGVcbiAgLy8gdXNlciBoYXNuJ3Qgc3BlY2lmaWVkIGEgc3ViY29tbWFuZCBvciB0aGUgZ2xvYmFsIGhlbHAgY29tbWFuZFxuICBwYXJzZXIuX3BhcnNlX2FyZ3MgPSBwYXJzZXIucGFyc2VfYXJncy5iaW5kKHBhcnNlcik7XG4gIHBhcnNlci5wYXJzZV9hcmdzID0gZnVuY3Rpb24gKGFyZ3MsIG5hbWVzcGFjZSkge1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKGFyZ3MpKSB7XG4gICAgICBhcmdzID0gWy4uLnByb2Nlc3MuYXJndi5zbGljZSgyKV07XG4gICAgfVxuICAgIGlmICghXy5pbmNsdWRlcyhbRFJJVkVSX1RZUEUsIFBMVUdJTl9UWVBFLCAnc2VydmVyJywgJy1oJywgJy0taGVscCcsICctdicsICctLXZlcnNpb24nXSwgYXJnc1swXSkpIHtcbiAgICAgIGFyZ3Muc3BsaWNlKDAsIDAsICdzZXJ2ZXInKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3BhcnNlX2FyZ3MoYXJncywgbmFtZXNwYWNlKTtcbiAgfS5iaW5kKHBhcnNlcik7XG4gIHJldHVybiBwYXJzZXI7XG59XG5cbmZ1bmN0aW9uIGFkZFNlcnZlclRvUGFyc2VyIChzaGFyZWRBcmdzLCBzdWJQYXJzZXJzLCBkZWJ1ZyA9IGZhbHNlKSB7XG4gIGNvbnN0IHNlcnZlclBhcnNlciA9IHN1YlBhcnNlcnMuYWRkX3BhcnNlcignc2VydmVyJywge1xuICAgIGFkZF9oZWxwOiB0cnVlLFxuICAgIGhlbHA6ICdSdW4gYW4gQXBwaXVtIHNlcnZlcicsXG4gIH0pO1xuXG4gIGlmIChkZWJ1Zykge1xuICAgIG1ha2VEZWJ1Z1BhcnNlcihzZXJ2ZXJQYXJzZXIpO1xuICB9XG5cbiAgZm9yIChjb25zdCBbZmxhZ3NPck5hbWVzLCBvcHRzXSBvZiBbLi4uc2hhcmVkQXJncywgLi4uc2VydmVyQXJnc10pIHtcbiAgICAvLyBhZGRfYXJndW1lbnQgbXV0YXRlcyBhcmd1bWVudHMgc28gbWFrZSBjb3BpZXNcbiAgICBzZXJ2ZXJQYXJzZXIuYWRkX2FyZ3VtZW50KC4uLmZsYWdzT3JOYW1lcywgey4uLm9wdHN9KTtcbiAgfVxuXG4gIHJldHVybiBzZXJ2ZXJBcmdzO1xufVxuXG5mdW5jdGlvbiBnZXREZWZhdWx0U2VydmVyQXJncyAoKSB7XG4gIGxldCBkZWZhdWx0cyA9IHt9O1xuICBmb3IgKGxldCBbLCBhcmddIG9mIHNlcnZlckFyZ3MpIHtcbiAgICBkZWZhdWx0c1thcmcuZGVzdF0gPSBhcmcuZGVmYXVsdDtcbiAgfVxuICByZXR1cm4gZGVmYXVsdHM7XG59XG5cbmZ1bmN0aW9uIGFkZEV4dGVuc2lvbnNUb1BhcnNlciAoc2hhcmVkQXJncywgc3ViUGFyc2VycywgZGVidWcgPSBmYWxzZSkge1xuICBmb3IgKGNvbnN0IHR5cGUgb2YgW0RSSVZFUl9UWVBFLCBQTFVHSU5fVFlQRV0pIHtcbiAgICBjb25zdCBleHRQYXJzZXIgPSBzdWJQYXJzZXJzLmFkZF9wYXJzZXIodHlwZSwge1xuICAgICAgYWRkX2hlbHA6IHRydWUsXG4gICAgICBoZWxwOiBgQWNjZXNzIHRoZSAke3R5cGV9IG1hbmFnZW1lbnQgQ0xJIGNvbW1hbmRzYCxcbiAgICB9KTtcbiAgICBpZiAoZGVidWcpIHtcbiAgICAgIG1ha2VEZWJ1Z1BhcnNlcihleHRQYXJzZXIpO1xuICAgIH1cbiAgICBjb25zdCBleHRTdWJQYXJzZXJzID0gZXh0UGFyc2VyLmFkZF9zdWJwYXJzZXJzKHtcbiAgICAgIGRlc3Q6IGAke3R5cGV9Q29tbWFuZGAsXG4gICAgfSk7XG4gICAgY29uc3QgcGFyc2VyU3BlY3MgPSBbXG4gICAgICB7Y29tbWFuZDogJ2xpc3QnLCBhcmdzOiBleHRlbnNpb25BcmdzW3R5cGVdLmxpc3QsXG4gICAgICAgaGVscDogYExpc3QgYXZhaWxhYmxlIGFuZCBpbnN0YWxsZWQgJHt0eXBlfXNgfSxcbiAgICAgIHtjb21tYW5kOiAnaW5zdGFsbCcsIGFyZ3M6IGV4dGVuc2lvbkFyZ3NbdHlwZV0uaW5zdGFsbCxcbiAgICAgICBoZWxwOiBgSW5zdGFsbCBhICR7dHlwZX1gfSxcbiAgICAgIHtjb21tYW5kOiAndW5pbnN0YWxsJywgYXJnczogZXh0ZW5zaW9uQXJnc1t0eXBlXS51bmluc3RhbGwsXG4gICAgICAgaGVscDogYFVuaW5zdGFsbCBhICR7dHlwZX1gfSxcbiAgICAgIHtjb21tYW5kOiAndXBkYXRlJywgYXJnczogZXh0ZW5zaW9uQXJnc1t0eXBlXS51cGRhdGUsXG4gICAgICAgaGVscDogYFVwZGF0ZSBpbnN0YWxsZWQgJHt0eXBlfXMgdG8gdGhlIGxhdGVzdCB2ZXJzaW9uYH0sXG4gICAgICB7Y29tbWFuZDogJ3J1bicsIGFyZ3M6IGV4dGVuc2lvbkFyZ3NbdHlwZV0ucnVuLFxuICAgICAgIGhlbHA6IGBSdW4gYSBzY3JpcHQgKGRlZmluZWQgaW5zaWRlIHRoZSAke3R5cGV9J3MgcGFja2FnZS5qc29uIHVuZGVyIHRoZSBgICtcbiAgICAgICAgICAgICBg4oCcc2NyaXB0c+KAnSBmaWVsZCBpbnNpZGUgdGhlIOKAnGFwcGl1beKAnSBmaWVsZCkgZnJvbSBhbiBpbnN0YWxsZWQgJHt0eXBlfWB9XG4gICAgXTtcblxuICAgIGZvciAoY29uc3Qge2NvbW1hbmQsIGFyZ3MsIGhlbHB9IG9mIHBhcnNlclNwZWNzKSB7XG4gICAgICBjb25zdCBwYXJzZXIgPSBleHRTdWJQYXJzZXJzLmFkZF9wYXJzZXIoY29tbWFuZCwge2hlbHB9KTtcbiAgICAgIGlmIChkZWJ1Zykge1xuICAgICAgICBtYWtlRGVidWdQYXJzZXIocGFyc2VyKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgW2ZsYWdzT3JOYW1lcywgb3B0c10gb2YgWy4uLnNoYXJlZEFyZ3MsIC4uLmFyZ3NdKSB7XG4gICAgICAgIC8vIGFkZF9hcmd1bWVudCBtdXRhdGVzIHBhcmFtcyBzbyBtYWtlIHN1cmUgdG8gc2VuZCBpbiBjb3BpZXMgaW5zdGVhZFxuICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KC4uLmZsYWdzT3JOYW1lcywgey4uLm9wdHN9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZ2V0UGFyc2VyO1xuZXhwb3J0IHsgZ2V0UGFyc2VyLCBnZXREZWZhdWx0U2VydmVyQXJncyB9O1xuIl0sImZpbGUiOiJsaWIvY2xpL3BhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
