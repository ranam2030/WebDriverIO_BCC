"use strict";

require("source-map-support/register");

var _lib = require("../../../lib");

var _server2 = require("../../../lib/express/server");

var _sinon = require("sinon");

var _helpers = require("../../helpers");

const newMethodMap = {
  '/session/:sessionId/fake': {
    GET: {
      command: 'fakeGet'
    },
    POST: {
      command: 'fakePost',
      payloadParams: {
        required: ['fakeParam']
      }
    }
  }
};

const updateServer = (app, httpServer) => {
  app.updated = true;
  httpServer.updated = true;
};

function fakeDriver() {
  return {
    sessionExists: () => {},
    executeCommand: () => {}
  };
}

describe('server configuration', function () {
  let port;
  let sandbox;

  function fakeApp() {
    const app = {
      use: sandbox.spy(),
      all: sandbox.spy(),
      get: sandbox.spy(),
      post: sandbox.spy(),
      delete: sandbox.spy(),
      totalCount: () => app.use.callCount + app.all.callCount + app.get.callCount + app.post.callCount + app.delete.callCount
    };
    return app;
  }

  before(async function () {
    port = await (0, _helpers.getTestPort)(true);
  });
  beforeEach(function () {
    sandbox = (0, _sinon.createSandbox)();
  });
  afterEach(function () {
    sandbox.restore();
  });
  it('should actually use the middleware', function () {
    const app = fakeApp();

    const configureRoutes = () => {};

    (0, _server2.configureServer)({
      app,
      addRoutes: configureRoutes
    });
    app.use.callCount.should.equal(14);
    app.all.callCount.should.equal(4);
  });
  it('should apply new methods in plugins to the standard method map', function () {
    const app1 = fakeApp();
    const app2 = fakeApp();
    const driver = fakeDriver();
    const addRoutes = (0, _lib.routeConfiguringFunction)(driver);
    (0, _server2.configureServer)({
      app: app1,
      addRoutes
    });
    (0, _server2.configureServer)({
      app: app2,
      addRoutes,
      extraMethodMap: newMethodMap
    });
    app2.totalCount().should.eql(app1.totalCount() + 2);
  });
  it('should silently reject new methods in plugins if not plain objects', function () {
    const app1 = fakeApp();
    const app2 = fakeApp();
    const driver = fakeDriver();
    const addRoutes = (0, _lib.routeConfiguringFunction)(driver);
    (0, _server2.configureServer)({
      app: app1,
      addRoutes
    });
    (0, _server2.configureServer)({
      app: app2,
      addRoutes,
      extraMethodMap: []
    });
    app2.totalCount().should.eql(app1.totalCount());
  });
  it('should allow plugins to update the server', async function () {
    const driver = fakeDriver();

    const _server = await (0, _lib.server)({
      routeConfiguringFunction: (0, _lib.routeConfiguringFunction)(driver),
      port,
      extraMethodMap: newMethodMap,
      serverUpdaters: [updateServer]
    });

    try {
      _server.updated.should.be.true;
    } finally {
      await _server.close();
    }
  });
  it('should reject if error thrown in configureRoutes parameter', async function () {
    const configureRoutes = () => {
      throw new Error('I am Mr. MeeSeeks look at me!');
    };

    await (0, _lib.server)({
      routeConfiguringFunction: configureRoutes,
      port
    }).should.be.rejectedWith('MeeSeeks');
  });
  describe('#normalizeBasePath', function () {
    it('should throw an error for paths of the wrong type', function () {
      should.throw(() => {
        (0, _server2.normalizeBasePath)(null);
      });
      should.throw(() => {
        (0, _server2.normalizeBasePath)(1);
      });
    });
    it('should remove trailing slashes', function () {
      (0, _server2.normalizeBasePath)('/wd/hub/').should.eql('/wd/hub');
      (0, _server2.normalizeBasePath)('/foo/').should.eql('/foo');
      (0, _server2.normalizeBasePath)('/').should.eql('');
    });
    it('should ensure a leading slash is present', function () {
      (0, _server2.normalizeBasePath)('foo').should.eql('/foo');
      (0, _server2.normalizeBasePath)('wd/hub').should.eql('/wd/hub');
      (0, _server2.normalizeBasePath)('wd/hub/').should.eql('/wd/hub');
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Rlc3QvdW5pdC9leHByZXNzL3NlcnZlci5zcGVjLmpzIl0sIm5hbWVzIjpbIm5ld01ldGhvZE1hcCIsIkdFVCIsImNvbW1hbmQiLCJQT1NUIiwicGF5bG9hZFBhcmFtcyIsInJlcXVpcmVkIiwidXBkYXRlU2VydmVyIiwiYXBwIiwiaHR0cFNlcnZlciIsInVwZGF0ZWQiLCJmYWtlRHJpdmVyIiwic2Vzc2lvbkV4aXN0cyIsImV4ZWN1dGVDb21tYW5kIiwiZGVzY3JpYmUiLCJwb3J0Iiwic2FuZGJveCIsImZha2VBcHAiLCJ1c2UiLCJzcHkiLCJhbGwiLCJnZXQiLCJwb3N0IiwiZGVsZXRlIiwidG90YWxDb3VudCIsImNhbGxDb3VudCIsImJlZm9yZSIsImJlZm9yZUVhY2giLCJhZnRlckVhY2giLCJyZXN0b3JlIiwiaXQiLCJjb25maWd1cmVSb3V0ZXMiLCJhZGRSb3V0ZXMiLCJzaG91bGQiLCJlcXVhbCIsImFwcDEiLCJhcHAyIiwiZHJpdmVyIiwiZXh0cmFNZXRob2RNYXAiLCJlcWwiLCJfc2VydmVyIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwic2VydmVyVXBkYXRlcnMiLCJiZSIsInRydWUiLCJjbG9zZSIsIkVycm9yIiwicmVqZWN0ZWRXaXRoIiwidGhyb3ciXSwibWFwcGluZ3MiOiI7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxZQUFZLEdBQUc7QUFDbkIsOEJBQTRCO0FBQzFCQyxJQUFBQSxHQUFHLEVBQUU7QUFBQ0MsTUFBQUEsT0FBTyxFQUFFO0FBQVYsS0FEcUI7QUFFMUJDLElBQUFBLElBQUksRUFBRTtBQUFDRCxNQUFBQSxPQUFPLEVBQUUsVUFBVjtBQUFzQkUsTUFBQUEsYUFBYSxFQUFFO0FBQUNDLFFBQUFBLFFBQVEsRUFBRSxDQUFDLFdBQUQ7QUFBWDtBQUFyQztBQUZvQjtBQURULENBQXJCOztBQU9BLE1BQU1DLFlBQVksR0FBRyxDQUFDQyxHQUFELEVBQU1DLFVBQU4sS0FBcUI7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LENBekdPLENBQVIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bW9jaGFcblxuaW1wb3J0IHsgc2VydmVyLCByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24gfSBmcm9tICcuLi8uLi8uLi9saWInO1xuaW1wb3J0IHsgY29uZmlndXJlU2VydmVyLCBub3JtYWxpemVCYXNlUGF0aCB9IGZyb20gJy4uLy4uLy4uL2xpYi9leHByZXNzL3NlcnZlcic7XG5pbXBvcnQgeyBjcmVhdGVTYW5kYm94IH0gZnJvbSAnc2lub24nO1xuaW1wb3J0IHsgZ2V0VGVzdFBvcnQgfSBmcm9tICcuLi8uLi9oZWxwZXJzJztcblxuY29uc3QgbmV3TWV0aG9kTWFwID0ge1xuICAnL3Nlc3Npb24vOnNlc3Npb25JZC9mYWtlJzoge1xuICAgIEdFVDoge2NvbW1hbmQ6ICdmYWtlR2V0J30sXG4gICAgUE9TVDoge2NvbW1hbmQ6ICdmYWtlUG9zdCcsIHBheWxvYWRQYXJhbXM6IHtyZXF1aXJlZDogWydmYWtlUGFyYW0nXX19XG4gIH0sXG59O1xuXG5jb25zdCB1cGRhdGVTZXJ2ZXIgPSAoYXBwLCBodHRwU2VydmVyKSA9PiB7XG4gIGFwcC51cGRhdGVkID0gdHJ1ZTtcbiAgaHR0cFNlcnZlci51cGRhdGVkID0gdHJ1ZTtcbn07XG5cbmZ1bmN0aW9uIGZha2VEcml2ZXIgKCkge1xuICByZXR1cm4ge3Nlc3Npb25FeGlzdHM6ICgpID0+IHt9LCBleGVjdXRlQ29tbWFuZDogKCkgPT4ge319O1xufVxuXG5kZXNjcmliZSgnc2VydmVyIGNvbmZpZ3VyYXRpb24nLCBmdW5jdGlvbiAoKSB7XG4gIGxldCBwb3J0O1xuXG4gIGxldCBzYW5kYm94O1xuXG4gIGZ1bmN0aW9uIGZha2VBcHAgKCkge1xuICAgIGNvbnN0IGFwcCA9IHtcbiAgICAgIHVzZTogc2FuZGJveC5zcHkoKSxcbiAgICAgIGFsbDogc2FuZGJveC5zcHkoKSxcbiAgICAgIGdldDogc2FuZGJveC5zcHkoKSxcbiAgICAgIHBvc3Q6IHNhbmRib3guc3B5KCksXG4gICAgICBkZWxldGU6IHNhbmRib3guc3B5KCksXG4gICAgICB0b3RhbENvdW50OiAoKSA9PiAoXG4gICAgICAgIGFwcC51c2UuY2FsbENvdW50ICsgYXBwLmFsbC5jYWxsQ291bnQgKyBhcHAuZ2V0LmNhbGxDb3VudCArIGFwcC5wb3N0LmNhbGxDb3VudCArXG4gICAgICAgIGFwcC5kZWxldGUuY2FsbENvdW50XG4gICAgICApXG4gICAgfTtcbiAgICByZXR1cm4gYXBwO1xuICB9XG5cbiAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBwb3J0ID0gYXdhaXQgZ2V0VGVzdFBvcnQodHJ1ZSk7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goZnVuY3Rpb24gKCkge1xuICAgIHNhbmRib3ggPSBjcmVhdGVTYW5kYm94KCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChmdW5jdGlvbiAoKSB7XG4gICAgc2FuZGJveC5yZXN0b3JlKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYWN0dWFsbHkgdXNlIHRoZSBtaWRkbGV3YXJlJywgZnVuY3Rpb24gKCkge1xuICAgIGNvbnN0IGFwcCA9IGZha2VBcHAoKTtcbiAgICBjb25zdCBjb25maWd1cmVSb3V0ZXMgPSAoKSA9PiB7fTtcbiAgICBjb25maWd1cmVTZXJ2ZXIoe2FwcCwgYWRkUm91dGVzOiBjb25maWd1cmVSb3V0ZXN9KTtcbiAgICBhcHAudXNlLmNhbGxDb3VudC5zaG91bGQuZXF1YWwoMTQpO1xuICAgIGFwcC5hbGwuY2FsbENvdW50LnNob3VsZC5lcXVhbCg0KTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBhcHBseSBuZXcgbWV0aG9kcyBpbiBwbHVnaW5zIHRvIHRoZSBzdGFuZGFyZCBtZXRob2QgbWFwJywgZnVuY3Rpb24gKCkge1xuICAgIGNvbnN0IGFwcDEgPSBmYWtlQXBwKCk7XG4gICAgY29uc3QgYXBwMiA9IGZha2VBcHAoKTtcbiAgICBjb25zdCBkcml2ZXIgPSBmYWtlRHJpdmVyKCk7XG4gICAgY29uc3QgYWRkUm91dGVzID0gcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uKGRyaXZlcik7XG4gICAgY29uZmlndXJlU2VydmVyKHthcHA6IGFwcDEsIGFkZFJvdXRlc30pO1xuICAgIGNvbmZpZ3VyZVNlcnZlcih7YXBwOiBhcHAyLCBhZGRSb3V0ZXMsIGV4dHJhTWV0aG9kTWFwOiBuZXdNZXRob2RNYXB9KTtcbiAgICBhcHAyLnRvdGFsQ291bnQoKS5zaG91bGQuZXFsKGFwcDEudG90YWxDb3VudCgpICsgMik7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgc2lsZW50bHkgcmVqZWN0IG5ldyBtZXRob2RzIGluIHBsdWdpbnMgaWYgbm90IHBsYWluIG9iamVjdHMnLCBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgYXBwMSA9IGZha2VBcHAoKTtcbiAgICBjb25zdCBhcHAyID0gZmFrZUFwcCgpO1xuICAgIGNvbnN0IGRyaXZlciA9IGZha2VEcml2ZXIoKTtcbiAgICBjb25zdCBhZGRSb3V0ZXMgPSByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24oZHJpdmVyKTtcbiAgICBjb25maWd1cmVTZXJ2ZXIoe2FwcDogYXBwMSwgYWRkUm91dGVzfSk7XG4gICAgY29uZmlndXJlU2VydmVyKHthcHA6IGFwcDIsIGFkZFJvdXRlcywgZXh0cmFNZXRob2RNYXA6IFtdfSk7XG4gICAgYXBwMi50b3RhbENvdW50KCkuc2hvdWxkLmVxbChhcHAxLnRvdGFsQ291bnQoKSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYWxsb3cgcGx1Z2lucyB0byB1cGRhdGUgdGhlIHNlcnZlcicsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCBkcml2ZXIgPSBmYWtlRHJpdmVyKCk7XG4gICAgY29uc3QgX3NlcnZlciA9IGF3YWl0IHNlcnZlcih7XG4gICAgICByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb246IHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbihkcml2ZXIpLFxuICAgICAgcG9ydCxcbiAgICAgIGV4dHJhTWV0aG9kTWFwOiBuZXdNZXRob2RNYXAsXG4gICAgICBzZXJ2ZXJVcGRhdGVyczogW3VwZGF0ZVNlcnZlcl1cbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgX3NlcnZlci51cGRhdGVkLnNob3VsZC5iZS50cnVlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBfc2VydmVyLmNsb3NlKCk7XG4gICAgfVxuICB9KTtcblxuICBpdCgnc2hvdWxkIHJlamVjdCBpZiBlcnJvciB0aHJvd24gaW4gY29uZmlndXJlUm91dGVzIHBhcmFtZXRlcicsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCBjb25maWd1cmVSb3V0ZXMgPSAoKSA9PiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0kgYW0gTXIuIE1lZVNlZWtzIGxvb2sgYXQgbWUhJyk7XG4gICAgfTtcbiAgICBhd2FpdCBzZXJ2ZXIoe1xuICAgICAgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uOiBjb25maWd1cmVSb3V0ZXMsXG4gICAgICBwb3J0LFxuICAgIH0pLnNob3VsZC5iZS5yZWplY3RlZFdpdGgoJ01lZVNlZWtzJyk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCcjbm9ybWFsaXplQmFzZVBhdGgnLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBlcnJvciBmb3IgcGF0aHMgb2YgdGhlIHdyb25nIHR5cGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBzaG91bGQudGhyb3coKCkgPT4ge1xuICAgICAgICBub3JtYWxpemVCYXNlUGF0aChudWxsKTtcbiAgICAgIH0pO1xuICAgICAgc2hvdWxkLnRocm93KCgpID0+IHtcbiAgICAgICAgbm9ybWFsaXplQmFzZVBhdGgoMSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHJlbW92ZSB0cmFpbGluZyBzbGFzaGVzJywgZnVuY3Rpb24gKCkge1xuICAgICAgbm9ybWFsaXplQmFzZVBhdGgoJy93ZC9odWIvJykuc2hvdWxkLmVxbCgnL3dkL2h1YicpO1xuICAgICAgbm9ybWFsaXplQmFzZVBhdGgoJy9mb28vJykuc2hvdWxkLmVxbCgnL2ZvbycpO1xuICAgICAgbm9ybWFsaXplQmFzZVBhdGgoJy8nKS5zaG91bGQuZXFsKCcnKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGVuc3VyZSBhIGxlYWRpbmcgc2xhc2ggaXMgcHJlc2VudCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIG5vcm1hbGl6ZUJhc2VQYXRoKCdmb28nKS5zaG91bGQuZXFsKCcvZm9vJyk7XG4gICAgICBub3JtYWxpemVCYXNlUGF0aCgnd2QvaHViJykuc2hvdWxkLmVxbCgnL3dkL2h1YicpO1xuICAgICAgbm9ybWFsaXplQmFzZVBhdGgoJ3dkL2h1Yi8nKS5zaG91bGQuZXFsKCcvd2QvaHViJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=