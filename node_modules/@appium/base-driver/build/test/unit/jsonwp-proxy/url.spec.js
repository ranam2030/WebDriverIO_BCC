"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lib = require("../../../lib");

var _helpers = require("../../helpers");

var _lodash = _interopRequireDefault(require("lodash"));

describe('JWProxy', function () {
  let port;
  let createTestURL;
  let testStatusURL;
  let createTestSessionURL;
  let testNewSessionURL;
  const PROXY_HOST = '127.0.0.2';
  const PROXY_PORT = 4723;
  const createProxyURL = (0, _helpers.createAppiumURL)(PROXY_HOST, PROXY_PORT);
  const PROXY_STATUS_URL = createProxyURL('', 'status');

  function createJWProxy(opts = {}) {
    return new _lib.JWProxy({
      server: _helpers.TEST_HOST,
      port,
      ...opts
    });
  }

  before(async function () {
    port = await (0, _helpers.getTestPort)();
    createTestURL = (0, _helpers.createAppiumURL)(_helpers.TEST_HOST, port);
    testStatusURL = createTestURL('', 'status');
    createTestSessionURL = createTestURL(_lodash.default, '');
    testNewSessionURL = createTestURL('', 'session');
  });
  describe('proxying full urls', function () {
    it('should translate host and port', function () {
      let incomingUrl = PROXY_STATUS_URL;
      let j = createJWProxy();
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(testStatusURL);
    });
    it('should translate the scheme', function () {
      let incomingUrl = PROXY_STATUS_URL;
      let j = createJWProxy({
        scheme: 'HTTPS'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal((0, _helpers.createAppiumURL)(`https://${_helpers.TEST_HOST}`, port, '', 'status'));
    });
    it('should translate the base', function () {
      let incomingUrl = PROXY_STATUS_URL;
      let j = createJWProxy({
        base: ''
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(testStatusURL);
    });
    it('should translate the session id', function () {
      let incomingUrl = createProxyURL('foobar', 'element');
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'element'));
    });
    it('should error when translating session commands without session id', function () {
      let incomingUrl = createProxyURL('foobar', 'element');
      let j = createJWProxy();
      (() => {
        j.getUrlForProxy(incomingUrl);
      }).should.throw('session id');
    });
  });
  describe('proxying partial urls', function () {
    it('should proxy /status', function () {
      let incomingUrl = '/status';
      let j = createJWProxy();
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(testStatusURL);
    });
    it('should proxy /session', function () {
      let incomingUrl = '/session';
      let j = createJWProxy();
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(testNewSessionURL);
    });
    it('should proxy /sessions', function () {
      let incomingUrl = '/sessions';
      let j = createJWProxy();
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('', 'sessions'));
    });
    it('should proxy session commands based off /session', function () {
      let incomingUrl = '/session/foobar/element';
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'element'));
    });
    it('should error session commands based off /session without session id', function () {
      let incomingUrl = '/session/foobar/element';
      let j = createJWProxy();
      (() => {
        j.getUrlForProxy(incomingUrl);
      }).should.throw('session id');
    });
    it('should proxy session commands based off ', function () {
      let incomingUrl = '/session/3d001db2-7987-42a7-975d-8d5d5304083f/timeouts/implicit_wait';
      let j = createJWProxy({
        sessionId: '123'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('123', 'timeouts/implicit_wait'));
    });
    it('should proxy session commands based off /session as ""', function () {
      let incomingUrl = '';
      let j = createJWProxy();
      (() => {
        j.getUrlForProxy(incomingUrl);
      }).should.throw('session id');
      j = createJWProxy({
        sessionId: '123'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestSessionURL('123'));
    });
    it('should proxy session commands without /session', function () {
      let incomingUrl = '/element';
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'element'));
    });
    it(`should proxy session commands when '/session' is in the url`, function () {
      let incomingUrl = '/session/82a9b7da-faaf-4a1d-8ef3-5e4fb5812200/cookie/session-something-or-other';
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'cookie/session-something-or-other'));
    });
    it(`should proxy session commands when '/session' is in the url and not base on the original url`, function () {
      let incomingUrl = '/session/82a9b7da-faaf-4a1d-8ef3-5e4fb5812200/cookie/session-something-or-other';
      let j = createJWProxy({
        sessionId: 'barbaz'
      });
      let proxyUrl = j.getUrlForProxy(incomingUrl);
      proxyUrl.should.equal(createTestURL('barbaz', 'cookie/session-something-or-other'));
    });
    it('should error session commands without /session without session id', function () {
      let incomingUrl = '/element';
      let j = createJWProxy();
      (() => {
        j.getUrlForProxy(incomingUrl);
      }).should.throw('session id');
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Rlc3QvdW5pdC9qc29ud3AtcHJveHkvdXJsLnNwZWMuanMiXSwibmFtZXMiOlsiZGVzY3JpYmUiLCJwb3J0IiwiY3JlYXRlVGVzdFVSTCIsInRlc3RTdGF0dXNVUkwiLCJjcmVhdGVUZXN0U2Vzc2lvblVSTCIsInRlc3ROZXdTZXNzaW9uVVJMIiwiUFJPWFlfSE9TVCIsIlBST1hZX1BPUlQiLCJjcmVhdGVQcm94eVVSTCIsIlBST1hZX1NUQVRVU19VUkwiLCJjcmVhdGVKV1Byb3h5Iiwib3B0cyIsIkpXUHJveHkiLCJzZXJ2ZXIiLCJURVNUX0hPU1QiLCJiZWZvcmUiLCJfIiwiaXQiLCJpbmNvbWluZ1VybCIsImoiLCJwcm94eVVybCIsImdldFVybEZvclByb3h5Iiwic2hvdWxkIiwiZXF1YWwiLCJzY2hlbWUiLCJiYXNlIiwic2Vzc2lvbklkIiwidGhyb3ciXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUVBQSxRQUFRLENBQUMsU0FBRCxFQUFZLFlBQVk7QUFDOUIsTUFBSUMsSUFBSjtBQUVBLE1BQUlDLGFBQUo7QUFDQSxNQUFJQyxhQUFKO0FBQ0EsTUFBSUMsb0JBQUo7QUFDQSxNQUFJQyxpQkFBSjtBQUVBLFFBQU1DLFVBQVUsR0FBRyxXQUFuQjtBQUNBLFFBQU1DLFVBQVUsR0FBRyxJQUFuQjtBQUVBLFFBQU1DLGNBQWMsR0FBRyw4QkFBZ0JGLFVBQWhCLEVBQTRCQyxVQUE1QixDQUF2QjtBQUNBLFFBQU1FLGdCQUFnQixHQUFHRCxjQUFjLENBQUMsRUFBRCxFQUFLLFFBQUwsQ0FBdkM7O0FBRUEsV0FBU0UsYUFBVCxDQUF3QkMsSUFBSSxHQUFHLEVBQS9CLEVBQW1DO0FBQ2pDLFdBQU8sSUFBSUMsWUFBSixDQUFZO0FBQUNDLE1BQUFBLE1BQU0sRUFBRUMsa0JBQVQ7QUFBb0JiLE1BQUFBLElBQXBCO0FBQTBCLFNBQUdVO0FBQTdCLEtBQVosQ0FBUDtBQUNEOztBQUVESSxFQUFBQSxNQUFNLENBQUMs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QWhCLENBQXNCckIsYUFBYSxDQUFDLFFBQUQsRUFBVyxtQ0FBWCxDQUFuQztBQUNELEtBTEMsQ0FBRjtBQU1BZSxJQUFBQSxFQUFFLENBQUMsbUVBQUQsRUFBc0UsWUFBWTtBQUNsRixVQUFJQyxXQUFXLEdBQUcsVUFBbEI7QUFDQSxVQUFJQyxDQUFDLEdBQUdULGFBQWEsRUFBckI7QUFDQSxPQUFDLE1BQU07QUFBRVMsUUFBQUEsQ0FBQyxDQUFDRSxjQUFGLENBQWlCSCxXQUFqQjtBQUFnQyxPQUF6QyxFQUEyQ0ksTUFBM0MsQ0FBa0RLLEtBQWxELENBQXdELFlBQXhEO0FBQ0QsS0FKQyxDQUFGO0FBS0QsR0FuRU8sQ0FBUjtBQXFFRCxDQS9ITyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICcuLi8uLi8uLi9saWInO1xuaW1wb3J0IHsgZ2V0VGVzdFBvcnQsIFRFU1RfSE9TVCwgY3JlYXRlQXBwaXVtVVJMIH0gZnJvbSAnLi4vLi4vaGVscGVycyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5kZXNjcmliZSgnSldQcm94eScsIGZ1bmN0aW9uICgpIHtcbiAgbGV0IHBvcnQ7XG5cbiAgbGV0IGNyZWF0ZVRlc3RVUkw7XG4gIGxldCB0ZXN0U3RhdHVzVVJMO1xuICBsZXQgY3JlYXRlVGVzdFNlc3Npb25VUkw7XG4gIGxldCB0ZXN0TmV3U2Vzc2lvblVSTDtcblxuICBjb25zdCBQUk9YWV9IT1NUID0gJzEyNy4wLjAuMic7XG4gIGNvbnN0IFBST1hZX1BPUlQgPSA0NzIzO1xuXG4gIGNvbnN0IGNyZWF0ZVByb3h5VVJMID0gY3JlYXRlQXBwaXVtVVJMKFBST1hZX0hPU1QsIFBST1hZX1BPUlQpO1xuICBjb25zdCBQUk9YWV9TVEFUVVNfVVJMID0gY3JlYXRlUHJveHlVUkwoJycsICdzdGF0dXMnKTtcblxuICBmdW5jdGlvbiBjcmVhdGVKV1Byb3h5IChvcHRzID0ge30pIHtcbiAgICByZXR1cm4gbmV3IEpXUHJveHkoe3NlcnZlcjogVEVTVF9IT1NULCBwb3J0LCAuLi5vcHRzfSk7XG4gIH1cblxuICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIHBvcnQgPSBhd2FpdCBnZXRUZXN0UG9ydCgpO1xuICAgIGNyZWF0ZVRlc3RVUkwgPSBjcmVhdGVBcHBpdW1VUkwoVEVTVF9IT1NULCBwb3J0KTtcbiAgICB0ZXN0U3RhdHVzVVJMID0gY3JlYXRlVGVzdFVSTCgnJywgJ3N0YXR1cycpO1xuICAgIGNyZWF0ZVRlc3RTZXNzaW9uVVJMID0gY3JlYXRlVGVzdFVSTChfLCAnJyk7XG4gICAgdGVzdE5ld1Nlc3Npb25VUkwgPSBjcmVhdGVUZXN0VVJMKCcnLCAnc2Vzc2lvbicpO1xuICB9KTtcblxuICBkZXNjcmliZSgncHJveHlpbmcgZnVsbCB1cmxzJywgZnVuY3Rpb24gKCkge1xuICAgIGl0KCdzaG91bGQgdHJhbnNsYXRlIGhvc3QgYW5kIHBvcnQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSBQUk9YWV9TVEFUVVNfVVJMO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KCk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbCh0ZXN0U3RhdHVzVVJMKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHRyYW5zbGF0ZSB0aGUgc2NoZW1lJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGluY29taW5nVXJsID0gUFJPWFlfU1RBVFVTX1VSTDtcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSh7c2NoZW1lOiAnSFRUUFMnfSk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbChjcmVhdGVBcHBpdW1VUkwoYGh0dHBzOi8vJHtURVNUX0hPU1R9YCwgcG9ydCwgJycsICdzdGF0dXMnKSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB0cmFuc2xhdGUgdGhlIGJhc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSBQUk9YWV9TVEFUVVNfVVJMO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KHtiYXNlOiAnJ30pO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwodGVzdFN0YXR1c1VSTCk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB0cmFuc2xhdGUgdGhlIHNlc3Npb24gaWQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSBjcmVhdGVQcm94eVVSTCgnZm9vYmFyJywgJ2VsZW1lbnQnKTtcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSh7c2Vzc2lvbklkOiAnYmFyYmF6J30pO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwoY3JlYXRlVGVzdFVSTCgnYmFyYmF6JywgJ2VsZW1lbnQnKSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBlcnJvciB3aGVuIHRyYW5zbGF0aW5nIHNlc3Npb24gY29tbWFuZHMgd2l0aG91dCBzZXNzaW9uIGlkJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGluY29taW5nVXJsID0gY3JlYXRlUHJveHlVUkwoJ2Zvb2JhcicsICdlbGVtZW50Jyk7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoKTtcbiAgICAgICgoKSA9PiB7IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpOyB9KS5zaG91bGQudGhyb3coJ3Nlc3Npb24gaWQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3Byb3h5aW5nIHBhcnRpYWwgdXJscycsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIHByb3h5IC9zdGF0dXMnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSAnL3N0YXR1cyc7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoKTtcbiAgICAgIGxldCBwcm94eVVybCA9IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpO1xuICAgICAgcHJveHlVcmwuc2hvdWxkLmVxdWFsKHRlc3RTdGF0dXNVUkwpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcHJveHkgL3Nlc3Npb24nLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSAnL3Nlc3Npb24nO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KCk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbCh0ZXN0TmV3U2Vzc2lvblVSTCk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwcm94eSAvc2Vzc2lvbnMnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSAnL3Nlc3Npb25zJztcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSgpO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwoY3JlYXRlVGVzdFVSTCgnJywgJ3Nlc3Npb25zJykpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcHJveHkgc2Vzc2lvbiBjb21tYW5kcyBiYXNlZCBvZmYgL3Nlc3Npb24nLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSAnL3Nlc3Npb24vZm9vYmFyL2VsZW1lbnQnO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KHtzZXNzaW9uSWQ6ICdiYXJiYXonfSk7XG4gICAgICBsZXQgcHJveHlVcmwgPSBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTtcbiAgICAgIHByb3h5VXJsLnNob3VsZC5lcXVhbChjcmVhdGVUZXN0VVJMKCdiYXJiYXonLCAnZWxlbWVudCcpKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGVycm9yIHNlc3Npb24gY29tbWFuZHMgYmFzZWQgb2ZmIC9zZXNzaW9uIHdpdGhvdXQgc2Vzc2lvbiBpZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvc2Vzc2lvbi9mb29iYXIvZWxlbWVudCc7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoKTtcbiAgICAgICgoKSA9PiB7IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpOyB9KS5zaG91bGQudGhyb3coJ3Nlc3Npb24gaWQnKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHByb3h5IHNlc3Npb24gY29tbWFuZHMgYmFzZWQgb2ZmICcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvc2Vzc2lvbi8zZDAwMWRiMi03OTg3LTQyYTctOTc1ZC04ZDVkNTMwNDA4M2YvdGltZW91dHMvaW1wbGljaXRfd2FpdCc7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGxldCBwcm94eVVybCA9IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpO1xuICAgICAgcHJveHlVcmwuc2hvdWxkLmVxdWFsKGNyZWF0ZVRlc3RVUkwoJzEyMycsICd0aW1lb3V0cy9pbXBsaWNpdF93YWl0JykpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcHJveHkgc2Vzc2lvbiBjb21tYW5kcyBiYXNlZCBvZmYgL3Nlc3Npb24gYXMgXCJcIicsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcnO1xuICAgICAgbGV0IGogPSBjcmVhdGVKV1Byb3h5KCk7XG4gICAgICAoKCkgPT4geyBqLmdldFVybEZvclByb3h5KGluY29taW5nVXJsKTsgfSkuc2hvdWxkLnRocm93KCdzZXNzaW9uIGlkJyk7XG4gICAgICBqID0gY3JlYXRlSldQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwoY3JlYXRlVGVzdFNlc3Npb25VUkwoJzEyMycpKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHByb3h5IHNlc3Npb24gY29tbWFuZHMgd2l0aG91dCAvc2Vzc2lvbicsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvZWxlbWVudCc7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoe3Nlc3Npb25JZDogJ2JhcmJheid9KTtcbiAgICAgIGxldCBwcm94eVVybCA9IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpO1xuICAgICAgcHJveHlVcmwuc2hvdWxkLmVxdWFsKGNyZWF0ZVRlc3RVUkwoJ2JhcmJheicsICdlbGVtZW50JykpO1xuICAgIH0pO1xuICAgIGl0KGBzaG91bGQgcHJveHkgc2Vzc2lvbiBjb21tYW5kcyB3aGVuICcvc2Vzc2lvbicgaXMgaW4gdGhlIHVybGAsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBpbmNvbWluZ1VybCA9ICcvc2Vzc2lvbi84MmE5YjdkYS1mYWFmLTRhMWQtOGVmMy01ZTRmYjU4MTIyMDAvY29va2llL3Nlc3Npb24tc29tZXRoaW5nLW9yLW90aGVyJztcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSh7c2Vzc2lvbklkOiAnYmFyYmF6J30pO1xuICAgICAgbGV0IHByb3h5VXJsID0gai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7XG4gICAgICBwcm94eVVybC5zaG91bGQuZXF1YWwoY3JlYXRlVGVzdFVSTCgnYmFyYmF6JywgJ2Nvb2tpZS9zZXNzaW9uLXNvbWV0aGluZy1vci1vdGhlcicpKTtcbiAgICB9KTtcbiAgICBpdChgc2hvdWxkIHByb3h5IHNlc3Npb24gY29tbWFuZHMgd2hlbiAnL3Nlc3Npb24nIGlzIGluIHRoZSB1cmwgYW5kIG5vdCBiYXNlIG9uIHRoZSBvcmlnaW5hbCB1cmxgLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaW5jb21pbmdVcmwgPSAnL3Nlc3Npb24vODJhOWI3ZGEtZmFhZi00YTFkLThlZjMtNWU0ZmI1ODEyMjAwL2Nvb2tpZS9zZXNzaW9uLXNvbWV0aGluZy1vci1vdGhlcic7XG4gICAgICBsZXQgaiA9IGNyZWF0ZUpXUHJveHkoe3Nlc3Npb25JZDogJ2JhcmJheid9KTtcbiAgICAgIGxldCBwcm94eVVybCA9IGouZ2V0VXJsRm9yUHJveHkoaW5jb21pbmdVcmwpO1xuICAgICAgcHJveHlVcmwuc2hvdWxkLmVxdWFsKGNyZWF0ZVRlc3RVUkwoJ2JhcmJheicsICdjb29raWUvc2Vzc2lvbi1zb21ldGhpbmctb3Itb3RoZXInKSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBlcnJvciBzZXNzaW9uIGNvbW1hbmRzIHdpdGhvdXQgL3Nlc3Npb24gd2l0aG91dCBzZXNzaW9uIGlkJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGluY29taW5nVXJsID0gJy9lbGVtZW50JztcbiAgICAgIGxldCBqID0gY3JlYXRlSldQcm94eSgpO1xuICAgICAgKCgpID0+IHsgai5nZXRVcmxGb3JQcm94eShpbmNvbWluZ1VybCk7IH0pLnNob3VsZC50aHJvdygnc2Vzc2lvbiBpZCcpO1xuICAgIH0pO1xuICB9KTtcblxufSk7XG4iXX0=