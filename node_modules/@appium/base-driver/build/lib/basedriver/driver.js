"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.BaseDriverCore = exports.BaseDriver = void 0;

require("source-map-support/register");

var _core = require("./core");

var _support = require("@appium/support");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _capabilities = require("../helpers/capabilities");

var _protocol = require("../protocol");

var _capabilities2 = require("./capabilities");

var _commands = require("./commands");

var _helpers = _interopRequireDefault(require("./helpers"));

const EVENT_SESSION_INIT = 'newSessionRequested';
const EVENT_SESSION_START = 'newSessionStarted';
const EVENT_SESSION_QUIT_START = 'quitSessionRequested';
const EVENT_SESSION_QUIT_DONE = 'quitSessionFinished';
const ON_UNEXPECTED_SHUTDOWN_EVENT = 'onUnexpectedShutdown';

class BaseDriverCore extends _core.DriverCore {
  cliArgs;

  async executeCommand(cmd, ...args) {
    let startTime = Date.now();

    if (cmd === 'createSession') {
      this.protocol = (0, _protocol.determineProtocol)(args);
      this.logEvent(EVENT_SESSION_INIT);
    } else if (cmd === _protocol.DELETE_SESSION_COMMAND) {
      this.logEvent(EVENT_SESSION_QUIT_START);
    }

    await this.clearNewCommandTimeout();

    if (this.shutdownUnexpectedly) {
      throw new _protocol.errors.NoSuchDriverError('The driver was unexpectedly shut down!');
    }

    if (!this[cmd]) {
      throw new _protocol.errors.NotYetImplementedError();
    }

    let unexpectedShutdownListener;

    const commandExecutor = async () => await _bluebird.default.race([this[cmd](...args), new _bluebird.default((resolve, reject) => {
      unexpectedShutdownListener = reject;
      this.eventEmitter.on(ON_UNEXPECTED_SHUTDOWN_EVENT, unexpectedShutdownListener);
    })]).finally(() => {
      if (unexpectedShutdownListener) {
        this.eventEmitter.removeListener(ON_UNEXPECTED_SHUTDOWN_EVENT, unexpectedShutdownListener);
        unexpectedShutdownListener = null;
      }
    });

    const res = this.isCommandsQueueEnabled ? await this.commandsQueueGuard.acquire(BaseDriver.name, commandExecutor) : await commandExecutor();

    if (this.isCommandsQueueEnabled && cmd !== _protocol.DELETE_SESSION_COMMAND) {
      await this.startNewCommandTimeout();
    }

    const endTime = Date.now();

    this._eventHistory.commands.push({
      cmd,
      startTime,
      endTime
    });

    if (cmd === 'createSession') {
      this.logEvent(EVENT_SESSION_START);
    } else if (cmd === _protocol.DELETE_SESSION_COMMAND) {
      this.logEvent(EVENT_SESSION_QUIT_DONE);
    }

    return res;
  }

  async startUnexpectedShutdown(err = new _protocol.errors.NoSuchDriverError('The driver was unexpectedly shut down!')) {
    this.eventEmitter.emit(ON_UNEXPECTED_SHUTDOWN_EVENT, err);
    this.shutdownUnexpectedly = true;

    try {
      if (this.sessionId !== null) {
        await this.deleteSession(this.sessionId);
      }
    } finally {
      this.shutdownUnexpectedly = false;
    }
  }

  async startNewCommandTimeout() {
    await this.clearNewCommandTimeout();
    if (!this.newCommandTimeoutMs) return;
    this.noCommandTimer = setTimeout(async () => {
      this.log.warn(`Shutting down because we waited ` + `${this.newCommandTimeoutMs / 1000.0} seconds for a command`);
      const errorMessage = `New Command Timeout of ` + `${this.newCommandTimeoutMs / 1000.0} seconds ` + `expired. Try customizing the timeout using the ` + `'newCommandTimeout' desired capability`;
      await this.startUnexpectedShutdown(new Error(errorMessage));
    }, this.newCommandTimeoutMs);
  }

  assignServer(server, host, port, path) {
    this.server = server;
    this.serverHost = host;
    this.serverPort = port;
    this.serverPath = path;
  }

  async reset() {
    this.log.debug('Resetting app mid-session');
    this.log.debug('Running generic full reset');
    let currentConfig = {};

    for (let property of ['implicitWaitMs', 'newCommandTimeoutMs', 'sessionId', 'resetOnUnexpectedShutdown']) {
      currentConfig[property] = this[property];
    }

    this.resetOnUnexpectedShutdown = () => {};

    try {
      if (this.sessionId !== null) {
        await this.deleteSession(this.sessionId);
      }

      this.log.debug('Restarting app');
      await this.createSession(this.originalCaps);
    } finally {
      for (let [key, value] of _lodash.default.toPairs(currentConfig)) {
        this[key] = value;
      }
    }

    await this.clearNewCommandTimeout();
  }

  async createSession(w3cCapabilities1, w3cCapabilities2, w3cCapabilities, driverData) {
    if (this.sessionId !== null) {
      throw new _protocol.errors.SessionNotCreatedError('Cannot create a new session while one is in progress');
    }

    this.log.debug();

    const originalCaps = _lodash.default.cloneDeep([w3cCapabilities, w3cCapabilities1, w3cCapabilities2].find(_capabilities.isW3cCaps));

    if (!originalCaps) {
      throw new _protocol.errors.SessionNotCreatedError('Appium only supports W3C-style capability objects. ' + 'Your client is sending an older capabilities format. Please update your client library.');
    }

    this.setProtocolW3C();
    this.originalCaps = _lodash.default.cloneDeep(originalCaps);
    this.log.debug(`Creating session with W3C capabilities: ${JSON.stringify(originalCaps, null, 2)}`);
    let caps;

    try {
      caps = (0, _capabilities2.processCapabilities)(originalCaps, this.desiredCapConstraints, this.shouldValidateCaps);

      if (caps[_capabilities2.APPIUM_OPTS_CAP]) {
        this.log.debug(`Found ${_capabilities2.PREFIXED_APPIUM_OPTS_CAP} capability present; will promote items inside to caps`);
        caps = (0, _capabilities2.promoteAppiumOptions)(caps);
      }

      caps = (0, _capabilities.fixCaps)(caps, this.desiredCapConstraints, this.log);
    } catch (e) {
      throw new _protocol.errors.SessionNotCreatedError(e.message);
    }

    this.validateDesiredCaps(caps);
    this.sessionId = _support.util.uuidV4();
    this.caps = caps;
    this.opts = _lodash.default.cloneDeep(this.initialOpts);
    Object.assign(this.opts, this.caps);

    if (this.opts.noReset && this.opts.fullReset) {
      throw new Error("The 'noReset' and 'fullReset' capabilities are mutually " + 'exclusive and should not both be set to true. You ' + "probably meant to just use 'fullReset' on its own");
    }

    if (this.opts.noReset === true) {
      this.opts.fullReset = false;
    }

    if (this.opts.fullReset === true) {
      this.opts.noReset = false;
    }

    this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
    this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

    if (typeof this.opts.app === 'string' && this.opts.app.trim() === '') {
      delete this.opts.app;
    }

    if (!_lodash.default.isUndefined(this.caps.newCommandTimeout)) {
      this.newCommandTimeoutMs = this.caps.newCommandTimeout * 1000;
    }

    this._log.prefix = _helpers.default.generateDriverLogPrefix(this, this.sessionId);
    this.log.info(`Session created with session id: ${this.sessionId}`);
    return [this.sessionId, caps];
  }

  async deleteSession(sessionId, driverData) {
    await this.clearNewCommandTimeout();

    if (this.isCommandsQueueEnabled && this.commandsQueueGuard.isBusy()) {
      for (const key of _lodash.default.keys(this.commandsQueueGuard.queues)) {
        this.commandsQueueGuard.queues[key] = [];
      }
    }

    this.sessionId = null;
    this._log.prefix = _helpers.default.generateDriverLogPrefix(this);
  }

}

exports.BaseDriverCore = BaseDriverCore;

class BaseDriver extends (0, _commands.createBaseDriverClass)(BaseDriverCore) {}

exports.BaseDriver = BaseDriver;
var _default = BaseDriver;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9iYXNlZHJpdmVyL2RyaXZlci5qcyJdLCJuYW1lcyI6WyJFVkVOVF9TRVNTSU9OX0lOSVQiLCJFVkVOVF9TRVNTSU9OX1NUQVJUIiwiRVZFTlRfU0VTU0lPTl9RVUlUX1NUQVJUIiwiRVZFTlRfU0VTU0lPTl9RVUlUX0RPTkUiLCJPTl9VTkVYUEVDVEVEX1NIVVRET1dOX0VWRU5UIiwiQmFzZURyaXZlckNvcmUiLCJEcml2ZXJDb3JlIiwiY2xpQXJncyIsImV4ZWN1dGVDb21tYW5kIiwiY21kIiwiYXJncyIsInN0YXJ0VGltZSIsIkRhdGUiLCJub3ciLCJwcm90b2NvbCIsImxvZ0V2ZW50IiwiREVMRVRFX1NFU1NJT05fQ09NTUFORCIsImNsZWFyTmV3Q29tbWFuZFRpbWVvdXQiLCJzaHV0ZG93blVuZXhwZWN0ZWRseSIsImVycm9ycyIsIk5vU3VjaERyaXZlckVycm9yIiwiTm90WWV0SW1wbGVtZW50ZWRFcnJvciIsInVuZXhwZWN0ZWRTaHV0ZG93bkxpc3RlbmVyIiwiY29tbWFuZEV4ZWN1dG9yIiwiQiIsInJhY2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXZlbnRFbWl0dGVyIiwib24iLCJmaW5hbGx5IiwicmVtb3ZlTGlzdGVuZXIiLCJyZXMiLCJpc0NvbW1hbmRzUXVldWVFbmFibGVkIiwiY29tbWFuZHNRdWV1ZUd1YXJkIiwiYWNxdWlyZSIsIkJhc2VEcml2ZXIiLCJuYW1lIiwic3RhcnROZXdDb21tYW5kVGltZW91dCIsImVuZFRpbWUiLCJfZXZlbnRIaXN0b3J5IiwiY29tbWFuZHMiLCJwdXNoIiwic3RhcnRVbmV4cGVjdGVkU2h1dGRvd24iLCJlcnIiLCJlbWl0Iiwic2Vzc2lvbklkIiwiZGVsZXRlU2Vzc2lvbiIsIm5ld0NvbW1hbmRUaW1lb3V0TXMiLCJub0NvbW1hbmRUaW1lciIsInNldFRpbWVvdXQiLCJsb2ciLCJ3YXJuIiwiZXJyb3JNZXNzYWdlIiwiRXJyb3IiLCJhc3NpZ25TZXJ2ZXIiLCJzZXJ2ZXIiLCJob3N0IiwicG9ydCIsInBhdGgiLCJzZXJ2ZXJIb3N0Iiwic2VydmVyUG9ydCIsInNlcnZlclBhdGgiLCJyZXNldCIsImRlYnVnIiwiY3VycmVudENvbmZpZyIsInByb3BlcnR5IiwicmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biIsImNyZWF0ZVNlc3Npb24iLCJvcmlnaW5hbENhcHMiLCJrZXkiLCJ2YWx1ZSIsIl8iLCJ0b1BhaXJzIiwidzNjQ2FwYWJpbGl0aWVzMSIsInczY0NhcGFiaWxpdGllczIiLCJ3M2NDYXBhYmlsaXRpZXMiLCJkcml2ZXJEYXRhIiwiU2Vzc2lvbk5vdENyZWF0ZWRFcnJvciIsImNsb25lRGVlcCIsImZpbmQiLCJpc1czY0NhcHMiLCJzZXRQcm90b2NvbFczQyIsIkpTT04iLCJzdHJpbmdpZnkiLCJjYXBzIiwiZGVzaXJlZENhcENvbnN0cmFpbnRzIiwic2hvdWxkVmFsaWRhdGVDYXBzIiwiQVBQSVVNX09QVFNfQ0FQIiwiUFJFRklYRURfQVBQSVVNX09QVFNfQ0FQIiwiZSIsIm1lc3NhZ2UiLCJ2YWxpZGF0ZURlc2lyZWRDYXBzIiwidXRpbCIsInV1aWRWNCIsIm9wdHMiLCJpbml0aWFsT3B0cyIsIk9iamVjdCIsImFzc2lnbiIsIm5vUmVzZXQiLCJmdWxsUmVzZXQiLCJmYXN0UmVzZXQiLCJza2lwVW5pbnN0YWxsIiwiYXBwIiwidHJpbSIsImlzVW5kZWZpbmVkIiwibmV3Q29tbWFuZFRpbWVvdXQiLCJfbG9nIiwicHJlZml4IiwiaGVscGVycyIsImdlbmVyYXRlRHJpdmVyTG9nUHJlZml4IiwiaW5mbyIsImlzQnVzeSIsImtleXMiLCJxdWV1ZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBTUE7O0FBQ0E7O0FBRUEsTUFBTUEsa0JBQWtCLEdBQUcscUJBQTNCO0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUcsbUJBQTVCO0FBQ0EsTUFBTUMsd0JBQXdCLEdBQUcsc0JBQWpDO0FBQ0EsTUFBTUMsdUJBQXVC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Z0Isc0JBQUwsSUFBK0IsS0FBS0Msa0JBQUwsQ0FBd0I4RSxNQUF4QixFQUFuQyxFQUFxRTtBQUduRSxXQUFLLE1BQU0xQyxHQUFYLElBQWtCRSxnQkFBRXlDLElBQUYsQ0FBTyxLQUFLL0Usa0JBQUwsQ0FBd0JnRixNQUEvQixDQUFsQixFQUEwRDtBQUV4RCxhQUFLaEYsa0JBQUwsQ0FBd0JnRixNQUF4QixDQUErQjVDLEdBQS9CLElBQXNDLEVBQXRDO0FBQ0Q7QUFDRjs7QUFDRCxTQUFLeEIsU0FBTCxHQUFpQixJQUFqQjtBQUNBLFNBQUs2RCxJQUFMLENBQVVDLE1BQVYsR0FBbUJDLGlCQUFRQyx1QkFBUixDQUFnQyxJQUFoQyxDQUFuQjtBQUNEOztBQXRUNEM7Ozs7QUE2VC9DLE1BQU0xRSxVQUFOLFNBQXlCLHFDQUFzQi9CLGNBQXRCLENBQXpCLENBQStEOzs7ZUFFaEQrQixVIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQHRzLWNoZWNrXG4vKiBlc2xpbnQtZGlzYWJsZSByZXF1aXJlLWF3YWl0ICovXG4vKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyAqL1xuXG5pbXBvcnQgeyBEcml2ZXJDb3JlIH0gZnJvbSAnLi9jb3JlJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZpeENhcHMsIGlzVzNjQ2FwcyB9IGZyb20gJy4uL2hlbHBlcnMvY2FwYWJpbGl0aWVzJztcbmltcG9ydCB7IERFTEVURV9TRVNTSU9OX0NPTU1BTkQsIGRldGVybWluZVByb3RvY29sLCBlcnJvcnMgfSBmcm9tICcuLi9wcm90b2NvbCc7XG5pbXBvcnQge1xuICBBUFBJVU1fT1BUU19DQVAsXG4gIFBSRUZJWEVEX0FQUElVTV9PUFRTX0NBUCxcbiAgcHJvY2Vzc0NhcGFiaWxpdGllcyxcbiAgcHJvbW90ZUFwcGl1bU9wdGlvbnNcbn0gZnJvbSAnLi9jYXBhYmlsaXRpZXMnO1xuaW1wb3J0IHsgY3JlYXRlQmFzZURyaXZlckNsYXNzIH0gZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgaGVscGVycyBmcm9tICcuL2hlbHBlcnMnO1xuXG5jb25zdCBFVkVOVF9TRVNTSU9OX0lOSVQgPSAnbmV3U2Vzc2lvblJlcXVlc3RlZCc7XG5jb25zdCBFVkVOVF9TRVNTSU9OX1NUQVJUID0gJ25ld1Nlc3Npb25TdGFydGVkJztcbmNvbnN0IEVWRU5UX1NFU1NJT05fUVVJVF9TVEFSVCA9ICdxdWl0U2Vzc2lvblJlcXVlc3RlZCc7XG5jb25zdCBFVkVOVF9TRVNTSU9OX1FVSVRfRE9ORSA9ICdxdWl0U2Vzc2lvbkZpbmlzaGVkJztcbmNvbnN0IE9OX1VORVhQRUNURURfU0hVVERPV05fRVZFTlQgPSAnb25VbmV4cGVjdGVkU2h1dGRvd24nO1xuXG5cbi8qKlxuICogQGltcGxlbWVudHMge1Nlc3Npb25IYW5kbGVyfVxuICovXG5leHBvcnQgY2xhc3MgQmFzZURyaXZlckNvcmUgZXh0ZW5kcyBEcml2ZXJDb3JlIHtcblxuICAvKiogQHR5cGUge1JlY29yZDxzdHJpbmcsYW55Pnx1bmRlZmluZWR9ICovXG4gIGNsaUFyZ3M7XG5cbiAgLy8gVGhpcyBpcyB0aGUgbWFpbiBjb21tYW5kIGhhbmRsZXIgZm9yIHRoZSBkcml2ZXIuIEl0IHdyYXBzIGNvbW1hbmRcbiAgLy8gZXhlY3V0aW9uIHdpdGggdGltZW91dCBsb2dpYywgY2hlY2tpbmcgdGhhdCB3ZSBoYXZlIGEgdmFsaWQgc2Vzc2lvbixcbiAgLy8gYW5kIGVuc3VyaW5nIHRoYXQgd2UgZXhlY3V0ZSBjb21tYW5kcyBvbmUgYXQgYSB0aW1lLiBUaGlzIG1ldGhvZCBpcyBjYWxsZWRcbiAgLy8gYnkgTUpTT05XUCdzIGV4cHJlc3Mgcm91dGVyLlxuICAvKipcbiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbWRcbiAgICAqIEBwYXJhbSAgey4uLmFueVtdfSBhcmdzXG4gICAgKiBAcmV0dXJucyB7UHJvbWlzZTxhbnk+fVxuICAgICovXG4gIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjbWQsIC4uLmFyZ3MpIHtcbiAgICAvLyBnZXQgc3RhcnQgdGltZSBmb3IgdGhpcyBjb21tYW5kLCBhbmQgbG9nIGluIHNwZWNpYWwgY2FzZXNcbiAgICBsZXQgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgIGlmIChjbWQgPT09ICdjcmVhdGVTZXNzaW9uJykge1xuICAgICAgLy8gSWYgY3JlYXRpbmcgYSBzZXNzaW9uIGRldGVybWluZSBpZiBXM0Mgb3IgTUpTT05XUCBwcm90b2NvbCB3YXMgcmVxdWVzdGVkIGFuZCByZW1lbWJlciB0aGUgY2hvaWNlXG4gICAgICB0aGlzLnByb3RvY29sID0gZGV0ZXJtaW5lUHJvdG9jb2woYXJncyk7XG4gICAgICB0aGlzLmxvZ0V2ZW50KEVWRU5UX1NFU1NJT05fSU5JVCk7XG4gICAgfSBlbHNlIGlmIChjbWQgPT09IERFTEVURV9TRVNTSU9OX0NPTU1BTkQpIHtcbiAgICAgIHRoaXMubG9nRXZlbnQoRVZFTlRfU0VTU0lPTl9RVUlUX1NUQVJUKTtcbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBoYWQgYSBjb21tYW5kIHRpbWVyIHJ1bm5pbmcsIGNsZWFyIGl0IG5vdyB0aGF0IHdlJ3JlIHN0YXJ0aW5nXG4gICAgLy8gYSBuZXcgY29tbWFuZCBhbmQgc28gZG9uJ3Qgd2FudCB0byB0aW1lIG91dFxuICAgIGF3YWl0IHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuXG4gICAgaWYgKHRoaXMuc2h1dGRvd25VbmV4cGVjdGVkbHkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRHJpdmVyRXJyb3IoXG4gICAgICAgICAgJ1RoZSBkcml2ZXIgd2FzIHVuZXhwZWN0ZWRseSBzaHV0IGRvd24hJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSB0aGlzIGNvbW1hbmQsIGl0IG11c3Qgbm90IGJlIGltcGxlbWVudGVkXG4gICAgaWYgKCF0aGlzW2NtZF0pIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICAgIH1cblxuICAgIGxldCB1bmV4cGVjdGVkU2h1dGRvd25MaXN0ZW5lcjtcbiAgICBjb25zdCBjb21tYW5kRXhlY3V0b3IgPSBhc3luYyAoKSA9PlxuICAgICAgYXdhaXQgQi5yYWNlKFtcbiAgICAgICAgdGhpc1tjbWRdKC4uLmFyZ3MpLFxuICAgICAgICBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgdW5leHBlY3RlZFNodXRkb3duTGlzdGVuZXIgPSByZWplY3Q7XG4gICAgICAgICAgdGhpcy5ldmVudEVtaXR0ZXIub24oXG4gICAgICAgICAgICAgIE9OX1VORVhQRUNURURfU0hVVERPV05fRVZFTlQsXG4gICAgICAgICAgICAgIHVuZXhwZWN0ZWRTaHV0ZG93bkxpc3RlbmVyLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICAgXSkuZmluYWxseSgoKSA9PiB7XG4gICAgICAgIGlmICh1bmV4cGVjdGVkU2h1dGRvd25MaXN0ZW5lcikge1xuICAgICAgICAgIC8vIFRoaXMgaXMgbmVlZGVkIHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzXG4gICAgICAgICAgdGhpcy5ldmVudEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoXG4gICAgICAgICAgICAgIE9OX1VORVhQRUNURURfU0hVVERPV05fRVZFTlQsXG4gICAgICAgICAgICAgIHVuZXhwZWN0ZWRTaHV0ZG93bkxpc3RlbmVyLFxuICAgICAgICAgICk7XG4gICAgICAgICAgdW5leHBlY3RlZFNodXRkb3duTGlzdGVuZXIgPSBudWxsO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICBjb25zdCByZXMgPSB0aGlzLmlzQ29tbWFuZHNRdWV1ZUVuYWJsZWRcbiAgICAgID8gYXdhaXQgdGhpcy5jb21tYW5kc1F1ZXVlR3VhcmQuYWNxdWlyZShCYXNlRHJpdmVyLm5hbWUsIGNvbW1hbmRFeGVjdXRvcilcbiAgICAgIDogYXdhaXQgY29tbWFuZEV4ZWN1dG9yKCk7XG5cbiAgICAvLyBpZiB3ZSBoYXZlIHNldCBhIG5ldyBjb21tYW5kIHRpbWVvdXQgKHdoaWNoIGlzIHRoZSBkZWZhdWx0KSwgc3RhcnQgYVxuICAgIC8vIHRpbWVyIG9uY2Ugd2UndmUgZmluaXNoZWQgZXhlY3V0aW5nIHRoaXMgY29tbWFuZC4gSWYgd2UgZG9uJ3QgY2xlYXJcbiAgICAvLyB0aGUgdGltZXIgKHdoaWNoIGlzIGRvbmUgd2hlbiBhIG5ldyBjb21tYW5kIGNvbWVzIGluKSwgd2Ugd2lsbCB0cmlnZ2VyXG4gICAgLy8gYXV0b21hdGljIHNlc3Npb24gZGVsZXRpb24gaW4gdGhpcy5vbkNvbW1hbmRUaW1lb3V0LiBPZiBjb3Vyc2Ugd2UgZG9uJ3RcbiAgICAvLyB3YW50IHRvIHRyaWdnZXIgdGhlIHRpbWVyIHdoZW4gdGhlIHVzZXIgaXMgc2h1dHRpbmcgZG93biB0aGUgc2Vzc2lvblxuICAgIC8vIGludGVudGlvbmFsbHlcbiAgICBpZiAodGhpcy5pc0NvbW1hbmRzUXVldWVFbmFibGVkICYmIGNtZCAhPT0gREVMRVRFX1NFU1NJT05fQ09NTUFORCkge1xuICAgICAgLy8gcmVzZXR0aW5nIGV4aXN0aW5nIHRpbWVvdXRcbiAgICAgIGF3YWl0IHRoaXMuc3RhcnROZXdDb21tYW5kVGltZW91dCgpO1xuICAgIH1cblxuICAgIC8vIGxvZyB0aW1pbmcgaW5mb3JtYXRpb24gYWJvdXQgdGhpcyBjb21tYW5kXG4gICAgY29uc3QgZW5kVGltZSA9IERhdGUubm93KCk7XG4gICAgdGhpcy5fZXZlbnRIaXN0b3J5LmNvbW1hbmRzLnB1c2goe2NtZCwgc3RhcnRUaW1lLCBlbmRUaW1lfSk7XG4gICAgaWYgKGNtZCA9PT0gJ2NyZWF0ZVNlc3Npb24nKSB7XG4gICAgICB0aGlzLmxvZ0V2ZW50KEVWRU5UX1NFU1NJT05fU1RBUlQpO1xuICAgIH0gZWxzZSBpZiAoY21kID09PSBERUxFVEVfU0VTU0lPTl9DT01NQU5EKSB7XG4gICAgICB0aGlzLmxvZ0V2ZW50KEVWRU5UX1NFU1NJT05fUVVJVF9ET05FKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgLyoqXG4gICAgKlxuICAgICogQHBhcmFtIHtFcnJvcn0gZXJyXG4gICAgKi9cbiAgYXN5bmMgc3RhcnRVbmV4cGVjdGVkU2h1dGRvd24gKFxuICAgIGVyciA9IG5ldyBlcnJvcnMuTm9TdWNoRHJpdmVyRXJyb3IoXG4gICAgICAgICdUaGUgZHJpdmVyIHdhcyB1bmV4cGVjdGVkbHkgc2h1dCBkb3duIScsXG4gICAgKSxcbiAgKSB7XG4gICAgdGhpcy5ldmVudEVtaXR0ZXIuZW1pdChPTl9VTkVYUEVDVEVEX1NIVVRET1dOX0VWRU5ULCBlcnIpOyAvLyBhbGxvdyBvdGhlcnMgdG8gbGlzdGVuIGZvciB0aGlzXG4gICAgdGhpcy5zaHV0ZG93blVuZXhwZWN0ZWRseSA9IHRydWU7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLnNlc3Npb25JZCAhPT0gbnVsbCkge1xuICAgICAgICBhd2FpdCB0aGlzLmRlbGV0ZVNlc3Npb24odGhpcy5zZXNzaW9uSWQpO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLnNodXRkb3duVW5leHBlY3RlZGx5ID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RhcnROZXdDb21tYW5kVGltZW91dCAoKSB7XG4gICAgLy8gbWFrZSBzdXJlIHRoZXJlIGFyZSBubyByb2d1ZSB0aW1lb3V0c1xuICAgIGF3YWl0IHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuXG4gICAgLy8gaWYgY29tbWFuZCB0aW1lb3V0IGlzIDAsIGl0IGlzIGRpc2FibGVkXG4gICAgaWYgKCF0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMpIHJldHVybjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuXG4gICAgdGhpcy5ub0NvbW1hbmRUaW1lciA9IHNldFRpbWVvdXQoYXN5bmMgKCkgPT4ge1xuICAgICAgdGhpcy5sb2cud2FybihcbiAgICAgICAgYFNodXR0aW5nIGRvd24gYmVjYXVzZSB3ZSB3YWl0ZWQgYCArXG4gICAgICAgICAgYCR7dGhpcy5uZXdDb21tYW5kVGltZW91dE1zIC8gMTAwMC4wfSBzZWNvbmRzIGZvciBhIGNvbW1hbmRgLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9XG4gICAgICAgIGBOZXcgQ29tbWFuZCBUaW1lb3V0IG9mIGAgK1xuICAgICAgICBgJHt0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMgLyAxMDAwLjB9IHNlY29uZHMgYCArXG4gICAgICAgIGBleHBpcmVkLiBUcnkgY3VzdG9taXppbmcgdGhlIHRpbWVvdXQgdXNpbmcgdGhlIGAgK1xuICAgICAgICBgJ25ld0NvbW1hbmRUaW1lb3V0JyBkZXNpcmVkIGNhcGFiaWxpdHlgO1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFVuZXhwZWN0ZWRTaHV0ZG93bihuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKSk7XG4gICAgfSwgdGhpcy5uZXdDb21tYW5kVGltZW91dE1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0ge2ltcG9ydCgnQGFwcGl1bS90eXBlcycpLkFwcGl1bVNlcnZlcn0gc2VydmVyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBob3N0XG4gICAqIEBwYXJhbSB7bnVtYmVyfSBwb3J0XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoXG4gICAqL1xuICBhc3NpZ25TZXJ2ZXIgKHNlcnZlciwgaG9zdCwgcG9ydCwgcGF0aCkge1xuICAgIHRoaXMuc2VydmVyID0gc2VydmVyO1xuICAgIHRoaXMuc2VydmVySG9zdCA9IGhvc3Q7XG4gICAgdGhpcy5zZXJ2ZXJQb3J0ID0gcG9ydDtcbiAgICB0aGlzLnNlcnZlclBhdGggPSBwYXRoO1xuICB9XG5cbiAgLypcbiAgICAqIFJlc3RhcnQgdGhlIHNlc3Npb24gd2l0aCB0aGUgb3JpZ2luYWwgY2FwcyxcbiAgICAqIHByZXNlcnZpbmcgdGhlIHRpbWVvdXQgY29uZmlnLlxuICAgICovXG4gIGFzeW5jIHJlc2V0ICgpIHtcbiAgICB0aGlzLmxvZy5kZWJ1ZygnUmVzZXR0aW5nIGFwcCBtaWQtc2Vzc2lvbicpO1xuICAgIHRoaXMubG9nLmRlYnVnKCdSdW5uaW5nIGdlbmVyaWMgZnVsbCByZXNldCcpO1xuXG4gICAgLy8gcHJlc2VydmluZyBzdGF0ZVxuICAgIGxldCBjdXJyZW50Q29uZmlnID0ge307XG4gICAgZm9yIChsZXQgcHJvcGVydHkgb2YgW1xuICAgICAgJ2ltcGxpY2l0V2FpdE1zJyxcbiAgICAgICduZXdDb21tYW5kVGltZW91dE1zJyxcbiAgICAgICdzZXNzaW9uSWQnLFxuICAgICAgJ3Jlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24nLFxuICAgIF0pIHtcbiAgICAgIGN1cnJlbnRDb25maWdbcHJvcGVydHldID0gdGhpc1twcm9wZXJ0eV07XG4gICAgfVxuXG4gICAgLy8gV2UgYWxzbyBuZWVkIHRvIHByZXNlcnZlIHRoZSB1bmV4cGVjdGVkIHNodXRkb3duLCBhbmQgbWFrZSBzdXJlIGl0IGlzIG5vdCBjYW5jZWxsZWQgZHVyaW5nIHJlc2V0LlxuICAgIHRoaXMucmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biA9ICgpID0+IHt9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLnNlc3Npb25JZCAhPT0gbnVsbCkge1xuICAgICAgICBhd2FpdCB0aGlzLmRlbGV0ZVNlc3Npb24odGhpcy5zZXNzaW9uSWQpO1xuICAgICAgfVxuICAgICAgdGhpcy5sb2cuZGVidWcoJ1Jlc3RhcnRpbmcgYXBwJyk7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZVNlc3Npb24odGhpcy5vcmlnaW5hbENhcHMpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICAvLyBhbHdheXMgcmVzdG9yZSBzdGF0ZS5cbiAgICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoY3VycmVudENvbmZpZykpIHtcbiAgICAgICAgdGhpc1trZXldID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuICB9XG5cbiAgLyoqXG4gICAgICpcbiAgICAgKiBIaXN0b3JpY2FsbHkgdGhlIGZpcnN0IHR3byBhcmd1bWVudHMgd2VyZSByZXNlcnZlZCBmb3IgSlNPTldQIGNhcGFiaWxpdGllcy5cbiAgICAgKiBBcHBpdW0gMiBoYXMgZHJvcHBlZCB0aGUgc3VwcG9ydCBvZiB0aGVzZSwgc28gbm93IHdlIG9ubHkgYWNjZXB0IGNhcGFiaWxpdHlcbiAgICAgKiBvYmplY3RzIGluIFczQyBmb3JtYXQgYW5kIHRodXMgYWxsb3cgYW55IG9mIHRoZSB0aHJlZSBhcmd1bWVudHMgdG8gcmVwcmVzZW50XG4gICAgICogdGhlIGxhdHRlci5cbiAgICAgKiBAcGFyYW0ge1czQ0NhcGFiaWxpdGllc30gdzNjQ2FwYWJpbGl0aWVzMVxuICAgICAqIEBwYXJhbSB7VzNDQ2FwYWJpbGl0aWVzfSBbdzNjQ2FwYWJpbGl0aWVzMl1cbiAgICAgKiBAcGFyYW0ge1czQ0NhcGFiaWxpdGllc30gW3czY0NhcGFiaWxpdGllc11cbiAgICAgKiBAcGFyYW0ge0RyaXZlckRhdGFbXX0gW2RyaXZlckRhdGFdXG4gICAgICogQHJldHVybnMge1Byb21pc2U8W3N0cmluZyxvYmplY3RdPn1cbiAgICAgKi9cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbiAoXG4gICAgdzNjQ2FwYWJpbGl0aWVzMSxcbiAgICB3M2NDYXBhYmlsaXRpZXMyLFxuICAgIHczY0NhcGFiaWxpdGllcyxcbiAgICBkcml2ZXJEYXRhLFxuICApIHtcbiAgICBpZiAodGhpcy5zZXNzaW9uSWQgIT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuU2Vzc2lvbk5vdENyZWF0ZWRFcnJvcihcbiAgICAgICAgICAgJ0Nhbm5vdCBjcmVhdGUgYSBuZXcgc2Vzc2lvbiB3aGlsZSBvbmUgaXMgaW4gcHJvZ3Jlc3MnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZy5kZWJ1ZygpO1xuXG4gICAgY29uc3Qgb3JpZ2luYWxDYXBzID0gXy5jbG9uZURlZXAoW1xuICAgICAgdzNjQ2FwYWJpbGl0aWVzLFxuICAgICAgdzNjQ2FwYWJpbGl0aWVzMSxcbiAgICAgIHczY0NhcGFiaWxpdGllczIsXG4gICAgXS5maW5kKGlzVzNjQ2FwcykpO1xuICAgIGlmICghb3JpZ2luYWxDYXBzKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IoXG4gICAgICAgICAgICdBcHBpdW0gb25seSBzdXBwb3J0cyBXM0Mtc3R5bGUgY2FwYWJpbGl0eSBvYmplY3RzLiAnICtcbiAgICAgICAgICAgICAnWW91ciBjbGllbnQgaXMgc2VuZGluZyBhbiBvbGRlciBjYXBhYmlsaXRpZXMgZm9ybWF0LiBQbGVhc2UgdXBkYXRlIHlvdXIgY2xpZW50IGxpYnJhcnkuJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXRQcm90b2NvbFczQygpO1xuXG4gICAgdGhpcy5vcmlnaW5hbENhcHMgPSBfLmNsb25lRGVlcChvcmlnaW5hbENhcHMpO1xuICAgIHRoaXMubG9nLmRlYnVnKFxuICAgICAgYENyZWF0aW5nIHNlc3Npb24gd2l0aCBXM0MgY2FwYWJpbGl0aWVzOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBvcmlnaW5hbENhcHMsXG4gICAgICAgIG51bGwsXG4gICAgICAgIDIsXG4gICAgICApfWAsXG4gICAgKTtcblxuICAgIGxldCBjYXBzO1xuICAgIHRyeSB7XG4gICAgICBjYXBzID0gcHJvY2Vzc0NhcGFiaWxpdGllcyhcbiAgICAgICAgICAgb3JpZ2luYWxDYXBzLFxuICAgICAgICAgICB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyxcbiAgICAgICAgICAgdGhpcy5zaG91bGRWYWxpZGF0ZUNhcHMsXG4gICAgICApO1xuICAgICAgaWYgKGNhcHNbQVBQSVVNX09QVFNfQ0FQXSkge1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZyhcbiAgICAgICAgICAgICBgRm91bmQgJHtQUkVGSVhFRF9BUFBJVU1fT1BUU19DQVB9IGNhcGFiaWxpdHkgcHJlc2VudDsgd2lsbCBwcm9tb3RlIGl0ZW1zIGluc2lkZSB0byBjYXBzYCxcbiAgICAgICAgKTtcbiAgICAgICAgY2FwcyA9IHByb21vdGVBcHBpdW1PcHRpb25zKGNhcHMpO1xuICAgICAgfVxuICAgICAgY2FwcyA9IGZpeENhcHMoY2FwcywgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMsIHRoaXMubG9nKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IoZS5tZXNzYWdlKTtcbiAgICB9XG5cbiAgICB0aGlzLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG5cbiAgICB0aGlzLnNlc3Npb25JZCA9IHV0aWwudXVpZFY0KCk7XG4gICAgdGhpcy5jYXBzID0gY2FwcztcbiAgICB0aGlzLm9wdHMgPSBfLmNsb25lRGVlcCh0aGlzLmluaXRpYWxPcHRzKTtcblxuICAgIC8vIG1lcmdlIGNhcHMgb250byBvcHRzIHNvIHdlIGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgd2hhdCdzIHdoZXJlXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLm9wdHMsIHRoaXMuY2Fwcyk7XG5cbiAgICAvLyBkZWFsIHdpdGggcmVzZXRzXG4gICAgLy8gc29tZSBwZW9wbGUgbGlrZSB0byBkbyB3ZWlyZCB0aGluZ3MgYnkgc2V0dGluZyBub1Jlc2V0IGFuZCBmdWxsUmVzZXRcbiAgICAvLyBib3RoIHRvIHRydWUsIGJ1dCB0aGlzIGlzIG1pc2d1aWRlZCBhbmQgc3RyYW5nZSwgc28gZXJyb3IgaGVyZSBpbnN0ZWFkXG4gICAgaWYgKHRoaXMub3B0cy5ub1Jlc2V0ICYmIHRoaXMub3B0cy5mdWxsUmVzZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgXCJUaGUgJ25vUmVzZXQnIGFuZCAnZnVsbFJlc2V0JyBjYXBhYmlsaXRpZXMgYXJlIG11dHVhbGx5IFwiICtcbiAgICAgICAgICAgICAnZXhjbHVzaXZlIGFuZCBzaG91bGQgbm90IGJvdGggYmUgc2V0IHRvIHRydWUuIFlvdSAnICtcbiAgICAgICAgICAgICBcInByb2JhYmx5IG1lYW50IHRvIGp1c3QgdXNlICdmdWxsUmVzZXQnIG9uIGl0cyBvd25cIixcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdHMubm9SZXNldCA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5vcHRzLmZ1bGxSZXNldCA9IGZhbHNlO1xuICAgIH1cbiAgICBpZiAodGhpcy5vcHRzLmZ1bGxSZXNldCA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5vcHRzLm5vUmVzZXQgPSBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5vcHRzLmZhc3RSZXNldCA9ICF0aGlzLm9wdHMuZnVsbFJlc2V0ICYmICF0aGlzLm9wdHMubm9SZXNldDtcbiAgICB0aGlzLm9wdHMuc2tpcFVuaW5zdGFsbCA9IHRoaXMub3B0cy5mYXN0UmVzZXQgfHwgdGhpcy5vcHRzLm5vUmVzZXQ7XG5cbiAgICAvLyBQcmV2ZW50cyBlbXB0eSBzdHJpbmcgY2FwcyBzbyB3ZSBkb24ndCBuZWVkIHRvIHRlc3QgaXQgZXZlcnl3aGVyZVxuICAgIGlmICh0eXBlb2YgdGhpcy5vcHRzLmFwcCA9PT0gJ3N0cmluZycgJiYgdGhpcy5vcHRzLmFwcC50cmltKCkgPT09ICcnKSB7XG4gICAgICBkZWxldGUgdGhpcy5vcHRzLmFwcDtcbiAgICB9XG5cbiAgICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5jYXBzLm5ld0NvbW1hbmRUaW1lb3V0KSkge1xuICAgICAgdGhpcy5uZXdDb21tYW5kVGltZW91dE1zID0gdGhpcy5jYXBzLm5ld0NvbW1hbmRUaW1lb3V0ICogMTAwMDtcbiAgICB9XG5cbiAgICB0aGlzLl9sb2cucHJlZml4ID0gaGVscGVycy5nZW5lcmF0ZURyaXZlckxvZ1ByZWZpeCh0aGlzLCB0aGlzLnNlc3Npb25JZCk7XG5cbiAgICB0aGlzLmxvZy5pbmZvKGBTZXNzaW9uIGNyZWF0ZWQgd2l0aCBzZXNzaW9uIGlkOiAke3RoaXMuc2Vzc2lvbklkfWApO1xuXG4gICAgcmV0dXJuIFt0aGlzLnNlc3Npb25JZCwgY2Fwc107XG4gIH1cblxuICAvKipcbiAgICAqXG4gICAgKiBAcGFyYW0ge3N0cmluZ30gW3Nlc3Npb25JZF1cbiAgICAqIEBwYXJhbSB7RHJpdmVyRGF0YVtdfSBbZHJpdmVyRGF0YV1cbiAgICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fVxuICAgICovXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKHNlc3Npb25JZCwgZHJpdmVyRGF0YSkge1xuICAgIGF3YWl0IHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuICAgIGlmICh0aGlzLmlzQ29tbWFuZHNRdWV1ZUVuYWJsZWQgJiYgdGhpcy5jb21tYW5kc1F1ZXVlR3VhcmQuaXNCdXN5KCkpIHtcbiAgICAgIC8vIHNpbXBsZSBoYWNrIHRvIHJlbGVhc2UgcGVuZGluZyBjb21tYW5kcyBpZiB0aGV5IGV4aXN0XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiBfLmtleXModGhpcy5jb21tYW5kc1F1ZXVlR3VhcmQucXVldWVzKSkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRoaXMuY29tbWFuZHNRdWV1ZUd1YXJkLnF1ZXVlc1trZXldID0gW107XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc2Vzc2lvbklkID0gbnVsbDtcbiAgICB0aGlzLl9sb2cucHJlZml4ID0gaGVscGVycy5nZW5lcmF0ZURyaXZlckxvZ1ByZWZpeCh0aGlzKTtcbiAgfVxufVxuXG4vKipcbiAqIFRoaXMgZW5zdXJlcyB0aGF0IGFsbCBvZiB0aGUgbWl4aW5zIGNvcnJlY3RseSBpbXBsZW1lbnQgdGhlIGludGVyZmFjZSBkZXNjcmliZWQgaW4ge0BsaW5rY29kZSBEcml2ZXJ9LlxuICogQGltcGxlbWVudHMge0RyaXZlcn1cbiAqL1xuY2xhc3MgQmFzZURyaXZlciBleHRlbmRzIGNyZWF0ZUJhc2VEcml2ZXJDbGFzcyhCYXNlRHJpdmVyQ29yZSkge31cbmV4cG9ydCB7IEJhc2VEcml2ZXIgfTtcbmV4cG9ydCBkZWZhdWx0IEJhc2VEcml2ZXI7XG5cbi8qKlxuICogQHR5cGVkZWYge2ltcG9ydCgnQGFwcGl1bS90eXBlcycpLkhUVFBNZXRob2R9IEhUVFBNZXRob2RcbiAqIEB0eXBlZGVmIHtpbXBvcnQoJ0BhcHBpdW0vdHlwZXMnKS5Ecml2ZXJ9IERyaXZlclxuICogQHR5cGVkZWYge2ltcG9ydCgnQGFwcGl1bS90eXBlcycpLkV4dGVybmFsRHJpdmVyfSBFeHRlcm5hbERyaXZlclxuICogQHR5cGVkZWYge2ltcG9ydCgnQGFwcGl1bS90eXBlcycpLkNhcGFiaWxpdGllc30gQ2FwYWJpbGl0aWVzXG4gKiBAdHlwZWRlZiB7aW1wb3J0KCdAYXBwaXVtL3R5cGVzJykuVzNDQ2FwYWJpbGl0aWVzfSBXM0NDYXBhYmlsaXRpZXNcbiAqIEB0eXBlZGVmIHtpbXBvcnQoJ0BhcHBpdW0vdHlwZXMnKS5Ecml2ZXJEYXRhfSBEcml2ZXJEYXRhXG4gKi9cblxuXG4vKipcbiAqIEBjYWxsYmFjayBVcGRhdGVTZXJ2ZXJDYWxsYmFja1xuICogQHBhcmFtIHtpbXBvcnQoJ2V4cHJlc3MnKS5FeHByZXNzfSBhcHAgLSBFeHByZXNzIGFwcFxuICogQHBhcmFtIHtpbXBvcnQoJ0BhcHBpdW0vdHlwZXMnKS5BcHBpdW1TZXJ2ZXJ9IGh0dHBTZXJ2ZXIgLSBIVFRQIHNlcnZlclxuICogQHJldHVybnMge2ltcG9ydCgndHlwZS1mZXN0JykuUHJvbWlzYWJsZTx2b2lkPn1cbiAqL1xuXG4vKipcbiAqIFRoaXMgaXMgdXNlZCB0byBleHRlbmQge0BsaW5rY29kZSBCYXNlRHJpdmVyQ29yZX0gYnkgdGhlIG1peGlucyBhbmQgYWxzbyBleHRlcm5hbCBkcml2ZXJzLlxuICogQHRlbXBsYXRlIFtQcm90bz17fV1cbiAqIEB0ZW1wbGF0ZSBbU3RhdGljPXt9XVxuICogQHR5cGVkZWYge2ltcG9ydCgnQGFwcGl1bS90eXBlcycpLkNsYXNzPEJhc2VEcml2ZXJDb3JlICYgUHJvdG8sQmFzZURyaXZlclN0YXRpYyAmIFN0YXRpYz59IEJhc2VEcml2ZXJCYXNlXG4gKi9cblxuLyoqXG4gKiBTdGF0aWMgcHJvcGVydGllcyBvZiBgQmFzZURyaXZlcmAgYW5kIG9wdGlvbmFsIHByb3BlcnRpZXMgZm9yIHN1YmNsYXNzZXMuXG4gKiBAdGVtcGxhdGUge0V4dGVybmFsRHJpdmVyfSBbVD1FeHRlcm5hbERyaXZlcl1cbiAqIEB0eXBlZGVmIEJhc2VEcml2ZXJTdGF0aWNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBiYXNlVmVyc2lvblxuICogQHByb3BlcnR5IHtVcGRhdGVTZXJ2ZXJDYWxsYmFja30gW3VwZGF0ZVNlcnZlcl1cbiAqIEBwcm9wZXJ0eSB7aW1wb3J0KCdAYXBwaXVtL3R5cGVzJykuTWV0aG9kTWFwPFQ+fSBbbmV3TWV0aG9kTWFwXVxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge2ltcG9ydCgnQGFwcGl1bS90eXBlcycpLlNlc3Npb25IYW5kbGVyPFtzdHJpbmcsIG9iamVjdF0sdm9pZD59IFNlc3Npb25IYW5kbGVyXG4gKi9cbiJdfQ==