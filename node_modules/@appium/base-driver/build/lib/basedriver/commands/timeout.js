"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.TimeoutMixin = TimeoutMixin;

require("source-map-support/register");

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

var _support = require("@appium/support");

var _protocol = require("../../protocol");

const MIN_TIMEOUT = 0;

function TimeoutMixin(Base) {
  class TimeoutCommands extends Base {
    async timeouts(type, ms, script, pageLoad, implicit) {
      if (_support.util.hasValue(type) && _support.util.hasValue(ms)) {
        this.log.debug(`MJSONWP timeout arguments: ${JSON.stringify({
          type,
          ms
        })}}`);

        switch (type) {
          case 'command':
            await this.newCommandTimeout(ms);
            return;

          case 'implicit':
            await this.implicitWaitMJSONWP(ms);
            return;

          case 'page load':
            await this.pageLoadTimeoutMJSONWP(ms);
            return;

          case 'script':
            await this.scriptTimeoutMJSONWP(ms);
            return;

          default:
            throw new Error(`'${type}' type is not supported for MJSONWP timeout`);
        }
      }

      this.log.debug(`W3C timeout argument: ${JSON.stringify({
        script,
        pageLoad,
        implicit
      })}}`);

      if (_support.util.hasValue(script)) {
        await this.scriptTimeoutW3C(script);
      }

      if (_support.util.hasValue(pageLoad)) {
        await this.pageLoadTimeoutW3C(pageLoad);
      }

      if (_support.util.hasValue(implicit)) {
        await this.implicitWaitW3C(implicit);
      }
    }

    async getTimeouts() {
      return {
        command: this.newCommandTimeoutMs,
        implicit: this.implicitWaitMs
      };
    }

    async implicitWaitW3C(ms) {
      await this.implicitWait(ms);
    }

    async implicitWaitMJSONWP(ms) {
      await this.implicitWait(ms);
    }

    async implicitWait(ms) {
      await this.setImplicitWait(this.parseTimeoutArgument(ms));
    }

    async pageLoadTimeoutW3C(ms) {
      throw new _protocol.errors.NotImplementedError('Not implemented yet for pageLoad.');
    }

    async pageLoadTimeoutMJSONWP(ms) {
      throw new _protocol.errors.NotImplementedError('Not implemented yet for pageLoad.');
    }

    async scriptTimeoutW3C(ms) {
      throw new _protocol.errors.NotImplementedError('Not implemented yet for script.');
    }

    async scriptTimeoutMJSONWP(ms) {
      throw new _protocol.errors.NotImplementedError('Not implemented yet for script.');
    }

    async newCommandTimeout(ms) {
      this.setNewCommandTimeout(this.parseTimeoutArgument(ms));
    }

    setImplicitWait(ms) {
      this.implicitWaitMs = ms;
      this.log.debug(`Set implicit wait to ${ms}ms`);

      if (this.managedDrivers && this.managedDrivers.length) {
        this.log.debug('Setting implicit wait on managed drivers');

        for (let driver of this.managedDrivers) {
          if (_lodash.default.isFunction(driver.setImplicitWait)) {
            driver.setImplicitWait(ms);
          }
        }
      }
    }

    setNewCommandTimeout(ms) {
      this.newCommandTimeoutMs = ms;
      this.log.debug(`Set new command timeout to ${ms}ms`);

      if (this.managedDrivers && this.managedDrivers.length) {
        this.log.debug('Setting new command timeout on managed drivers');

        for (let driver of this.managedDrivers) {
          if (_lodash.default.isFunction(driver.setNewCommandTimeout)) {
            driver.setNewCommandTimeout(ms);
          }
        }
      }
    }

    async implicitWaitForCondition(condFn) {
      this.log.debug(`Waiting up to ${this.implicitWaitMs} ms for condition`);

      let wrappedCondFn = async (...args) => {
        await this.clearNewCommandTimeout();
        return await condFn(...args);
      };

      return await (0, _asyncbox.waitForCondition)(wrappedCondFn, {
        waitMs: this.implicitWaitMs,
        intervalMs: 500,
        logger: this.log
      });
    }

    parseTimeoutArgument(ms) {
      let duration = parseInt(ms, 10);

      if (_lodash.default.isNaN(duration) || duration < MIN_TIMEOUT) {
        throw new _protocol.errors.UnknownError(`Invalid timeout value '${ms}'`);
      }

      return duration;
    }

  }

  return TimeoutCommands;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3RpbWVvdXQuanMiXSwibmFtZXMiOlsiTUlOX1RJTUVPVVQiLCJUaW1lb3V0TWl4aW4iLCJCYXNlIiwiVGltZW91dENvbW1hbmRzIiwidGltZW91dHMiLCJ0eXBlIiwibXMiLCJzY3JpcHQiLCJwYWdlTG9hZCIsImltcGxpY2l0IiwidXRpbCIsImhhc1ZhbHVlIiwibG9nIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5IiwibmV3Q29tbWFuZFRpbWVvdXQiLCJpbXBsaWNpdFdhaXRNSlNPTldQIiwicGFnZUxvYWRUaW1lb3V0TUpTT05XUCIsInNjcmlwdFRpbWVvdXRNSlNPTldQIiwiRXJyb3IiLCJzY3JpcHRUaW1lb3V0VzNDIiwicGFnZUxvYWRUaW1lb3V0VzNDIiwiaW1wbGljaXRXYWl0VzNDIiwiZ2V0VGltZW91dHMiLCJjb21tYW5kIiwibmV3Q29tbWFuZFRpbWVvdXRNcyIsImltcGxpY2l0V2FpdE1zIiwiaW1wbGljaXRXYWl0Iiwic2V0SW1wbGljaXRXYWl0IiwicGFyc2VUaW1lb3V0QXJndW1lbnQiLCJlcnJvcnMiLCJOb3RJbXBsZW1lbnRlZEVycm9yIiwic2V0TmV3Q29tbWFuZFRpbWVvdXQiLCJtYW5hZ2VkRHJpdmVycyIsImxlbmd0aCIsImRyaXZlciIsIl8iLCJpc0Z1bmN0aW9uIiwiaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uIiwiY29uZEZuIiwid3JhcHBlZENvbmRGbiIsImFyZ3MiLCJjbGVhck5ld0NvbW1hbmRUaW1lb3V0Iiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImxvZ2dlciIsImR1cmF0aW9uIiwicGFyc2VJbnQiLCJpc05hTiIsIlVua25vd25FcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFJQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxXQUFXLEdBQUcsQ0FBcEI7O0FBTU8sU0FBU0MsWUFBVCxDQUF1QkMsSUFBdkIsRUFBNkI7QUFLbEMs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QyxNQUFGLEVBQVU7QUFDdEMsV0FBSzVCLEdBQUwsQ0FBU0MsS0FBVCxDQUFnQixpQkFBZ0IsS0FBS2MsY0FBZSxtQkFBcEQ7O0FBQ0EsVUFBSWMsYUFBYSxHQUFHLE9BQU8sR0FBR0MsSUFBVixLQUFtQjtBQUVyQyxjQUFNLEtBQUtDLHNCQUFMLEVBQU47QUFFQSxlQUFPLE1BQU1ILE1BQU0sQ0FBQyxHQUFHRSxJQUFKLENBQW5CO0FBQ0QsT0FMRDs7QUFNQSxhQUFPLE1BQU0sZ0NBQWlCRCxhQUFqQixFQUFnQztBQUMzQ0csUUFBQUEsTUFBTSxFQUFFLEtBQUtqQixjQUQ4QjtBQUUzQ2tCLFFBQUFBLFVBQVUsRUFBRSxHQUYrQjtBQUczQ0MsUUFBQUEsTUFBTSxFQUFFLEtBQUtsQztBQUg4QixPQUFoQyxDQUFiO0FBS0Q7O0FBRURrQixJQUFBQSxvQkFBb0IsQ0FBRXhCLEVBQUYsRUFBTTtBQUN4QixVQUFJeUMsUUFBUSxHQUFHQyxRQUFRLENBQUMxQyxFQUFELEVBQUssRUFBTCxDQUF2Qjs7QUFDQSxVQUFJK0IsZ0JBQUVZLEtBQUYsQ0FBUUYsUUFBUixLQUFxQkEsUUFBUSxHQUFHL0MsV0FBcEMsRUFBaUQ7QUFDL0MsY0FBTSxJQUFJK0IsaUJBQU9tQixZQUFYLENBQXlCLDBCQUF5QjVDLEVBQUcsR0FBckQsQ0FBTjtBQUNEOztBQUNELGFBQU95QyxRQUFQO0FBQ0Q7O0FBeklnQzs7QUE0SW5DLFNBQU81QyxlQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtY2hlY2tcblxuLyogZXNsaW50LWRpc2FibGUgbm8tdW51c2VkLXZhcnMgKi9cbi8qIGVzbGludC1kaXNhYmxlIHJlcXVpcmUtYXdhaXQgKi9cbmltcG9ydCB7d2FpdEZvckNvbmRpdGlvbn0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7dXRpbH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7ZXJyb3JzfSBmcm9tICcuLi8uLi9wcm90b2NvbCc7XG5cbmNvbnN0IE1JTl9USU1FT1VUID0gMDtcblxuLyoqXG4gKiBAcGFyYW0ge2ltcG9ydCgnLi4vZHJpdmVyJykuQmFzZURyaXZlckJhc2V9IEJhc2VcbiAqIEByZXR1cm5zIHtUaW1lb3V0QmFzZX1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIFRpbWVvdXRNaXhpbiAoQmFzZSkge1xuXG4gIC8qKlxuICAgKiBAaW1wbGVtZW50cyB7SVRpbWVvdXRDb21tYW5kc31cbiAgICovXG4gIGNsYXNzIFRpbWVvdXRDb21tYW5kcyBleHRlbmRzIEJhc2Uge1xuICAgIGFzeW5jIHRpbWVvdXRzICh0eXBlLCBtcywgc2NyaXB0LCBwYWdlTG9hZCwgaW1wbGljaXQpIHtcbiAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKHR5cGUpICYmIHV0aWwuaGFzVmFsdWUobXMpKSB7XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKFxuICAgICAgICAgIGBNSlNPTldQIHRpbWVvdXQgYXJndW1lbnRzOiAke0pTT04uc3RyaW5naWZ5KHt0eXBlLCBtc30pfX1gLFxuICAgICAgICApO1xuXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgIGNhc2UgJ2NvbW1hbmQnOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5uZXdDb21tYW5kVGltZW91dChtcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgY2FzZSAnaW1wbGljaXQnOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRNSlNPTldQKG1zKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICBjYXNlICdwYWdlIGxvYWQnOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5wYWdlTG9hZFRpbWVvdXRNSlNPTldQKG1zKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICBjYXNlICdzY3JpcHQnOlxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zY3JpcHRUaW1lb3V0TUpTT05XUChtcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgYCcke3R5cGV9JyB0eXBlIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIE1KU09OV1AgdGltZW91dGAsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIE90aGVyd2lzZSBhc3N1bWUgaXQgaXMgVzNDIHByb3RvY29sXG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhcbiAgICAgICAgYFczQyB0aW1lb3V0IGFyZ3VtZW50OiAke0pTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBzY3JpcHQsXG4gICAgICAgICAgcGFnZUxvYWQsXG4gICAgICAgICAgaW1wbGljaXQsXG4gICAgICAgIH0pfX1gLFxuICAgICAgKTtcbiAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKHNjcmlwdCkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zY3JpcHRUaW1lb3V0VzNDKHNjcmlwdCk7XG4gICAgICB9XG4gICAgICBpZiAodXRpbC5oYXNWYWx1ZShwYWdlTG9hZCkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wYWdlTG9hZFRpbWVvdXRXM0MocGFnZUxvYWQpO1xuICAgICAgfVxuICAgICAgaWYgKHV0aWwuaGFzVmFsdWUoaW1wbGljaXQpKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0VzNDKGltcGxpY2l0KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBnZXRUaW1lb3V0cyAoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjb21tYW5kOiB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMsXG4gICAgICAgIGltcGxpY2l0OiB0aGlzLmltcGxpY2l0V2FpdE1zLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBpbXBsaWNpdFxuICAgIGFzeW5jIGltcGxpY2l0V2FpdFczQyAobXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0KG1zKTtcbiAgICB9XG5cbiAgICBhc3luYyBpbXBsaWNpdFdhaXRNSlNPTldQIChtcykge1xuICAgICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXQobXMpO1xuICAgIH1cblxuICAgIGFzeW5jIGltcGxpY2l0V2FpdCAobXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0SW1wbGljaXRXYWl0KHRoaXMucGFyc2VUaW1lb3V0QXJndW1lbnQobXMpKTtcbiAgICB9XG5cbiAgICAvLyBwYWdlTG9hZFxuICAgIGFzeW5jIHBhZ2VMb2FkVGltZW91dFczQyAobXMpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcignTm90IGltcGxlbWVudGVkIHlldCBmb3IgcGFnZUxvYWQuJyk7XG4gICAgfVxuXG4gICAgYXN5bmMgcGFnZUxvYWRUaW1lb3V0TUpTT05XUCAobXMpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcignTm90IGltcGxlbWVudGVkIHlldCBmb3IgcGFnZUxvYWQuJyk7XG4gICAgfVxuXG4gICAgLy8gc2NyaXB0XG4gICAgYXN5bmMgc2NyaXB0VGltZW91dFczQyAobXMpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcignTm90IGltcGxlbWVudGVkIHlldCBmb3Igc2NyaXB0LicpO1xuICAgIH1cblxuICAgIGFzeW5jIHNjcmlwdFRpbWVvdXRNSlNPTldQIChtcykge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCdOb3QgaW1wbGVtZW50ZWQgeWV0IGZvciBzY3JpcHQuJyk7XG4gICAgfVxuXG4gICAgLy8gY29tbWFuZFxuICAgIGFzeW5jIG5ld0NvbW1hbmRUaW1lb3V0IChtcykge1xuICAgICAgdGhpcy5zZXROZXdDb21tYW5kVGltZW91dCh0aGlzLnBhcnNlVGltZW91dEFyZ3VtZW50KG1zKSk7XG4gICAgfVxuXG4gICAgc2V0SW1wbGljaXRXYWl0IChtcykge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgICB0aGlzLmltcGxpY2l0V2FpdE1zID0gbXM7XG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhgU2V0IGltcGxpY2l0IHdhaXQgdG8gJHttc31tc2ApO1xuICAgICAgaWYgKHRoaXMubWFuYWdlZERyaXZlcnMgJiYgdGhpcy5tYW5hZ2VkRHJpdmVycy5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ1NldHRpbmcgaW1wbGljaXQgd2FpdCBvbiBtYW5hZ2VkIGRyaXZlcnMnKTtcbiAgICAgICAgZm9yIChsZXQgZHJpdmVyIG9mIHRoaXMubWFuYWdlZERyaXZlcnMpIHtcbiAgICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRyaXZlci5zZXRJbXBsaWNpdFdhaXQpKSB7XG4gICAgICAgICAgICBkcml2ZXIuc2V0SW1wbGljaXRXYWl0KG1zKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBzZXROZXdDb21tYW5kVGltZW91dCAobXMpIHtcbiAgICAgIHRoaXMubmV3Q29tbWFuZFRpbWVvdXRNcyA9IG1zO1xuICAgICAgdGhpcy5sb2cuZGVidWcoYFNldCBuZXcgY29tbWFuZCB0aW1lb3V0IHRvICR7bXN9bXNgKTtcbiAgICAgIGlmICh0aGlzLm1hbmFnZWREcml2ZXJzICYmIHRoaXMubWFuYWdlZERyaXZlcnMubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCdTZXR0aW5nIG5ldyBjb21tYW5kIHRpbWVvdXQgb24gbWFuYWdlZCBkcml2ZXJzJyk7XG4gICAgICAgIGZvciAobGV0IGRyaXZlciBvZiB0aGlzLm1hbmFnZWREcml2ZXJzKSB7XG4gICAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihkcml2ZXIuc2V0TmV3Q29tbWFuZFRpbWVvdXQpKSB7XG4gICAgICAgICAgICBkcml2ZXIuc2V0TmV3Q29tbWFuZFRpbWVvdXQobXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiAoY29uZEZuKSB7XG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhgV2FpdGluZyB1cCB0byAke3RoaXMuaW1wbGljaXRXYWl0TXN9IG1zIGZvciBjb25kaXRpb25gKTtcbiAgICAgIGxldCB3cmFwcGVkQ29uZEZuID0gYXN5bmMgKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgLy8gcmVzZXQgY29tbWFuZCB0aW1lb3V0XG4gICAgICAgIGF3YWl0IHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCBjb25kRm4oLi4uYXJncyk7XG4gICAgICB9O1xuICAgICAgcmV0dXJuIGF3YWl0IHdhaXRGb3JDb25kaXRpb24od3JhcHBlZENvbmRGbiwge1xuICAgICAgICB3YWl0TXM6IHRoaXMuaW1wbGljaXRXYWl0TXMsXG4gICAgICAgIGludGVydmFsTXM6IDUwMCxcbiAgICAgICAgbG9nZ2VyOiB0aGlzLmxvZyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHBhcnNlVGltZW91dEFyZ3VtZW50IChtcykge1xuICAgICAgbGV0IGR1cmF0aW9uID0gcGFyc2VJbnQobXMsIDEwKTtcbiAgICAgIGlmIChfLmlzTmFOKGR1cmF0aW9uKSB8fCBkdXJhdGlvbiA8IE1JTl9USU1FT1VUKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBJbnZhbGlkIHRpbWVvdXQgdmFsdWUgJyR7bXN9J2ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGR1cmF0aW9uO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBUaW1lb3V0Q29tbWFuZHM7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge2ltcG9ydCgnQGFwcGl1bS90eXBlcycpLlRpbWVvdXRDb21tYW5kc30gSVRpbWVvdXRDb21tYW5kc1xuICogQHR5cGVkZWYge2ltcG9ydCgnLi4vZHJpdmVyJykuQmFzZURyaXZlckJhc2U8SVRpbWVvdXRDb21tYW5kcz59IFRpbWVvdXRCYXNlXG4gKi9cbiJdfQ==