"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.downloadFile = downloadFile;
exports.uploadFile = uploadFile;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _fs = _interopRequireDefault(require("./fs"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _util = require("./util");

var _logger = _interopRequireDefault(require("./logger"));

var _jsftp = _interopRequireDefault(require("jsftp"));

var _timing = _interopRequireDefault(require("./timing"));

var _axios = _interopRequireDefault(require("axios"));

var _formData = _interopRequireDefault(require("form-data"));

const DEFAULT_TIMEOUT_MS = 4 * 60 * 1000;

function toAxiosAuth(auth) {
  if (!_lodash.default.isPlainObject(auth)) {
    return null;
  }

  const axiosAuth = {
    username: _lodash.default.get(auth, 'username', _lodash.default.get(auth, 'user')),
    password: _lodash.default.get(auth, 'password', _lodash.default.get(auth, 'pass'))
  };
  return axiosAuth.username && axiosAuth.password ? axiosAuth : null;
}

async function uploadFileToHttp(localFileStream, parsedUri, uploadOptions = {}) {
  const {
    method = 'POST',
    timeout = DEFAULT_TIMEOUT_MS,
    headers,
    auth,
    fileFieldName = 'file',
    formFields
  } = uploadOptions;
  const {
    href
  } = parsedUri;
  const requestOpts = {
    url: href,
    method,
    timeout,
    maxContentLength: Infinity,
    maxBodyLength: Infinity
  };
  const axiosAuth = toAxiosAuth(auth);

  if (axiosAuth) {
    requestOpts.auth = axiosAuth;
  }

  if (fileFieldName) {
    const form = new _formData.default();
    form.append(fileFieldName, localFileStream);

    if (formFields) {
      let pairs = [];

      if (_lodash.default.isArray(formFields)) {
        pairs = formFields;
      } else if (_lodash.default.isPlainObject(formFields)) {
        pairs = _lodash.default.toPairs(formFields);
      }

      for (const [key, value] of pairs) {
        if (_lodash.default.toLower(key) !== _lodash.default.toLower(fileFieldName)) {
          form.append(key, value);
        }
      }
    }

    requestOpts.headers = { ...(_lodash.default.isPlainObject(headers) ? headers : {}),
      ...form.getHeaders()
    };
    requestOpts.data = form;
  } else {
    if (_lodash.default.isPlainObject(headers)) {
      requestOpts.headers = headers;
    }

    requestOpts.data = localFileStream;
  }

  _logger.default.debug(`Performing ${method} to ${href} with options (excluding data): ` + JSON.stringify(_lodash.default.omit(requestOpts, ['data'])));

  const {
    status,
    statusText
  } = await (0, _axios.default)(requestOpts);

  _logger.default.info(`Server response: ${status} ${statusText}`);
}

async function uploadFileToFtp(localFileStream, parsedUri, uploadOptions = {}) {
  const {
    auth
  } = uploadOptions;
  const {
    hostname,
    port,
    protocol,
    pathname
  } = parsedUri;
  const ftpOpts = {
    host: hostname,
    port: !_lodash.default.isUndefined(port) ? _lodash.default.parseInt(port) : 21
  };

  if (auth !== null && auth !== void 0 && auth.user && auth !== null && auth !== void 0 && auth.pass) {
    ftpOpts.user = auth.user;
    ftpOpts.pass = auth.pass;
  }

  _logger.default.debug(`${protocol} upload options: ${JSON.stringify(ftpOpts)}`);

  return await new _bluebird.default((resolve, reject) => {
    new _jsftp.default(ftpOpts).put(localFileStream, pathname, err => {
      if (err) {
        reject(err);
      } else {
        resolve();
      }
    });
  });
}

function isHttpUploadOptions(opts, url) {
  try {
    const {
      protocol
    } = new URL(url);
    return protocol === 'http:' || protocol === 'https:';
  } catch {
    return false;
  }
}

function isNotHttpUploadOptions(opts, url) {
  try {
    const {
      protocol
    } = new URL(url);
    return protocol === 'ftp:';
  } catch {
    return false;
  }
}

async function uploadFile(localPath, remoteUri, uploadOptions = {}) {
  if (!(await _fs.default.exists(localPath))) {
    throw new Error(`'${localPath}' does not exists or is not accessible`);
  }

  const {
    isMetered = true
  } = uploadOptions;
  const url = new URL(remoteUri);
  const {
    size
  } = await _fs.default.stat(localPath);

  if (isMetered) {
    _logger.default.info(`Uploading '${localPath}' of ${(0, _util.toReadableSizeString)(size)} size to '${remoteUri}'`);
  }

  const timer = new _timing.default().start();

  if (isHttpUploadOptions(uploadOptions, url)) {
    if (!uploadOptions.fileFieldName) {
      uploadOptions.headers = { ...(_lodash.default.isPlainObject(uploadOptions.headers) ? uploadOptions.headers : {}),
        'Content-Length': size
      };
    }

    await uploadFileToHttp(_fs.default.createReadStream(localPath), url, uploadOptions);
  } else if (isNotHttpUploadOptions(uploadOptions, url)) {
    await uploadFileToFtp(_fs.default.createReadStream(localPath), url, uploadOptions);
  } else {
    throw new Error(`Cannot upload the file at '${localPath}' to '${remoteUri}'. ` + `Unsupported remote protocol '${url.protocol}'. ` + `Only http/https and ftp/ftps protocols are supported.`);
  }

  if (isMetered) {
    _logger.default.info(`Uploaded '${localPath}' of ${(0, _util.toReadableSizeString)(size)} size in ` + `${timer.getDuration().asSeconds.toFixed(3)}s`);
  }
}

async function downloadFile(remoteUrl, dstPath, downloadOptions = {}) {
  const {
    isMetered = true,
    auth,
    timeout = DEFAULT_TIMEOUT_MS,
    headers
  } = downloadOptions;
  const requestOpts = {
    url: remoteUrl,
    responseType: 'stream',
    timeout
  };
  const axiosAuth = toAxiosAuth(auth);

  if (axiosAuth) {
    requestOpts.auth = axiosAuth;
  }

  if (_lodash.default.isPlainObject(headers)) {
    requestOpts.headers = headers;
  }

  const timer = new _timing.default().start();
  let responseLength;

  try {
    const writer = _fs.default.createWriteStream(dstPath);

    const {
      data: responseStream,
      headers: responseHeaders
    } = await (0, _axios.default)(requestOpts);
    responseLength = parseInt(responseHeaders['content-length'], 10);
    responseStream.pipe(writer);
    await new _bluebird.default((resolve, reject) => {
      responseStream.once('error', reject);
      writer.once('finish', resolve);
      writer.once('error', e => {
        responseStream.unpipe(writer);
        reject(e);
      });
    });
  } catch (err) {
    throw new Error(`Cannot download the file from ${remoteUrl}: ${err.message}`);
  }

  const {
    size
  } = await _fs.default.stat(dstPath);

  if (responseLength && size !== responseLength) {
    await _fs.default.rimraf(dstPath);
    throw new Error(`The size of the file downloaded from ${remoteUrl} (${size} bytes) ` + `differs from the one in Content-Length response header (${responseLength} bytes)`);
  }

  if (isMetered) {
    const secondsElapsed = timer.getDuration().asSeconds;

    _logger.default.debug(`${remoteUrl} (${(0, _util.toReadableSizeString)(size)}) ` + `has been downloaded to '${dstPath}' in ${secondsElapsed.toFixed(3)}s`);

    if (secondsElapsed >= 2) {
      const bytesPerSec = Math.floor(size / secondsElapsed);

      _logger.default.debug(`Approximate download speed: ${(0, _util.toReadableSizeString)(bytesPerSec)}/s`);
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9uZXQuanMiXSwibmFtZXMiOlsiREVGQVVMVF9USU1FT1VUX01TIiwidG9BeGlvc0F1dGgiLCJhdXRoIiwiXyIsImlzUGxhaW5PYmplY3QiLCJheGlvc0F1dGgiLCJ1c2VybmFtZSIsImdldCIsInBhc3N3b3JkIiwidXBsb2FkRmlsZVRvSHR0cCIsImxvY2FsRmlsZVN0cmVhbSIsInBhcnNlZFVyaSIsInVwbG9hZE9wdGlvbnMiLCJtZXRob2QiLCJ0aW1lb3V0IiwiaGVhZGVycyIsImZpbGVGaWVsZE5hbWUiLCJmb3JtRmllbGRzIiwiaHJlZiIsInJlcXVlc3RPcHRzIiwidXJsIiwibWF4Q29udGVudExlbmd0aCIsIkluZmluaXR5IiwibWF4Qm9keUxlbmd0aCIsImZvcm0iLCJGb3JtRGF0YSIsImFwcGVuZCIsInBhaXJzIiwiaXNBcnJheSIsInRvUGFpcnMiLCJrZXkiLCJ2YWx1ZSIsInRvTG93ZXIiLCJnZXRIZWFkZXJzIiwiZGF0YSIsImxvZyIsImRlYnVnIiwiSlNPTiIsInN0cmluZ2lmeSIsIm9taXQiLCJzdGF0dXMiLCJzdGF0dXNUZXh0IiwiaW5mbyIsInVwbG9hZEZpbGVUb0Z0cCIsImhvc3RuYW1lIiwicG9ydCIsInByb3RvY29sIiwicGF0aG5hbWUiLCJmdHBPcHRzIiwiaG9zdCIsImlzVW5kZWZpbmVkIiwicGFyc2VJbnQiLCJ1c2VyIiwicGFzcyIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwiRnRwIiwicHV0IiwiZXJyIiwiaXNIdHRwVXBsb2FkT3B0aW9ucyIsIm9wdHMiLCJVUkwiLCJpc05vdEh0dHBVcGxvYWRPcHRpb25zIiwidXBsb2FkRmlsZSIsImxvY2FsUGF0aCIsInJlbW90ZVVyaSIsImZzIiwiZXhpc3RzIiwiRXJyb3IiLCJpc01ldGVyZWQiLCJzaXplIiwic3RhdCIsInRpbWVyIiwiVGltZXIiLCJzdGFydCIsImNyZWF0ZVJlYWRTdHJlYW0iLCJnZXREdXJhdGlvbiIsImFzU2Vjb25kcyIsInRvRml4ZWQiLCJkb3dubG9hZEZpbGUiLCJyZW1vdGVVcmwiLCJkc3RQYXRoIiwiZG93bmxvYWRPcHRpb25zIiwicmVzcG9uc2VUeXBlIiwicmVzcG9uc2VMZW5ndGgiLCJ3cml0ZXIiLCJjcmVhdGVXcml0ZVN0cmVhbSIsInJlc3BvbnNlU3RyZWFtIiwicmVzcG9uc2VIZWFkZXJzIiwicGlwZSIsIm9uY2UiLCJlIiwidW5waXBlIiwibWVzc2FnZSIsInJpbXJhZiIsInNlY29uZHNFbGFwc2VkIiwiYnl0ZXNQZXJTZWMiLCJNYXRoIiwiZmxvb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGtCQUFrQixHQUFHLElBQUksRUFBSixHQUFTLElBQXBDOztBQU9BLFNBQVNDLFdBQVQsQ0FBc0JDLElBQXRCLEVBQTRCO0FBQzFCLE1BQUksQ0FBQ0MsZ0JBQUVDLGFBQUYsQ0FBZ0JGLElBQWhCLENBQUwsRUFBNEI7QUFDMUIsV0FBTyxJQUFQO0FBQ0Q7O0FBRUQsUUFBTUcsU0FBUyxHQUFHO0FBQ2hCQyxJQUFBQSxRQUFRLEVBQUVILGdCQUFFSSxHQUFGLENBQU1MLElBQU4sRUFBWSxVQUFaLEVBQXdCQyxnQkFBRUksR0FBRixDQUFNTCxJQUFOLEVBQVksTUFBWixDQUF4QixDQURNO0FBRWhCTSxJQUFBQSxRQUFRLEVBQUVMLGdCQUFFSSxHQUFGLENBQU1MLElBQU4sRUFBWSxVQUFaLEVBQXdCQyxnQkFBRUksR0FBRixDQUFNTCxJQUFOLEVBQVksTUFBWixDQUF4QjtBQUZNLEdBQWxCO0FBSUEsU0FBUUcsU0FBUyxDQUFDQyxRQUFWLElBQXNCRCxTQUFTLENBQUNHLFFBQWpDLEdBQTZDSCxTQUE3QyxHQUF5RCxJQUFoRTtBQUNEOztBQU9ELGVBQWVJLGdCQUFmLENBQWlDQyxlQUFqQyxFQUFrREMsU0FBbEQsRUFBNkRDLGFBQWEsR0FBaUQsRUFBM0gsRUFBZ0k7QUFDOUgsUUFBTTtBQUNKQyxJQUFBQSxNQUFN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QUFmLENBQXNCUCxNQUF0QjtBQUNBOUIsUUFBQUEsTUFBTSxDQUFDb0MsQ0FBRCxDQUFOO0FBQ0QsT0FIRDtBQUlELEtBUEssQ0FBTjtBQVFELEdBakJELENBaUJFLE9BQU9qQyxHQUFQLEVBQVk7QUFDWixVQUFNLElBQUlVLEtBQUosQ0FBVyxpQ0FBZ0NZLFNBQVUsS0FBSXRCLEdBQUcsQ0FBQ21DLE9BQVEsRUFBckUsQ0FBTjtBQUNEOztBQUVELFFBQU07QUFBQ3ZCLElBQUFBO0FBQUQsTUFBUyxNQUFNSixZQUFHSyxJQUFILENBQVFVLE9BQVIsQ0FBckI7O0FBQ0EsTUFBSUcsY0FBYyxJQUFJZCxJQUFJLEtBQUtjLGNBQS9CLEVBQStDO0FBQzdDLFVBQU1sQixZQUFHNEIsTUFBSCxDQUFVYixPQUFWLENBQU47QUFDQSxVQUFNLElBQUliLEtBQUosQ0FBVyx3Q0FBdUNZLFNBQVUsS0FBSVYsSUFBSyxVQUEzRCxHQUNiLDJEQUEwRGMsY0FBZSxTQUR0RSxDQUFOO0FBRUQ7O0FBQ0QsTUFBSWYsU0FBSixFQUFlO0FBQ2IsVUFBTTBCLGNBQWMsR0FBR3ZCLEtBQUssQ0FBQ0ksV0FBTixHQUFvQkMsU0FBM0M7O0FBQ0EzQyxvQkFBSUMsS0FBSixDQUFXLEdBQUU2QyxTQUFVLEtBQUksZ0NBQXFCVixJQUFyQixDQUEyQixJQUE1QyxHQUNQLDJCQUEwQlcsT0FBUSxRQUFPYyxjQUFjLENBQUNqQixPQUFmLENBQXVCLENBQXZCLENBQTBCLEdBRHRFOztBQUVBLFFBQUlpQixjQUFjLElBQUksQ0FBdEIsRUFBeUI7QUFDdkIsWUFBTUMsV0FBVyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBVzVCLElBQUksR0FBR3lCLGNBQWxCLENBQXBCOztBQUNBN0Qsc0JBQUlDLEtBQUosQ0FBVywrQkFBOEIsZ0NBQXFCNkQsV0FBckIsQ0FBa0MsSUFBM0U7QUFDRDtBQUNGO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGZzIGZyb20gJy4vZnMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgdG9SZWFkYWJsZVNpemVTdHJpbmcgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgRnRwIGZyb20gJ2pzZnRwJztcbmltcG9ydCBUaW1lciBmcm9tICcuL3RpbWluZyc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IEZvcm1EYXRhIGZyb20gJ2Zvcm0tZGF0YSc7XG5cbmNvbnN0IERFRkFVTFRfVElNRU9VVF9NUyA9IDQgKiA2MCAqIDEwMDA7XG5cbi8qKlxuICogQ29udmVydHMge0BsaW5rY29kZSBBdXRoQ3JlZGVudGlhbHN9IHRvIGNyZWRlbnRpYWxzIHVuZGVyc3Rvb2QgYnkge0BsaW5rY29kZSBheGlvc30uXG4gKiBAcGFyYW0ge0F1dGhDcmVkZW50aWFscyB8IGltcG9ydCgnYXhpb3MnKS5BeGlvc0Jhc2ljQ3JlZGVudGlhbHN9IGF1dGhcbiAqIEByZXR1cm5zIHtpbXBvcnQoJ2F4aW9zJykuQXhpb3NCYXNpY0NyZWRlbnRpYWxzP31cbiAqL1xuZnVuY3Rpb24gdG9BeGlvc0F1dGggKGF1dGgpIHtcbiAgaWYgKCFfLmlzUGxhaW5PYmplY3QoYXV0aCkpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGF4aW9zQXV0aCA9IHtcbiAgICB1c2VybmFtZTogXy5nZXQoYXV0aCwgJ3VzZXJuYW1lJywgXy5nZXQoYXV0aCwgJ3VzZXInKSksXG4gICAgcGFzc3dvcmQ6IF8uZ2V0KGF1dGgsICdwYXNzd29yZCcsIF8uZ2V0KGF1dGgsICdwYXNzJykpLFxuICB9O1xuICByZXR1cm4gKGF4aW9zQXV0aC51c2VybmFtZSAmJiBheGlvc0F1dGgucGFzc3dvcmQpID8gYXhpb3NBdXRoIDogbnVsbDtcbn1cblxuLyoqXG4gKiBAcGFyYW0ge05vZGVKUy5SZWFkYWJsZVN0cmVhbX0gbG9jYWxGaWxlU3RyZWFtXG4gKiBAcGFyYW0ge1VSTH0gcGFyc2VkVXJpXG4gKiBAcGFyYW0ge0h0dHBVcGxvYWRPcHRpb25zICYgTmV0T3B0aW9uc30gW3VwbG9hZE9wdGlvbnNdXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGVUb0h0dHAgKGxvY2FsRmlsZVN0cmVhbSwgcGFyc2VkVXJpLCB1cGxvYWRPcHRpb25zID0gLyoqIEB0eXBlIHtIdHRwVXBsb2FkT3B0aW9ucyAmIE5ldE9wdGlvbnN9ICovKHt9KSkge1xuICBjb25zdCB7XG4gICAgbWV0aG9kID0gJ1BPU1QnLFxuICAgIHRpbWVvdXQgPSBERUZBVUxUX1RJTUVPVVRfTVMsXG4gICAgaGVhZGVycyxcbiAgICBhdXRoLFxuICAgIGZpbGVGaWVsZE5hbWUgPSAnZmlsZScsXG4gICAgZm9ybUZpZWxkcyxcbiAgfSA9IHVwbG9hZE9wdGlvbnM7XG4gIGNvbnN0IHsgaHJlZiB9ID0gcGFyc2VkVXJpO1xuXG4gIC8qKiBAdHlwZSB7aW1wb3J0KCdheGlvcycpLkF4aW9zUmVxdWVzdENvbmZpZ30gKi9cbiAgY29uc3QgcmVxdWVzdE9wdHMgPSB7XG4gICAgdXJsOiBocmVmLFxuICAgIG1ldGhvZCxcbiAgICB0aW1lb3V0LFxuICAgIG1heENvbnRlbnRMZW5ndGg6IEluZmluaXR5LFxuICAgIG1heEJvZHlMZW5ndGg6IEluZmluaXR5LFxuICB9O1xuICBjb25zdCBheGlvc0F1dGggPSB0b0F4aW9zQXV0aChhdXRoKTtcbiAgaWYgKGF4aW9zQXV0aCkge1xuICAgIHJlcXVlc3RPcHRzLmF1dGggPSBheGlvc0F1dGg7XG4gIH1cbiAgaWYgKGZpbGVGaWVsZE5hbWUpIHtcbiAgICBjb25zdCBmb3JtID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybS5hcHBlbmQoZmlsZUZpZWxkTmFtZSwgbG9jYWxGaWxlU3RyZWFtKTtcbiAgICBpZiAoZm9ybUZpZWxkcykge1xuICAgICAgbGV0IHBhaXJzID0gW107XG4gICAgICBpZiAoXy5pc0FycmF5KGZvcm1GaWVsZHMpKSB7XG4gICAgICAgIHBhaXJzID0gZm9ybUZpZWxkcztcbiAgICAgIH0gZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KGZvcm1GaWVsZHMpKSB7XG4gICAgICAgIHBhaXJzID0gXy50b1BhaXJzKGZvcm1GaWVsZHMpO1xuICAgICAgfVxuICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgcGFpcnMpIHtcbiAgICAgICAgaWYgKF8udG9Mb3dlcihrZXkpICE9PSBfLnRvTG93ZXIoZmlsZUZpZWxkTmFtZSkpIHtcbiAgICAgICAgICBmb3JtLmFwcGVuZChrZXksIHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXF1ZXN0T3B0cy5oZWFkZXJzID0ge1xuICAgICAgLi4uKF8uaXNQbGFpbk9iamVjdChoZWFkZXJzKSA/IGhlYWRlcnMgOiB7fSksXG4gICAgICAuLi5mb3JtLmdldEhlYWRlcnMoKVxuICAgIH07XG4gICAgcmVxdWVzdE9wdHMuZGF0YSA9IGZvcm07XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdChoZWFkZXJzKSkge1xuICAgICAgcmVxdWVzdE9wdHMuaGVhZGVycyA9IGhlYWRlcnM7XG4gICAgfVxuICAgIHJlcXVlc3RPcHRzLmRhdGEgPSBsb2NhbEZpbGVTdHJlYW07XG4gIH1cbiAgbG9nLmRlYnVnKGBQZXJmb3JtaW5nICR7bWV0aG9kfSB0byAke2hyZWZ9IHdpdGggb3B0aW9ucyAoZXhjbHVkaW5nIGRhdGEpOiBgICtcbiAgICBKU09OLnN0cmluZ2lmeShfLm9taXQocmVxdWVzdE9wdHMsIFsnZGF0YSddKSkpO1xuXG4gIGNvbnN0IHtzdGF0dXMsIHN0YXR1c1RleHR9ID0gYXdhaXQgYXhpb3MocmVxdWVzdE9wdHMpO1xuICBsb2cuaW5mbyhgU2VydmVyIHJlc3BvbnNlOiAke3N0YXR1c30gJHtzdGF0dXNUZXh0fWApO1xufVxuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nIHwgQnVmZmVyIHwgTm9kZUpTLlJlYWRhYmxlU3RyZWFtfSBsb2NhbEZpbGVTdHJlYW1cbiAqIEBwYXJhbSB7VVJMfSBwYXJzZWRVcmlcbiAqIEBwYXJhbSB7Tm90SHR0cFVwbG9hZE9wdGlvbnMgJiBOZXRPcHRpb25zfSBbdXBsb2FkT3B0aW9uc11cbiAqL1xuYXN5bmMgZnVuY3Rpb24gdXBsb2FkRmlsZVRvRnRwIChsb2NhbEZpbGVTdHJlYW0sIHBhcnNlZFVyaSwgdXBsb2FkT3B0aW9ucyA9IC8qKiBAdHlwZSB7Tm90SHR0cFVwbG9hZE9wdGlvbnMgJiBOZXRPcHRpb25zfSAqLyh7fSkpIHtcbiAgY29uc3Qge1xuICAgIGF1dGgsXG4gIH0gPSB1cGxvYWRPcHRpb25zO1xuICBjb25zdCB7XG4gICAgaG9zdG5hbWUsXG4gICAgcG9ydCxcbiAgICBwcm90b2NvbCxcbiAgICBwYXRobmFtZSxcbiAgfSA9IHBhcnNlZFVyaTtcblxuICBjb25zdCBmdHBPcHRzID0ge1xuICAgIGhvc3Q6IGhvc3RuYW1lLFxuICAgIHBvcnQ6ICFfLmlzVW5kZWZpbmVkKHBvcnQpID8gXy5wYXJzZUludChwb3J0KSA6IDIxLFxuICB9O1xuICBpZiAoYXV0aD8udXNlciAmJiBhdXRoPy5wYXNzKSB7XG4gICAgZnRwT3B0cy51c2VyID0gYXV0aC51c2VyO1xuICAgIGZ0cE9wdHMucGFzcyA9IGF1dGgucGFzcztcbiAgfVxuICBsb2cuZGVidWcoYCR7cHJvdG9jb2x9IHVwbG9hZCBvcHRpb25zOiAke0pTT04uc3RyaW5naWZ5KGZ0cE9wdHMpfWApO1xuICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIG5ldyBGdHAoZnRwT3B0cykucHV0KGxvY2FsRmlsZVN0cmVhbSwgcGF0aG5hbWUsIChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuXG4vKipcbiAqIFJldHVybnMgYHRydWVgIGlmIHBhcmFtcyBhcmUgdmFsaWQgZm9yIHtAbGlua2NvZGUgdXBsb2FkRmlsZVRvSHR0cH0uXG4gKiBAcGFyYW0ge2FueX0gb3B0c1xuICogQHBhcmFtIHtVUkx9IHVybFxuICogQHJldHVybnMge29wdHMgaXMgSHR0cFVwbG9hZE9wdGlvbnMgJiBOZXRPcHRpb25zfVxuICovXG5mdW5jdGlvbiBpc0h0dHBVcGxvYWRPcHRpb25zIChvcHRzLCB1cmwpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7cHJvdG9jb2x9ID0gbmV3IFVSTCh1cmwpO1xuICAgIHJldHVybiBwcm90b2NvbCA9PT0gJ2h0dHA6JyB8fCBwcm90b2NvbCA9PT0gJ2h0dHBzOic7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIFJldHVybnMgYHRydWVgIGlmIHBhcmFtcyBhcmUgdmFsaWQgZm9yIHtAbGlua2NvZGUgdXBsb2FkRmlsZVRvRnRwfS5cbiAqIEBwYXJhbSB7YW55fSBvcHRzXG4gKiBAcGFyYW0ge1VSTH0gdXJsXG4gKiBAcmV0dXJucyB7b3B0cyBpcyBOb3RIdHRwVXBsb2FkT3B0aW9ucyAmIE5ldE9wdGlvbnN9XG4gKi9cbmZ1bmN0aW9uIGlzTm90SHR0cFVwbG9hZE9wdGlvbnMgKG9wdHMsIHVybCkge1xuICB0cnkge1xuICAgIGNvbnN0IHtwcm90b2NvbH0gPSBuZXcgVVJMKHVybCk7XG4gICAgcmV0dXJuIHByb3RvY29sID09PSAnZnRwOic7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuLyoqXG4gKiBVcGxvYWRzIHRoZSBnaXZlbiBmaWxlIHRvIGEgcmVtb3RlIGxvY2F0aW9uLiBIVFRQKFMpIGFuZCBGVFBcbiAqIHByb3RvY29scyBhcmUgc3VwcG9ydGVkLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhbFBhdGggLSBUaGUgcGF0aCB0byBhIGZpbGUgb24gdGhlIGxvY2FsIHN0b3JhZ2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlVXJpIC0gVGhlIHJlbW90ZSBVUkkgdG8gdXBsb2FkIHRoZSBmaWxlIHRvLlxuICogQHBhcmFtIHsoSHR0cFVwbG9hZE9wdGlvbnN8Tm90SHR0cFVwbG9hZE9wdGlvbnMpICYgTmV0T3B0aW9uc30gW3VwbG9hZE9wdGlvbnNdXG4gKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn1cbiAqL1xuYXN5bmMgZnVuY3Rpb24gdXBsb2FkRmlsZSAobG9jYWxQYXRoLCByZW1vdGVVcmksIHVwbG9hZE9wdGlvbnMgPSAvKiogQHR5cGUgeyhIdHRwVXBsb2FkT3B0aW9uc3xOb3RIdHRwVXBsb2FkT3B0aW9ucykgJiBOZXRPcHRpb25zfSAqLyh7fSkpIHtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMobG9jYWxQYXRoKSkge1xuICAgIHRocm93IG5ldyBFcnJvciAoYCcke2xvY2FsUGF0aH0nIGRvZXMgbm90IGV4aXN0cyBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIGlzTWV0ZXJlZCA9IHRydWUsXG4gIH0gPSB1cGxvYWRPcHRpb25zO1xuICBjb25zdCB1cmwgPSBuZXcgVVJMKHJlbW90ZVVyaSk7XG4gIGNvbnN0IHtzaXplfSA9IGF3YWl0IGZzLnN0YXQobG9jYWxQYXRoKTtcbiAgaWYgKGlzTWV0ZXJlZCkge1xuICAgIGxvZy5pbmZvKGBVcGxvYWRpbmcgJyR7bG9jYWxQYXRofScgb2YgJHt0b1JlYWRhYmxlU2l6ZVN0cmluZyhzaXplKX0gc2l6ZSB0byAnJHtyZW1vdGVVcml9J2ApO1xuICB9XG4gIGNvbnN0IHRpbWVyID0gbmV3IFRpbWVyKCkuc3RhcnQoKTtcbiAgaWYgKGlzSHR0cFVwbG9hZE9wdGlvbnModXBsb2FkT3B0aW9ucywgdXJsKSkge1xuICAgIGlmICghdXBsb2FkT3B0aW9ucy5maWxlRmllbGROYW1lKSB7XG4gICAgICB1cGxvYWRPcHRpb25zLmhlYWRlcnMgPSB7XG4gICAgICAgIC4uLihfLmlzUGxhaW5PYmplY3QodXBsb2FkT3B0aW9ucy5oZWFkZXJzKSA/IHVwbG9hZE9wdGlvbnMuaGVhZGVycyA6IHt9KSxcbiAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoJzogc2l6ZVxuICAgICAgfTtcbiAgICB9XG4gICAgYXdhaXQgdXBsb2FkRmlsZVRvSHR0cChmcy5jcmVhdGVSZWFkU3RyZWFtKGxvY2FsUGF0aCksIHVybCwgdXBsb2FkT3B0aW9ucyk7XG4gIH0gZWxzZSBpZiAoaXNOb3RIdHRwVXBsb2FkT3B0aW9ucyh1cGxvYWRPcHRpb25zLCB1cmwpKSB7XG4gICAgYXdhaXQgdXBsb2FkRmlsZVRvRnRwKGZzLmNyZWF0ZVJlYWRTdHJlYW0obG9jYWxQYXRoKSwgdXJsLCB1cGxvYWRPcHRpb25zKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCB1cGxvYWQgdGhlIGZpbGUgYXQgJyR7bG9jYWxQYXRofScgdG8gJyR7cmVtb3RlVXJpfScuIGAgK1xuICAgICAgYFVuc3VwcG9ydGVkIHJlbW90ZSBwcm90b2NvbCAnJHt1cmwucHJvdG9jb2x9Jy4gYCArXG4gICAgICBgT25seSBodHRwL2h0dHBzIGFuZCBmdHAvZnRwcyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZC5gKTtcbiAgfVxuICBpZiAoaXNNZXRlcmVkKSB7XG4gICAgbG9nLmluZm8oYFVwbG9hZGVkICcke2xvY2FsUGF0aH0nIG9mICR7dG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9IHNpemUgaW4gYCArXG4gICAgICBgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXNgKTtcbiAgfVxufVxuXG4vKipcbiAqIERvd25sb2FkcyB0aGUgZ2l2ZW4gZmlsZSB2aWEgSFRUUChTKVxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVVcmwgLSBUaGUgcmVtb3RlIHVybFxuICogQHBhcmFtIHtzdHJpbmd9IGRzdFBhdGggLSBUaGUgbG9jYWwgcGF0aCB0byBkb3dubG9hZCB0aGUgZmlsZSB0b1xuICogQHBhcmFtIHtEb3dubG9hZE9wdGlvbnMgJiBOZXRPcHRpb25zfSBbZG93bmxvYWRPcHRpb25zXVxuICogQHRocm93cyB7RXJyb3J9IElmIGRvd25sb2FkIG9wZXJhdGlvbiBmYWlsc1xuICovXG5hc3luYyBmdW5jdGlvbiBkb3dubG9hZEZpbGUgKHJlbW90ZVVybCwgZHN0UGF0aCwgZG93bmxvYWRPcHRpb25zID0gLyoqIEB0eXBlIHtEb3dubG9hZE9wdGlvbnMgJiBOZXRPcHRpb25zfSAqLyh7fSkpIHtcbiAgY29uc3Qge1xuICAgIGlzTWV0ZXJlZCA9IHRydWUsXG4gICAgYXV0aCxcbiAgICB0aW1lb3V0ID0gREVGQVVMVF9USU1FT1VUX01TLFxuICAgIGhlYWRlcnMsXG4gIH0gPSBkb3dubG9hZE9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIEB0eXBlIHtpbXBvcnQoJ2F4aW9zJykuQXhpb3NSZXF1ZXN0Q29uZmlnfVxuICAgKi9cbiAgY29uc3QgcmVxdWVzdE9wdHMgPSB7XG4gICAgdXJsOiByZW1vdGVVcmwsXG4gICAgcmVzcG9uc2VUeXBlOiAnc3RyZWFtJyxcbiAgICB0aW1lb3V0LFxuICB9O1xuICBjb25zdCBheGlvc0F1dGggPSB0b0F4aW9zQXV0aChhdXRoKTtcbiAgaWYgKGF4aW9zQXV0aCkge1xuICAgIHJlcXVlc3RPcHRzLmF1dGggPSBheGlvc0F1dGg7XG4gIH1cbiAgaWYgKF8uaXNQbGFpbk9iamVjdChoZWFkZXJzKSkge1xuICAgIHJlcXVlc3RPcHRzLmhlYWRlcnMgPSBoZWFkZXJzO1xuICB9XG5cbiAgY29uc3QgdGltZXIgPSBuZXcgVGltZXIoKS5zdGFydCgpO1xuICBsZXQgcmVzcG9uc2VMZW5ndGg7XG4gIHRyeSB7XG4gICAgY29uc3Qgd3JpdGVyID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0oZHN0UGF0aCk7XG4gICAgY29uc3Qge1xuICAgICAgZGF0YTogcmVzcG9uc2VTdHJlYW0sXG4gICAgICBoZWFkZXJzOiByZXNwb25zZUhlYWRlcnMsXG4gICAgfSA9IGF3YWl0IGF4aW9zKHJlcXVlc3RPcHRzKTtcbiAgICByZXNwb25zZUxlbmd0aCA9IHBhcnNlSW50KHJlc3BvbnNlSGVhZGVyc1snY29udGVudC1sZW5ndGgnXSwgMTApO1xuICAgIHJlc3BvbnNlU3RyZWFtLnBpcGUod3JpdGVyKTtcblxuICAgIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHJlc3BvbnNlU3RyZWFtLm9uY2UoJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgIHdyaXRlci5vbmNlKCdmaW5pc2gnLCByZXNvbHZlKTtcbiAgICAgIHdyaXRlci5vbmNlKCdlcnJvcicsIChlKSA9PiB7XG4gICAgICAgIHJlc3BvbnNlU3RyZWFtLnVucGlwZSh3cml0ZXIpO1xuICAgICAgICByZWplY3QoZSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZG93bmxvYWQgdGhlIGZpbGUgZnJvbSAke3JlbW90ZVVybH06ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICBjb25zdCB7c2l6ZX0gPSBhd2FpdCBmcy5zdGF0KGRzdFBhdGgpO1xuICBpZiAocmVzcG9uc2VMZW5ndGggJiYgc2l6ZSAhPT0gcmVzcG9uc2VMZW5ndGgpIHtcbiAgICBhd2FpdCBmcy5yaW1yYWYoZHN0UGF0aCk7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc2l6ZSBvZiB0aGUgZmlsZSBkb3dubG9hZGVkIGZyb20gJHtyZW1vdGVVcmx9ICgke3NpemV9IGJ5dGVzKSBgICtcbiAgICAgIGBkaWZmZXJzIGZyb20gdGhlIG9uZSBpbiBDb250ZW50LUxlbmd0aCByZXNwb25zZSBoZWFkZXIgKCR7cmVzcG9uc2VMZW5ndGh9IGJ5dGVzKWApO1xuICB9XG4gIGlmIChpc01ldGVyZWQpIHtcbiAgICBjb25zdCBzZWNvbmRzRWxhcHNlZCA9IHRpbWVyLmdldER1cmF0aW9uKCkuYXNTZWNvbmRzO1xuICAgIGxvZy5kZWJ1ZyhgJHtyZW1vdGVVcmx9ICgke3RvUmVhZGFibGVTaXplU3RyaW5nKHNpemUpfSkgYCArXG4gICAgICBgaGFzIGJlZW4gZG93bmxvYWRlZCB0byAnJHtkc3RQYXRofScgaW4gJHtzZWNvbmRzRWxhcHNlZC50b0ZpeGVkKDMpfXNgKTtcbiAgICBpZiAoc2Vjb25kc0VsYXBzZWQgPj0gMikge1xuICAgICAgY29uc3QgYnl0ZXNQZXJTZWMgPSBNYXRoLmZsb29yKHNpemUgLyBzZWNvbmRzRWxhcHNlZCk7XG4gICAgICBsb2cuZGVidWcoYEFwcHJveGltYXRlIGRvd25sb2FkIHNwZWVkOiAke3RvUmVhZGFibGVTaXplU3RyaW5nKGJ5dGVzUGVyU2VjKX0vc2ApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyB1cGxvYWRGaWxlLCBkb3dubG9hZEZpbGUgfTtcblxuLyoqXG4gKiBDb21tb24gb3B0aW9ucyBmb3Ige0BsaW5rY29kZSB1cGxvYWRGaWxlfSBhbmQge0BsaW5rY29kZSBkb3dubG9hZEZpbGV9LlxuICogQHR5cGVkZWYgTmV0T3B0aW9uc1xuICogQHByb3BlcnR5IHtib29sZWFufSBbaXNNZXRlcmVkPXRydWVdIC0gV2hldGhlciB0byBsb2cgdGhlIGFjdHVhbCBkb3dubG9hZCBwZXJmb3JtYW5jZVxuICogKGUuZy4gdGltaW5ncyBhbmQgc3BlZWQpXG4gKiBAcHJvcGVydHkge0F1dGhDcmVkZW50aWFsc30gYXV0aFxuICovXG5cbi8qKlxuICogU3BlY2lmaWMgb3B0aW9ucyBmb3Ige0BsaW5rY29kZSBkb3dubG9hZEZpbGV9LlxuICogQHR5cGVkZWYgRG93bmxvYWRPcHRpb25zXG4gKiBAcHJvcGVydHkge251bWJlcn0gW3RpbWVvdXRdIC0gVGhlIGFjdHVhbCByZXF1ZXN0IHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzOyBkZWZhdWx0cyB0byB7QGxpbmtjb2RlIERFRkFVTFRfVElNRU9VVF9NU31cbiAqIEBwcm9wZXJ0eSB7UmVjb3JkPHN0cmluZyxhbnk+fSBoZWFkZXJzIC0gUmVxdWVzdCBoZWFkZXJzIG1hcHBpbmdcbiAqL1xuXG4vKipcbiAqIEJhc2ljIGF1dGggY3JlZGVudGlhbHM7IHVzZWQgYnkge0BsaW5rY29kZSBOZXRPcHRpb25zfS5cbiAqIEB0eXBlZGVmIEF1dGhDcmVkZW50aWFsc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IHVzZXIgLSBOb24tZW1wdHkgdXNlciBuYW1lXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGFzcyAtIE5vbi1lbXB0eSBwYXNzd29yZFxuICovXG5cbi8qKlxuICogVGhpcyB0eXBlIGlzIHVzZWQgaW4ge0BsaW5rY29kZSB1cGxvYWRGaWxlfSBpZiB0aGUgcmVtb3RlIGxvY2F0aW9uIHVzZXMgdGhlIGBmdHBgIHByb3RvY29sLCBhbmQgZGlzdGluZ3Vpc2hlcyB0aGUgdHlwZSBmcm9tIHtAbGlua2NvZGUgSHR0cFVwbG9hZE9wdGlvbnN9LlxuICogQHR5cGVkZWYgTm90SHR0cFVwbG9hZE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7bmV2ZXJ9IGhlYWRlcnNcbiAqIEBwcm9wZXJ0eSB7bmV2ZXJ9IG1ldGhvZFxuICogQHByb3BlcnR5IHtuZXZlcn0gdGltZW91dFxuICogQHByb3BlcnR5IHtuZXZlcn0gZmlsZUZpZWxkTmFtZVxuICogQHByb3BlcnR5IHtuZXZlcn0gZm9ybUZpZWxkc1xuICovXG5cbi8qKlxuICogU3BlY2lmaWMgb3B0aW9ucyBmb3Ige0BsaW5rY29kZSB1cGxvYWRGaWxlfSBpZiB0aGUgcmVtb3RlIGxvY2F0aW9uIHVzZXMgdGhlIGBodHRwKHMpYCBwcm90b2NvbFxuICogQHR5cGVkZWYgSHR0cFVwbG9hZE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7UmVjb3JkPHN0cmluZyxhbnk+fSBoZWFkZXJzIC0gQWRkaXRpb25hbCByZXF1ZXN0IGhlYWRlcnMgbWFwcGluZ1xuICogQHByb3BlcnR5IHtpbXBvcnQoJ2F4aW9zJykuTWV0aG9kfSBbbWV0aG9kPSdQT1NUJ10gLSBUaGUgSFRUUCBtZXRob2QgdXNlZCBmb3IgZmlsZSB1cGxvYWRcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbdGltZW91dF0gLSBUaGUgYWN0dWFsIHJlcXVlc3QgdGltZW91dCBpbiBtaWxsaXNlY29uZHM7IGRlZmF1bHRzIHRvIHtAbGlua2NvZGUgREVGQVVMVF9USU1FT1VUX01TfVxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtmaWxlRmllbGROYW1lPSdmaWxlJ10gLSBUaGUgbmFtZSBvZiB0aGUgZm9ybSBmaWVsZCBjb250YWluaW5nIHRoZSBmaWxlXG4gKiBjb250ZW50IHRvIGJlIHVwbG9hZGVkLiBBbnkgZmFsc3kgdmFsdWUgbWFrZSB0aGUgcmVxdWVzdCB0byB1c2Ugbm9uLW11bHRpcGFydCB1cGxvYWRcbiAqIEBwcm9wZXJ0eSB7UmVjb3JkPHN0cmluZyxhbnk+fSBbZm9ybUZpZWxkc10gLSBUaGUgYWRkaXRpb25hbCBmb3JtIGZpZWxkc1xuICogdG8gYmUgaW5jbHVkZWQgaW50byB0aGUgdXBsb2FkIHJlcXVlc3QuIFRoaXMgcHJvcGVydHkgaXMgb25seSBjb25zaWRlcmVkIGlmXG4gKiBgZmlsZUZpZWxkTmFtZWAgaXMgc2V0XG4gKi9cblxuIl19