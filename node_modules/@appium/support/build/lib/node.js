"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getObjectId = getObjectId;
exports.getObjectSize = getObjectSize;
exports.requirePackage = requirePackage;

require("source-map-support/register");

var _system = require("./system");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _uuid = require("uuid");

const ECMA_SIZES = Object.freeze({
  STRING: 2,
  BOOLEAN: 4,
  NUMBER: 8
});

async function linkGlobalPackage(packageName) {
  try {
    _logger.default.debug(`Linking package '${packageName}'`);

    const cmd = (0, _system.isWindows)() ? 'npm.cmd' : 'npm';
    await (0, _teen_process.exec)(cmd, ['link', packageName], {
      timeout: 20000
    });
  } catch (err) {
    const msg = `Unable to load package '${packageName}', linking failed: ${err.message}`;

    _logger.default.debug(msg);

    if (err.stderr) {
      _logger.default.debug(err.stderr);
    }

    throw new Error(msg);
  }
}

async function requirePackage(packageName) {
  try {
    _logger.default.debug(`Loading local package '${packageName}'`);

    return require(packageName);
  } catch (err) {
    _logger.default.debug(`Failed to load local package '${packageName}': ${err.message}`);
  }

  try {
    var _process$env$npm_conf;

    const globalPackageName = _path.default.resolve((_process$env$npm_conf = process.env.npm_config_prefix) !== null && _process$env$npm_conf !== void 0 ? _process$env$npm_conf : '', 'lib', 'node_modules', packageName);

    _logger.default.debug(`Loading global package '${globalPackageName}'`);

    return require(globalPackageName);
  } catch (err) {
    _logger.default.debug(`Failed to load global package '${packageName}': ${err.message}`);
  }

  try {
    await linkGlobalPackage(packageName);

    _logger.default.debug(`Retrying load of linked package '${packageName}'`);

    return require(packageName);
  } catch (err) {
    _logger.default.errorAndThrow(`Unable to load package '${packageName}': ${err.message}`);
  }
}

function extractAllProperties(obj) {
  const stringProperties = [];

  for (const prop in obj) {
    stringProperties.push(prop);
  }

  if (_lodash.default.isFunction(Object.getOwnPropertySymbols)) {
    stringProperties.push(...Object.getOwnPropertySymbols(obj));
  }

  return stringProperties;
}

function _getSizeOfObject(seen, object) {
  if (_lodash.default.isNil(object)) {
    return 0;
  }

  let bytes = 0;
  const properties = extractAllProperties(object);

  for (const key of properties) {
    if (typeof object[key] === 'object' && !_lodash.default.isNil(object[key])) {
      if (seen.has(object[key])) {
        continue;
      }

      seen.add(object[key]);
    }

    bytes += getCalculator(seen)(key);

    try {
      bytes += getCalculator(seen)(object[key]);
    } catch (ex) {
      if (ex instanceof RangeError) {
        bytes = 0;
      }
    }
  }

  return bytes;
}

function getCalculator(seen) {
  return function calculator(obj) {
    if (_lodash.default.isBuffer(obj)) {
      return obj.length;
    }

    switch (typeof obj) {
      case 'string':
        return obj.length * ECMA_SIZES.STRING;

      case 'boolean':
        return ECMA_SIZES.BOOLEAN;

      case 'number':
        return ECMA_SIZES.NUMBER;

      case 'symbol':
        return _lodash.default.isFunction(Symbol.keyFor) && Symbol.keyFor(obj) ? Symbol.keyFor(obj).length * ECMA_SIZES.STRING : (obj.toString().length - 8) * ECMA_SIZES.STRING;

      case 'object':
        return _lodash.default.isArray(obj) ? obj.map(getCalculator(seen)).reduce((acc, curr) => acc + curr, 0) : _getSizeOfObject(seen, obj);

      default:
        return 0;
    }
  };
}

function getObjectSize(obj) {
  return getCalculator(new WeakSet())(obj);
}

const OBJECTS_MAPPING = new WeakMap();

function getObjectId(object) {
  if (!OBJECTS_MAPPING.has(object)) {
    OBJECTS_MAPPING.set(object, (0, _uuid.v4)());
  }

  return OBJECTS_MAPPING.get(object);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9ub2RlLmpzIl0sIm5hbWVzIjpbIkVDTUFfU0laRVMiLCJPYmplY3QiLCJmcmVlemUiLCJTVFJJTkciLCJCT09MRUFOIiwiTlVNQkVSIiwibGlua0dsb2JhbFBhY2thZ2UiLCJwYWNrYWdlTmFtZSIsImxvZyIsImRlYnVnIiwiY21kIiwidGltZW91dCIsImVyciIsIm1zZyIsIm1lc3NhZ2UiLCJzdGRlcnIiLCJFcnJvciIsInJlcXVpcmVQYWNrYWdlIiwicmVxdWlyZSIsImdsb2JhbFBhY2thZ2VOYW1lIiwicGF0aCIsInJlc29sdmUiLCJwcm9jZXNzIiwiZW52IiwibnBtX2NvbmZpZ19wcmVmaXgiLCJlcnJvckFuZFRocm93IiwiZXh0cmFjdEFsbFByb3BlcnRpZXMiLCJvYmoiLCJzdHJpbmdQcm9wZXJ0aWVzIiwicHJvcCIsInB1c2giLCJfIiwiaXNGdW5jdGlvbiIsImdldE93blByb3BlcnR5U3ltYm9scyIsIl9nZXRTaXplT2ZPYmplY3QiLCJzZWVuIiwib2JqZWN0IiwiaXNOaWwiLCJieXRlcyIsInByb3BlcnRpZXMiLCJrZXkiLCJoYXMiLCJhZGQiLCJnZXRDYWxjdWxhdG9yIiwiZXgiLCJSYW5nZUVycm9yIiwiY2FsY3VsYXRvciIsImlzQnVmZmVyIiwibGVuZ3RoIiwiU3ltYm9sIiwia2V5Rm9yIiwidG9TdHJpbmciLCJpc0FycmF5IiwibWFwIiwicmVkdWNlIiwiYWNjIiwiY3VyciIsImdldE9iamVjdFNpemUiLCJXZWFrU2V0IiwiT0JKRUNUU19NQVBQSU5HIiwiV2Vha01hcCIsImdldE9iamVjdElkIiwic2V0IiwiZ2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUMvQkMsRUFBQUEsTUFBTSxFQUFFLENBRHVCO0FBRS9CQyxFQUFBQSxPQUFPLEVBQUUsQ0FGc0I7QUFHL0JD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QjNCLE1BQXBCLENBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzV2luZG93cyB9IGZyb20gJy4vc3lzdGVtJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkVjQgfSBmcm9tICd1dWlkJztcblxuY29uc3QgRUNNQV9TSVpFUyA9IE9iamVjdC5mcmVlemUoe1xuICBTVFJJTkc6IDIsXG4gIEJPT0xFQU46IDQsXG4gIE5VTUJFUjogOCxcbn0pO1xuXG4vKipcbiAqIEludGVybmFsIHV0aWxpdHkgdG8gbGluayBnbG9iYWwgcGFja2FnZSB0byBsb2NhbCBjb250ZXh0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBhY2thZ2VOYW1lIC0gbmFtZSBvZiB0aGUgcGFja2FnZSB0byBsaW5rXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGNvbW1hbmQgZmFpbHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gbGlua0dsb2JhbFBhY2thZ2UgKHBhY2thZ2VOYW1lKSB7XG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBMaW5raW5nIHBhY2thZ2UgJyR7cGFja2FnZU5hbWV9J2ApO1xuICAgIGNvbnN0IGNtZCA9IGlzV2luZG93cygpID8gJ25wbS5jbWQnIDogJ25wbSc7XG4gICAgYXdhaXQgZXhlYyhjbWQsIFsnbGluaycsIHBhY2thZ2VOYW1lXSwge3RpbWVvdXQ6IDIwMDAwfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnN0IG1zZyA9IGBVbmFibGUgdG8gbG9hZCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfScsIGxpbmtpbmcgZmFpbGVkOiAke2Vyci5tZXNzYWdlfWA7XG4gICAgbG9nLmRlYnVnKG1zZyk7XG4gICAgaWYgKGVyci5zdGRlcnIpIHtcbiAgICAgIC8vIGxvZyB0aGUgc3RkZXJyIGlmIHRoZXJlLCBidXQgZG8gbm90IGFkZCB0byB0aHJvd24gZXJyb3IgYXMgaXQgaXNcbiAgICAgIC8vIF92ZXJ5XyB2ZXJib3NlXG4gICAgICBsb2cuZGVidWcoZXJyLnN0ZGVycik7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihtc2cpO1xuICB9XG59XG5cbi8qKlxuICogVXRpbGl0eSBmdW5jdGlvbiB0byBleHRlbmQgbm9kZSBmdW5jdGlvbmFsaXR5LCBhbGxvd2luZyB1cyB0byByZXF1aXJlXG4gKiBtb2R1bGVzIHRoYXQgYXJlIGluc3RhbGxlZCBnbG9iYWxseS4gSWYgdGhlIHBhY2thZ2UgY2Fubm90IGJlIHJlcXVpcmVkLFxuICogdGhpcyB3aWxsIGF0dGVtcHQgdG8gbGluayB0aGUgcGFja2FnZSBhbmQgdGhlbiByZS1yZXF1aXJlIGl0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBhY2thZ2VOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIHBhY2thZ2UgdG8gYmUgcmVxdWlyZWRcbiAqIEByZXR1cm5zIHtQcm9taXNlPHVua25vd24+fSAtIHRoZSBwYWNrYWdlIG9iamVjdFxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwYWNrYWdlIGlzIG5vdCBmb3VuZCBsb2NhbGx5IG9yIGdsb2JhbGx5XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHJlcXVpcmVQYWNrYWdlIChwYWNrYWdlTmFtZSkge1xuICAvLyBmaXJzdCwgZ2V0IGl0IGluIHRoZSBub3JtYWwgd2F5IChzZWUgaHR0cHM6Ly9ub2RlanMub3JnL2FwaS9tb2R1bGVzLmh0bWwjbW9kdWxlc19hbGxfdG9nZXRoZXIpXG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBMb2FkaW5nIGxvY2FsIHBhY2thZ2UgJyR7cGFja2FnZU5hbWV9J2ApO1xuICAgIHJldHVybiByZXF1aXJlKHBhY2thZ2VOYW1lKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBGYWlsZWQgdG8gbG9hZCBsb2NhbCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyBzZWNvbmQsIGdldCBpdCBmcm9tIHdoZXJlIGl0IG91Z2h0IHRvIGJlIGluIHRoZSBnbG9iYWwgbm9kZV9tb2R1bGVzXG4gIHRyeSB7XG4gICAgY29uc3QgZ2xvYmFsUGFja2FnZU5hbWUgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19wcmVmaXggPz8gJycsICdsaWInLCAnbm9kZV9tb2R1bGVzJywgcGFja2FnZU5hbWUpO1xuICAgIGxvZy5kZWJ1ZyhgTG9hZGluZyBnbG9iYWwgcGFja2FnZSAnJHtnbG9iYWxQYWNrYWdlTmFtZX0nYCk7XG4gICAgcmV0dXJuIHJlcXVpcmUoZ2xvYmFsUGFja2FnZU5hbWUpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYEZhaWxlZCB0byBsb2FkIGdsb2JhbCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyB0aGlyZCwgbGluayB0aGUgZmlsZSBhbmQgZ2V0IGxvY2FsbHlcbiAgdHJ5IHtcbiAgICBhd2FpdCBsaW5rR2xvYmFsUGFja2FnZShwYWNrYWdlTmFtZSk7XG4gICAgbG9nLmRlYnVnKGBSZXRyeWluZyBsb2FkIG9mIGxpbmtlZCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSdgKTtcbiAgICByZXR1cm4gcmVxdWlyZShwYWNrYWdlTmFtZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBVbmFibGUgdG8gbG9hZCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZXh0cmFjdEFsbFByb3BlcnRpZXMgKG9iaikge1xuICBjb25zdCBzdHJpbmdQcm9wZXJ0aWVzID0gW107XG4gIGZvciAoY29uc3QgcHJvcCBpbiBvYmopIHtcbiAgICBzdHJpbmdQcm9wZXJ0aWVzLnB1c2gocHJvcCk7XG4gIH1cbiAgaWYgKF8uaXNGdW5jdGlvbihPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSkge1xuICAgIHN0cmluZ1Byb3BlcnRpZXMucHVzaCguLi4oT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmopKSk7XG4gIH1cbiAgcmV0dXJuIHN0cmluZ1Byb3BlcnRpZXM7XG59XG5cbmZ1bmN0aW9uIF9nZXRTaXplT2ZPYmplY3QgKHNlZW4sIG9iamVjdCkge1xuICBpZiAoXy5pc05pbChvYmplY3QpKSB7XG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICBsZXQgYnl0ZXMgPSAwO1xuICBjb25zdCBwcm9wZXJ0aWVzID0gZXh0cmFjdEFsbFByb3BlcnRpZXMob2JqZWN0KTtcbiAgZm9yIChjb25zdCBrZXkgb2YgcHJvcGVydGllcykge1xuICAgIC8vIERvIG5vdCByZWNhbGN1bGF0ZSBjaXJjdWxhciByZWZlcmVuY2VzXG4gICAgaWYgKHR5cGVvZiBvYmplY3Rba2V5XSA9PT0gJ29iamVjdCcgJiYgIV8uaXNOaWwob2JqZWN0W2tleV0pKSB7XG4gICAgICBpZiAoc2Vlbi5oYXMob2JqZWN0W2tleV0pKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgc2Vlbi5hZGQob2JqZWN0W2tleV0pO1xuICAgIH1cblxuICAgIGJ5dGVzICs9IGdldENhbGN1bGF0b3Ioc2Vlbikoa2V5KTtcbiAgICB0cnkge1xuICAgICAgYnl0ZXMgKz0gZ2V0Q2FsY3VsYXRvcihzZWVuKShvYmplY3Rba2V5XSk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIGlmIChleCBpbnN0YW5jZW9mIFJhbmdlRXJyb3IpIHtcbiAgICAgICAgLy8gY2lyY3VsYXIgcmVmZXJlbmNlIGRldGVjdGVkLCBmaW5hbCByZXN1bHQgbWlnaHQgYmUgaW5jb3JyZWN0XG4gICAgICAgIC8vIGxldCdzIGJlIG5pY2UgYW5kIG5vdCB0aHJvdyBhbiBleGNlcHRpb25cbiAgICAgICAgYnl0ZXMgPSAwO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBieXRlcztcbn1cblxuZnVuY3Rpb24gZ2V0Q2FsY3VsYXRvciAoc2Vlbikge1xuICByZXR1cm4gZnVuY3Rpb24gY2FsY3VsYXRvciAob2JqKSB7XG4gICAgaWYgKF8uaXNCdWZmZXIob2JqKSkge1xuICAgICAgcmV0dXJuIG9iai5sZW5ndGg7XG4gICAgfVxuXG4gICAgc3dpdGNoICh0eXBlb2YgKG9iaikpIHtcbiAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgIHJldHVybiBvYmoubGVuZ3RoICogRUNNQV9TSVpFUy5TVFJJTkc7XG4gICAgICBjYXNlICdib29sZWFuJzpcbiAgICAgICAgcmV0dXJuIEVDTUFfU0laRVMuQk9PTEVBTjtcbiAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgIHJldHVybiBFQ01BX1NJWkVTLk5VTUJFUjtcbiAgICAgIGNhc2UgJ3N5bWJvbCc6XG4gICAgICAgIHJldHVybiBfLmlzRnVuY3Rpb24oU3ltYm9sLmtleUZvcikgJiYgU3ltYm9sLmtleUZvcihvYmopXG4gICAgICAgICAgPyAvKiogQHR5cGUge3N0cmluZ30gKi8oU3ltYm9sLmtleUZvcihvYmopKS5sZW5ndGggKiBFQ01BX1NJWkVTLlNUUklOR1xuICAgICAgICAgIDogKG9iai50b1N0cmluZygpLmxlbmd0aCAtIDgpICogRUNNQV9TSVpFUy5TVFJJTkc7XG4gICAgICBjYXNlICdvYmplY3QnOlxuICAgICAgICByZXR1cm4gXy5pc0FycmF5KG9iailcbiAgICAgICAgICA/IG9iai5tYXAoZ2V0Q2FsY3VsYXRvcihzZWVuKSkucmVkdWNlKChhY2MsIGN1cnIpID0+IGFjYyArIGN1cnIsIDApXG4gICAgICAgICAgOiBfZ2V0U2l6ZU9mT2JqZWN0KHNlZW4sIG9iaik7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH07XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlIHRoZSBpbi1kZXB0aCBzaXplIGluIG1lbW9yeSBvZiB0aGUgcHJvdmlkZWQgb2JqZWN0LlxuICogVGhlIG9yaWdpbmFsIGltcGxlbWVudGF0aW9uIGlzIGJvcnJvd2VkIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL21pa3RhbS9zaXplb2YuXG4gKlxuICogQHBhcmFtIHsqfSBvYmogQW4gb2JqZWN0IHdob3NlIHNpemUgc2hvdWxkIGJlIGNhbGN1bGF0ZWRcbiAqIEByZXR1cm5zIHtudW1iZXJ9IE9iamVjdCBzaXplIGluIGJ5dGVzLlxuICovXG5mdW5jdGlvbiBnZXRPYmplY3RTaXplIChvYmopIHtcbiAgcmV0dXJuIGdldENhbGN1bGF0b3IobmV3IFdlYWtTZXQoKSkob2JqKTtcbn1cblxuY29uc3QgT0JKRUNUU19NQVBQSU5HID0gbmV3IFdlYWtNYXAoKTtcblxuLyoqXG4gKiBDYWxjdWxhdGVzIGEgdW5pcXVlIG9iamVjdCBpZGVudGlmaWVyXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IG9iamVjdCBBbnkgdmFsaWQgRUNNQSBvYmplY3RcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEEgdXVpZFY0IHN0cmluZyB0aGF0IHVuaXF1ZWx5IGlkZW50aWZpZXMgZ2l2ZW4gb2JqZWN0XG4gKi9cbmZ1bmN0aW9uIGdldE9iamVjdElkIChvYmplY3QpIHtcbiAgaWYgKCFPQkpFQ1RTX01BUFBJTkcuaGFzKG9iamVjdCkpIHtcbiAgICBPQkpFQ1RTX01BUFBJTkcuc2V0KG9iamVjdCwgdXVpZFY0KCkpO1xuICB9XG4gIHJldHVybiBPQkpFQ1RTX01BUFBJTkcuZ2V0KG9iamVjdCk7XG59XG5cbmV4cG9ydCB7IHJlcXVpcmVQYWNrYWdlLCBnZXRPYmplY3RTaXplLCBnZXRPYmplY3RJZCB9O1xuIl19