"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fs = exports.default = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _crypto = _interopRequireDefault(require("crypto"));

var _fs = require("fs");

var _glob = _interopRequireDefault(require("glob"));

var _klaw = _interopRequireDefault(require("klaw"));

var _lodash = _interopRequireDefault(require("lodash"));

var _mv = _interopRequireDefault(require("mv"));

var _ncp = _interopRequireDefault(require("ncp"));

var _path = _interopRequireDefault(require("path"));

var _pkgDir = _interopRequireDefault(require("pkg-dir"));

var _readPkg = _interopRequireDefault(require("read-pkg"));

var _rimraf = _interopRequireDefault(require("rimraf"));

var _sanitizeFilename = _interopRequireDefault(require("sanitize-filename"));

var _which = _interopRequireDefault(require("which"));

var _logger = _interopRequireDefault(require("./logger"));

var _timing = _interopRequireDefault(require("./timing"));

var _util = require("./util");

const ncpAsync = _bluebird.default.promisify(_ncp.default);

const findRootCached = _lodash.default.memoize(_pkgDir.default.sync);

const fs = {
  async hasAccess(path) {
    try {
      await _fs.promises.access(path, _fs.constants.R_OK);
    } catch (err) {
      return false;
    }

    return true;
  },

  async exists(path) {
    return await fs.hasAccess(path);
  },

  rimraf: _bluebird.default.promisify(_rimraf.default),
  rimrafSync: _rimraf.default.sync,

  async mkdir(filepath, opts = {}) {
    try {
      return await _fs.promises.mkdir(filepath, opts);
    } catch (err) {
      if ((err === null || err === void 0 ? void 0 : err.code) !== 'EEXIST') {
        throw err;
      }
    }
  },

  async copyFile(source, destination, opts = {}) {
    if (!(await fs.hasAccess(source))) {
      throw new Error(`The file at '${source}' does not exist or is not accessible`);
    }

    return await ncpAsync(source, destination, opts);
  },

  async md5(filePath) {
    return await fs.hash(filePath, 'md5');
  },

  mv: _bluebird.default.promisify(_mv.default),
  which: _which.default,
  glob: _bluebird.default.promisify(_glob.default),
  sanitizeName: _sanitizeFilename.default,

  async hash(filePath, algorithm = 'sha1') {
    return await new _bluebird.default((resolve, reject) => {
      const fileHash = _crypto.default.createHash(algorithm);

      const readStream = (0, _fs.createReadStream)(filePath);
      readStream.on('error', e => reject(new Error(`Cannot calculate ${algorithm} hash for '${filePath}'. Original error: ${e.message}`)));
      readStream.on('data', chunk => fileHash.update(chunk));
      readStream.on('end', () => resolve(fileHash.digest('hex')));
    });
  },

  walk(dir, opts) {
    return (0, _klaw.default)(dir, opts);
  },

  async mkdirp(dir) {
    return await fs.mkdir(dir, {
      recursive: true
    });
  },

  async walkDir(dir, recursive, callback) {
    let isValidRoot = false;
    let errMsg = null;

    try {
      isValidRoot = (await fs.stat(dir)).isDirectory();
    } catch (e) {
      errMsg = e.message;
    }

    if (!isValidRoot) {
      throw Error(`'${dir}' is not a valid root directory` + (errMsg ? `. Original error: ${errMsg}` : ''));
    }

    let walker;
    let fileCount = 0;
    let directoryCount = 0;
    const timer = new _timing.default().start();
    return await new _bluebird.default(function (resolve, reject) {
      let lastFileProcessed = _bluebird.default.resolve();

      walker = (0, _klaw.default)(dir, {
        depthLimit: recursive ? -1 : 0
      });
      walker.on('data', function (item) {
        walker.pause();

        if (!item.stats.isDirectory()) {
          fileCount++;
        } else {
          directoryCount++;
        }

        lastFileProcessed = _bluebird.default.try(async () => await callback(item.path, item.stats.isDirectory())).then(function (done = false) {
          if (done) {
            resolve(item.path);
          } else {
            walker.resume();
          }
        }).catch(reject);
      }).on('error', function (err, item) {
        _logger.default.warn(`Got an error while walking '${item.path}': ${err.message}`);

        if (err.code === 'ENOENT') {
          _logger.default.warn('All files may not have been accessed');

          reject(err);
        }
      }).on('end', function () {
        lastFileProcessed.then(file => {
          resolve(file !== null && file !== void 0 ? file : null);
        }).catch(function (err) {
          _logger.default.warn(`Unexpected error: ${err.message}`);

          reject(err);
        });
      });
    }).finally(function () {
      _logger.default.debug(`Traversed ${(0, _util.pluralize)('directory', directoryCount, true)} ` + `and ${(0, _util.pluralize)('file', fileCount, true)} ` + `in ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

      if (walker) {
        walker.destroy();
      }
    });
  },

  readPackageJsonFrom(dir, opts = {}) {
    const cwd = fs.findRoot(dir);

    try {
      return _readPkg.default.sync({ ...opts,
        cwd
      });
    } catch (err) {
      err.message = `Failed to read a \`package.json\` from dir \`${dir}\`:\n\n${err.message}`;
      throw err;
    }
  },

  findRoot(dir) {
    if (!dir || !_path.default.isAbsolute(dir)) {
      throw new TypeError('`findRoot()` must be provided a non-empty, absolute path');
    }

    const result = findRootCached(dir);

    if (!result) {
      throw new Error(`\`findRoot()\` could not find \`package.json\` from ${dir}`);
    }

    return result;
  },

  access: _fs.promises.access,
  appendFile: _fs.promises.appendFile,
  chmod: _fs.promises.chmod,
  close: _bluebird.default.promisify(_fs.close),
  constants: _fs.constants,
  createWriteStream: _fs.createWriteStream,
  createReadStream: _fs.createReadStream,
  lstat: _fs.promises.lstat,
  open: _bluebird.default.promisify(_fs.open),
  openFile: _fs.promises.open,
  readdir: _fs.promises.readdir,
  read: _bluebird.default.promisify(_fs.read),
  readFile: _fs.promises.readFile,
  readlink: _fs.promises.readlink,
  realpath: _fs.promises.realpath,
  rename: _fs.promises.rename,
  stat: _fs.promises.stat,
  symlink: _fs.promises.symlink,
  unlink: _fs.promises.unlink,
  write: _bluebird.default.promisify(_fs.write),
  writeFile: _fs.promises.writeFile,
  F_OK: _fs.constants.F_OK,
  R_OK: _fs.constants.R_OK,
  W_OK: _fs.constants.W_OK,
  X_OK: _fs.constants.X_OK
};
exports.fs = fs;
var _default = fs;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9mcy5qcyJdLCJuYW1lcyI6WyJuY3BBc3luYyIsIkIiLCJwcm9taXNpZnkiLCJuY3AiLCJmaW5kUm9vdENhY2hlZCIsIl8iLCJtZW1vaXplIiwicGtnRGlyIiwic3luYyIsImZzIiwiaGFzQWNjZXNzIiwicGF0aCIsImZzUHJvbWlzZXMiLCJhY2Nlc3MiLCJjb25zdGFudHMiLCJSX09LIiwiZXJyIiwiZXhpc3RzIiwicmltcmFmIiwicmltcmFmSWR4IiwicmltcmFmU3luYyIsIm1rZGlyIiwiZmlsZXBhdGgiLCJvcHRzIiwiY29kZSIsImNvcHlGaWxlIiwic291cmNlIiwiZGVzdGluYXRpb24iLCJFcnJvciIsIm1kNSIsImZpbGVQYXRoIiwiaGFzaCIsIm12Iiwid2hpY2giLCJnbG9iIiwic2FuaXRpemVOYW1lIiwic2FuaXRpemUiLCJhbGdvcml0aG0iLCJyZXNvbHZlIiwicmVqZWN0IiwiZmlsZUhhc2giLCJjcnlwdG8iLCJjcmVhdGVIYXNoIiwicmVhZFN0cmVhbSIsIm9uIiwiZSIsIm1lc3NhZ2UiLCJjaHVuayIsInVwZGF0ZSIsImRpZ2VzdCIsIndhbGsiLCJkaXIiLCJta2RpcnAiLCJyZWN1cnNpdmUiLCJ3YWxrRGlyIiwiY2FsbGJhY2siLCJpc1ZhbGlkUm9vdCIsImVyck1zZyIsInN0YXQiLCJpc0RpcmVjdG9yeSIsIndhbGtlciIsImZpbGVDb3VudCIsImRpcmVjdG9yeUNvdW50IiwidGltZXIiLCJUaW1lciIsInN0YXJ0IiwibGFzdEZpbGVQcm9jZXNzZWQiLCJkZXB0aExpbWl0IiwiaXRlbSIsInBhdXNlIiwic3RhdHMiLCJ0cnkiLCJ0aGVuIiwiZG9uZSIsInJlc3VtZSIsImNhdGNoIiwibG9nIiwid2FybiIsImZpbGUiLCJmaW5hbGx5IiwiZGVidWciLCJnZXREdXJhdGlvbiIsImFzTWlsbGlTZWNvbmRzIiwidG9GaXhlZCIsImRlc3Ryb3kiLCJyZWFkUGFja2FnZUpzb25Gcm9tIiwiY3dkIiwiZmluZFJvb3QiLCJyZWFkUGtnIiwiaXNBYnNvbHV0ZSIsIlR5cGVFcnJvciIsInJlc3VsdCIsImFwcGVuZEZpbGUiLCJjaG1vZCIsImNsb3NlIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJjcmVhdGVSZWFkU3RyZWFtIiwibHN0YXQiLCJvcGVuIiwib3BlbkZpbGUiLCJyZWFkZGlyIiwicmVhZCIsInJlYWRGaWxlIiwicmVhZGxpbmsiLCJyZWFscGF0aCIsInJlbmFtZSIsInN5bWxpbmsiLCJ1bmxpbmsiLCJ3cml0ZSIsIndyaXRlRmlsZSIsIkZfT0siLCJXX09LIiwiWF9PSyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxRQUFRLEdBQXlGQyxrQkFBRUMsU0FBRixDQUFZQyxZQUFaLENBQXZHOztBQUNBLE1BQU1DLGNBQWMsR0FBR0MsZ0JBQUVDLE9BQUYsQ0FBVUMsZ0JBQU9DLElBQWpCLENBQXZCOztBQUVBLE1BQU1DLEVBQUUsR0FBRztBQU1ULFFBQU1DLFNBQU4sQ0FBaUJDLElBQWpCLEVBQXVCO0FBQ3JCLFFBQUk7QUFDRixZQUFNQyxhQUFXQyxNQUFYLENBQWtCRixJQUFsQixFQUF3QkcsY0FBVUMsSUFBbEMsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPQyxHQUFQLEVBQVk7QUFDWixhQUFPLEtBQVA7QUFDRDs7QUFDRCxXQUFPLElBQVA7QUFDRCxHQWJROztBQW1CVCxRQUFNQyxNQUFOLENBQWNOLElBQWQsRUFBb0I7QUFDbEIsV0FBTyxNQUFNRixFQUFFLENBQUNDLFNBQUgsQ0FBYUMsSUFBYixDQUFiO0FBQ0QsR0FyQlE7O0FBMkJUTyxFQUFBQSxNQUFNLEVBQXFGakIsa0JBQUVDLFNBQUYsQ0FBWWlCLGVBQVosQ0EzQmxGO0FBaUNUQyxFQUFBQSxVQUFVLEVBQUVELGdCQUFVWCxJQWpDYjs7QUEyQ1QsUUFBTWEsS0FB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LElBelJQO0FBK1JUL0YsRUFBQUEsSUFBSSxFQUFFRCxjQUFVQyxJQS9SUDtBQXFTVGdHLEVBQUFBLElBQUksRUFBRWpHLGNBQVVpRyxJQXJTUDtBQTJTVEMsRUFBQUEsSUFBSSxFQUFFbEcsY0FBVWtHO0FBM1NQLENBQVg7O2VBK1NldkcsRSIsInNvdXJjZXNDb250ZW50IjpbIi8vIEB0cy1jaGVja1xuXG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyBjbG9zZSwgY29uc3RhbnRzLCBjcmVhdGVSZWFkU3RyZWFtLCBjcmVhdGVXcml0ZVN0cmVhbSwgcHJvbWlzZXMgYXMgZnNQcm9taXNlcywgcmVhZCwgd3JpdGUsIG9wZW4gfSBmcm9tICdmcyc7XG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCBrbGF3IGZyb20gJ2tsYXcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBtdiBmcm9tICdtdic7XG5pbXBvcnQgbmNwIGZyb20gJ25jcCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBwa2dEaXIgZnJvbSAncGtnLWRpcic7XG5pbXBvcnQgcmVhZFBrZyBmcm9tICdyZWFkLXBrZyc7XG5pbXBvcnQgcmltcmFmSWR4IGZyb20gJ3JpbXJhZic7XG5pbXBvcnQgc2FuaXRpemUgZnJvbSAnc2FuaXRpemUtZmlsZW5hbWUnO1xuaW1wb3J0IHdoaWNoIGZyb20gJ3doaWNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IFRpbWVyIGZyb20gJy4vdGltaW5nJztcbmltcG9ydCB7IHBsdXJhbGl6ZSB9IGZyb20gJy4vdXRpbCc7XG5cbmNvbnN0IG5jcEFzeW5jID0gLyoqIEB0eXBlIHsoc291cmNlOiBzdHJpbmcsIGRlc3Q6IHN0cmluZywgb3B0czogbmNwLk9wdGlvbnN8dW5kZWZpbmVkKSA9PiBCPHZvaWQ+fSAqLyhCLnByb21pc2lmeShuY3ApKTtcbmNvbnN0IGZpbmRSb290Q2FjaGVkID0gXy5tZW1vaXplKHBrZ0Rpci5zeW5jKTtcblxuY29uc3QgZnMgPSB7XG4gIC8qKlxuICAgKiBSZXNvbHZlcyBgdHJ1ZWAgaWYgYHBhdGhgIGlzIF9yZWFkYWJsZV8sIHdoaWNoIGRpZmZlcnMgZnJvbSBOb2RlLmpzJyBkZWZhdWx0IGJlaGF2aW9yIG9mIFwiY2FuIHdlIHNlZSBpdD9cIlxuICAgKiBAcGFyYW0ge2ltcG9ydCgnZnMnKS5QYXRoTGlrZX0gcGF0aFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn1cbiAgICovXG4gIGFzeW5jIGhhc0FjY2VzcyAocGF0aCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmc1Byb21pc2VzLmFjY2VzcyhwYXRoLCBjb25zdGFudHMuUl9PSyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBBbGlhcyBmb3Ige0BsaW5rY29kZSBmcy5oYXNBY2Nlc3N9XG4gICAqIEBwYXJhbSB7aW1wb3J0KCdmcycpLlBhdGhMaWtlfSBwYXRoXG4gICAqL1xuICBhc3luYyBleGlzdHMgKHBhdGgpIHtcbiAgICByZXR1cm4gYXdhaXQgZnMuaGFzQWNjZXNzKHBhdGgpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYSBkaXJlY3RvcnkgYW5kIGFsbCBpdHMgY29udGVudHMsIHJlY3Vyc2l2ZWx5XG4gICAqIEB0b2RvIFJlcGxhY2Ugd2l0aCBgcm0oKWAgZnJvbSBgZnMucHJvbWlzZXNgIHdoZW4gTm9kZS5qcyB2MTIgc3VwcG9ydCBpcyBkcm9wcGVkLlxuICAgKi9cbiAgcmltcmFmOiAvKiogQHR5cGUgeyhkaXJwYXRoOiBzdHJpbmcsIG9wdHM/OiBpbXBvcnQoJ3JpbXJhZicpLk9wdGlvbnMpID0+IFByb21pc2U8dm9pZD59ICovKEIucHJvbWlzaWZ5KHJpbXJhZklkeCkpLFxuXG4gIC8qKlxuICAgKiBBbGlhcyBvZiB7QGxpbmtjb2RlIHJpbXJhZklkeC5zeW5jfVxuICAgKiBAdG9kbyBSZXBsYWNlIHdpdGggYHJtU3luYygpYCBmcm9tIGBmc2Agd2hlbiBOb2RlLmpzIHYxMiBzdXBwb3J0IGlzIGRyb3BwZWQuXG4gICAqL1xuICByaW1yYWZTeW5jOiByaW1yYWZJZHguc3luYyxcblxuICAvKipcbiAgICogTGlrZSBOb2RlLmpzJyBgZnNQcm9taXNlcy5ta2RpcigpYCwgYnV0IHdpbGwgX25vdF8gcmVqZWN0IGlmIHRoZSBkaXJlY3RvcnkgYWxyZWFkeSBleGlzdHMuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfEJ1ZmZlcnxVUkx9IGZpbGVwYXRoXG4gICAqIEBwYXJhbSB7aW1wb3J0KCdmcycpLk1ha2VEaXJlY3RvcnlPcHRpb25zfSBbb3B0c11cbiAgICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nfHVuZGVmaW5lZD59XG4gICAqIEBzZWUgaHR0cHM6Ly9ub2RlanMub3JnL2FwaS9mcy5odG1sI2ZzcHJvbWlzZXNta2RpcnBhdGgtb3B0aW9uc1xuICAgKi9cbiAgYXN5bmMgbWtkaXIgKGZpbGVwYXRoLCBvcHRzID0ge30pIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IGZzUHJvbWlzZXMubWtkaXIoZmlsZXBhdGgsIG9wdHMpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVycj8uY29kZSAhPT0gJ0VFWElTVCcpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgfSxcbiAgLyoqXG4gICAqIENvcGllcyBmaWxlcyBfYW5kIGVudGlyZSBkaXJlY3Rvcmllc19cbiAgICogQHBhcmFtIHtzdHJpbmd9IHNvdXJjZSAtIFNvdXJjZSB0byBjb3B5XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkZXN0aW5hdGlvbiAtIERlc3RpbmF0aW9uIHRvIGNvcHkgdG9cbiAgICogQHBhcmFtIHtuY3AuT3B0aW9uc30gW29wdHNdIC0gQWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byBgbmNwYFxuICAgKiBAc2VlIGh0dHBzOi8vbnBtLmltL25jcFxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn1cbiAgICovXG4gIGFzeW5jIGNvcHlGaWxlIChzb3VyY2UsIGRlc3RpbmF0aW9uLCBvcHRzID0ge30pIHtcbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2Vzcyhzb3VyY2UpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBmaWxlIGF0ICcke3NvdXJjZX0nIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBuY3BBc3luYyhzb3VyY2UsIGRlc3RpbmF0aW9uLCBvcHRzKTtcbiAgfSxcblxuICAvKipcbiAgICogQ3JlYXRlIGFuIE1ENSBoYXNoIG9mIGEgZmlsZS5cbiAgICogQHBhcmFtIHtpbXBvcnQoJ2ZzJykuUGF0aExpa2V9IGZpbGVQYXRoXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz59XG4gICAqL1xuICBhc3luYyBtZDUgKGZpbGVQYXRoKSB7XG4gICAgcmV0dXJuIGF3YWl0IGZzLmhhc2goZmlsZVBhdGgsICdtZDUnKTtcbiAgfSxcblxuICAvKipcbiAgICogTW92ZSBhIGZpbGVcbiAgICovXG4gIG12OiAvKiogQHR5cGUgeyhmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcsIG9wdHM/OiBtdi5PcHRpb25zKSA9PiBCPHZvaWQ+fSAqLyhCLnByb21pc2lmeShtdikpLFxuXG4gIC8qKlxuICAgKiBGaW5kIHBhdGggdG8gYW4gZXhlY3V0YWJsZSBpbiBzeXN0ZW0gYFBBVEhgXG4gICAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL25wbS9ub2RlLXdoaWNoXG4gICAqL1xuICB3aGljaCxcblxuICAvKipcbiAgICogR2l2ZW4gYSBnbG9iIHBhdHRlcm4sIHJlc29sdmUgd2l0aCBsaXN0IG9mIGZpbGVzIG1hdGNoaW5nIHRoYXQgcGF0dGVyblxuICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9pc2FhY3Mvbm9kZS1nbG9iXG4gICAqL1xuICBnbG9iOiAvKiogQHR5cGUgeyhwYXR0ZXJuOiBzdHJpbmcsIG9wdHM/OiBnbG9iLklPcHRpb25zKSA9PiBCPHN0cmluZ1tdPn0gKi8oQi5wcm9taXNpZnkoZ2xvYikpLFxuXG4gIC8qKlxuICAgKiBTYW5pdGl6ZSBhIGZpbGVuYW1lXG4gICAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BhcnNoYXAvbm9kZS1zYW5pdGl6ZS1maWxlbmFtZVxuICAgKi9cbiAgc2FuaXRpemVOYW1lOiBzYW5pdGl6ZSxcblxuICAvKipcbiAgICogQ3JlYXRlIGEgaGV4IGRpZ2VzdCBvZiBzb21lIGZpbGUgYXQgYGZpbGVQYXRoYFxuICAgKiBAcGFyYW0ge2ltcG9ydCgnZnMnKS5QYXRoTGlrZX0gZmlsZVBhdGhcbiAgICogQHBhcmFtIHtzdHJpbmd9IFthbGdvcml0aG1dXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz59XG4gICAqL1xuICBhc3luYyBoYXNoIChmaWxlUGF0aCwgYWxnb3JpdGhtID0gJ3NoYTEnKSB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGZpbGVIYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goYWxnb3JpdGhtKTtcbiAgICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBjcmVhdGVSZWFkU3RyZWFtKGZpbGVQYXRoKTtcbiAgICAgIHJlYWRTdHJlYW0ub24oJ2Vycm9yJywgKGUpID0+IHJlamVjdChcbiAgICAgICAgbmV3IEVycm9yKGBDYW5ub3QgY2FsY3VsYXRlICR7YWxnb3JpdGhtfSBoYXNoIGZvciAnJHtmaWxlUGF0aH0nLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCkpKTtcbiAgICAgIHJlYWRTdHJlYW0ub24oJ2RhdGEnLCAoY2h1bmspID0+IGZpbGVIYXNoLnVwZGF0ZShjaHVuaykpO1xuICAgICAgcmVhZFN0cmVhbS5vbignZW5kJywgKCkgPT4gcmVzb2x2ZShmaWxlSGFzaC5kaWdlc3QoJ2hleCcpKSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFJldHVybnMgYW4gYFdhbGtlcmAgaW5zdGFuY2UsIHdoaWNoIGlzIGEgcmVhZGFibGUgc3RyZWFtIChhbmQgdGh1c2x5IGFuIGFzeW5jIGl0ZXJhdG9yKS5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGRpciAtIERpciB0byBzdGFydCB3YWxraW5nIGF0XG4gICAqIEBwYXJhbSB7aW1wb3J0KCdrbGF3JykuT3B0aW9uc30gW29wdHNdXG4gICAqIEByZXR1cm5zIHtpbXBvcnQoJ2tsYXcnKS5XYWxrZXJ9XG4gICAqIEBzZWUgaHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2Uva2xhd1xuICAgKi9cbiAgd2FsayAoZGlyLCBvcHRzKSB7XG4gICAgcmV0dXJuIGtsYXcoZGlyLCBvcHRzKTtcbiAgfSxcblxuICAvKipcbiAgICogUmVjdXJzaXZlbHkgY3JlYXRlIGEgZGlyZWN0b3J5LlxuICAgKiBAcGFyYW0ge2ltcG9ydCgnZnMnKS5QYXRoTGlrZX0gZGlyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZ3x1bmRlZmluZWQ+fVxuICAgKi9cbiAgYXN5bmMgbWtkaXJwIChkaXIpIHtcbiAgICByZXR1cm4gYXdhaXQgZnMubWtkaXIoZGlyLCB7cmVjdXJzaXZlOiB0cnVlfSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFdhbGtzIGEgZGlyZWN0b3J5IGdpdmVuIGFjY29yZGluZyB0byB0aGUgcGFyYW1ldGVycyBnaXZlbi4gVGhlIGNhbGxiYWNrIHdpbGwgYmUgaW52b2tlZCB3aXRoIGEgcGF0aCBqb2luZWQgd2l0aCB0aGUgZGlyIHBhcmFtZXRlclxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGlyIERpcmVjdG9yeSBwYXRoIHdoZXJlIHdlIHdpbGwgc3RhcnQgd2Fsa2luZ1xuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHJlY3Vyc2l2ZSBTZXQgaXQgdG8gdHJ1ZSBpZiB5b3Ugd2FudCB0byBjb250aW51ZSB3YWxraW5nIHN1YiBkaXJlY3Rvcmllc1xuICAgKiBAcGFyYW0ge1dhbGtEaXJDYWxsYmFja30gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIGEgbmV3IHBhdGggaXMgZm91bmRcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBgZGlyYCBwYXJhbWV0ZXIgY29udGFpbnMgYSBwYXRoIHRvIGFuIGludmFsaWQgZm9sZGVyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz8+fSByZXR1cm5zIHRoZSBmb3VuZCBwYXRoIG9yIG51bGwgaWYgdGhlIGl0ZW0gd2FzIG5vdCBmb3VuZFxuICAgKi9cbiAgYXN5bmMgd2Fsa0RpciAoZGlyLCByZWN1cnNpdmUsIGNhbGxiYWNrKSB7IC8vZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgICBsZXQgaXNWYWxpZFJvb3QgPSBmYWxzZTtcbiAgICBsZXQgZXJyTXNnID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgaXNWYWxpZFJvb3QgPSAoYXdhaXQgZnMuc3RhdChkaXIpKS5pc0RpcmVjdG9yeSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGVyck1zZyA9IGUubWVzc2FnZTtcbiAgICB9XG4gICAgaWYgKCFpc1ZhbGlkUm9vdCkge1xuICAgICAgdGhyb3cgRXJyb3IoYCcke2Rpcn0nIGlzIG5vdCBhIHZhbGlkIHJvb3QgZGlyZWN0b3J5YCArIChlcnJNc2cgPyBgLiBPcmlnaW5hbCBlcnJvcjogJHtlcnJNc2d9YCA6ICcnKSk7XG4gICAgfVxuXG4gICAgbGV0IHdhbGtlcjtcbiAgICBsZXQgZmlsZUNvdW50ID0gMDtcbiAgICBsZXQgZGlyZWN0b3J5Q291bnQgPSAwO1xuICAgIGNvbnN0IHRpbWVyID0gbmV3IFRpbWVyKCkuc3RhcnQoKTtcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgbGV0IGxhc3RGaWxlUHJvY2Vzc2VkID0gQi5yZXNvbHZlKCk7XG4gICAgICB3YWxrZXIgPSBrbGF3KGRpciwge1xuICAgICAgICBkZXB0aExpbWl0OiByZWN1cnNpdmUgPyAtMSA6IDAsXG4gICAgICB9KTtcbiAgICAgIHdhbGtlci5vbignZGF0YScsIGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgIHdhbGtlci5wYXVzZSgpO1xuXG4gICAgICAgIGlmICghaXRlbS5zdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgZmlsZUNvdW50Kys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGlyZWN0b3J5Q291bnQrKztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgICAgICAgbGFzdEZpbGVQcm9jZXNzZWQgPSBCLnRyeShhc3luYyAoKSA9PiBhd2FpdCBjYWxsYmFjayhpdGVtLnBhdGgsIGl0ZW0uc3RhdHMuaXNEaXJlY3RvcnkoKSkpXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRvbmUgPSBmYWxzZSkge1xuICAgICAgICAgICAgaWYgKGRvbmUpIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShpdGVtLnBhdGgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgd2Fsa2VyLnJlc3VtZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICAgLmNhdGNoKHJlamVjdCk7XG4gICAgICB9KVxuICAgICAgLm9uKCdlcnJvcicsIGZ1bmN0aW9uIChlcnIsIGl0ZW0pIHtcbiAgICAgICAgbG9nLndhcm4oYEdvdCBhbiBlcnJvciB3aGlsZSB3YWxraW5nICcke2l0ZW0ucGF0aH0nOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICAvLyBrbGF3IGNhbm5vdCBnZXQgYmFjayBmcm9tIGFuIEVOT0VOVCBlcnJvclxuICAgICAgICBpZiAoZXJyLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAgICAgbG9nLndhcm4oJ0FsbCBmaWxlcyBtYXkgbm90IGhhdmUgYmVlbiBhY2Nlc3NlZCcpO1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLm9uKCdlbmQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxhc3RGaWxlUHJvY2Vzc2VkXG4gICAgICAgICAgLnRoZW4oKGZpbGUpID0+IHtcbiAgICAgICAgICAgIHJlc29sdmUoLyoqIEB0eXBlIHtzdHJpbmd8dW5kZWZpbmVkfSAqLyhmaWxlKSA/PyBudWxsKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICBsb2cud2FybihgVW5leHBlY3RlZCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSkuZmluYWxseShmdW5jdGlvbiAoKSB7XG4gICAgICBsb2cuZGVidWcoYFRyYXZlcnNlZCAke3BsdXJhbGl6ZSgnZGlyZWN0b3J5JywgZGlyZWN0b3J5Q291bnQsIHRydWUpfSBgICtcbiAgICAgICAgYGFuZCAke3BsdXJhbGl6ZSgnZmlsZScsIGZpbGVDb3VudCwgdHJ1ZSl9IGAgK1xuICAgICAgICBgaW4gJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgICAgIGlmICh3YWxrZXIpIHtcbiAgICAgICAgd2Fsa2VyLmRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcbiAgLyoqXG4gICAqIFJlYWRzIHRoZSBjbG9zZXN0IGBwYWNrYWdlLmpzb25gIGZpbGUgZnJvbSBhYnNvbHV0ZSBwYXRoIGBkaXJgLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGlyIC0gRGlyZWN0b3J5IHRvIHNlYXJjaCBmcm9tXG4gICAqIEBwYXJhbSB7aW1wb3J0KCdyZWFkLXBrZycpLk9wdGlvbnN9IFtvcHRzXSAtIEFkZGl0aW9uYWwgb3B0aW9ucyBmb3IgYHJlYWQtcGtnYFxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2VyZSBwcm9ibGVtcyBmaW5kaW5nIG9yIHJlYWRpbmcgYSBgcGFja2FnZS5qc29uYCBmaWxlXG4gICAqIEByZXR1cm5zIHtvYmplY3R9IEEgcGFyc2VkIGBwYWNrYWdlLmpzb25gXG4gICAqL1xuICByZWFkUGFja2FnZUpzb25Gcm9tIChkaXIsIG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IGN3ZCA9IGZzLmZpbmRSb290KGRpcik7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiByZWFkUGtnLnN5bmMoey4uLm9wdHMsIGN3ZH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZXJyLm1lc3NhZ2UgPSBgRmFpbGVkIHRvIHJlYWQgYSBcXGBwYWNrYWdlLmpzb25cXGAgZnJvbSBkaXIgXFxgJHtkaXJ9XFxgOlxcblxcbiR7ZXJyLm1lc3NhZ2V9YDtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH0sXG4gIC8qKlxuICAgKiBGaW5kcyB0aGUgcHJvamVjdCByb290IGRpcmVjdG9yeSBmcm9tIGBkaXJgLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGlyIC0gRGlyZWN0b3J5IHRvIHNlYXJjaCBmcm9tXG4gICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0gSWYgYGRpcmAgaXMgbm90IGEgbm9uZW1wdHkgc3RyaW5nIG9yIHJlbGF0aXZlIHBhdGhcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdlcmUgcHJvYmxlbXMgZmluZGluZyB0aGUgcHJvamVjdCByb290XG4gICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBjbG9zZXNldCBwYXJlbnQgZGlyIGNvbnRhaW5pbmcgYHBhY2thZ2UuanNvbmBcbiAgICovXG4gIGZpbmRSb290IChkaXIpIHtcbiAgICBpZiAoIWRpciB8fCAhcGF0aC5pc0Fic29sdXRlKGRpcikpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2BmaW5kUm9vdCgpYCBtdXN0IGJlIHByb3ZpZGVkIGEgbm9uLWVtcHR5LCBhYnNvbHV0ZSBwYXRoJyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IGZpbmRSb290Q2FjaGVkKGRpcik7XG4gICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgXFxgZmluZFJvb3QoKVxcYCBjb3VsZCBub3QgZmluZCBcXGBwYWNrYWdlLmpzb25cXGAgZnJvbSAke2Rpcn1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSxcblxuICAvLyBhZGQgdGhlIHN1cHBvcnRlZCBgZnNgIGZ1bmN0aW9uc1xuICBhY2Nlc3M6IGZzUHJvbWlzZXMuYWNjZXNzLFxuICBhcHBlbmRGaWxlOiBmc1Byb21pc2VzLmFwcGVuZEZpbGUsXG4gIGNobW9kOiBmc1Byb21pc2VzLmNobW9kLFxuICBjbG9zZTogQi5wcm9taXNpZnkoY2xvc2UpLFxuICBjb25zdGFudHMsXG4gIGNyZWF0ZVdyaXRlU3RyZWFtLFxuICBjcmVhdGVSZWFkU3RyZWFtLFxuICBsc3RhdDogZnNQcm9taXNlcy5sc3RhdCxcbiAgLyoqXG4gICAqIFdhcm5pbmc6IHRoaXMgaXMgYSBwcm9taXNpZmllZCB7QGxpbmtjb2RlIG9wZW4gZnMub3Blbn0uXG4gICAqIEl0IHJlc29sdmVzIHcvYSBmaWxlIGRlc2NyaXB0b3IgaW5zdGVhZCBvZiBhIHtAbGlua2NvZGUgZnNQcm9taXNlcy5GaWxlSGFuZGxlIEZpbGVIYW5kbGV9IG9iamVjdCwgYXMge0BsaW5rY29kZSBmc1Byb21pc2VzLm9wZW59IGRvZXMuIFVzZSB7QGxpbmtjb2RlIGZzLm9wZW5GaWxlfSBpZiB5b3Ugd2FudCBhIGBGaWxlSGFuZGxlYC5cbiAgICogQHR5cGUgeyhwYXRoOiBpbXBvcnQoJ2ZzJykuUGF0aExpa2UsIGZsYWdzOiBpbXBvcnQoJ2ZzJykuT3Blbk1vZGUsIG1vZGU/OiBpbXBvcnQoJ2ZzJykuTW9kZSkgPT4gUHJvbWlzZTxudW1iZXI+fVxuICAgKi9cbiAgb3BlbjogQi5wcm9taXNpZnkob3BlbiksXG4gIG9wZW5GaWxlOiBmc1Byb21pc2VzLm9wZW4sXG4gIHJlYWRkaXI6IGZzUHJvbWlzZXMucmVhZGRpcixcbiAgcmVhZDogQi5wcm9taXNpZnkocmVhZCksXG4gIHJlYWRGaWxlOiBmc1Byb21pc2VzLnJlYWRGaWxlLFxuICByZWFkbGluazogZnNQcm9taXNlcy5yZWFkbGluayxcbiAgcmVhbHBhdGg6IGZzUHJvbWlzZXMucmVhbHBhdGgsXG4gIHJlbmFtZTogZnNQcm9taXNlcy5yZW5hbWUsXG4gIHN0YXQ6IGZzUHJvbWlzZXMuc3RhdCxcbiAgc3ltbGluazogZnNQcm9taXNlcy5zeW1saW5rLFxuICB1bmxpbms6IGZzUHJvbWlzZXMudW5saW5rLFxuICB3cml0ZTogQi5wcm9taXNpZnkod3JpdGUpLFxuICB3cml0ZUZpbGU6IGZzUHJvbWlzZXMud3JpdGVGaWxlLFxuXG4gIC8vIGRlcHJlY2F0ZWQgcHJvcHNcblxuICAvKipcbiAgICogVXNlIGBjb25zdGFudHMuRl9PS2AgaW5zdGVhZC5cbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIEZfT0s6IGNvbnN0YW50cy5GX09LLFxuXG4gIC8qKlxuICAgKiBVc2UgYGNvbnN0YW50cy5SX09LYCBpbnN0ZWFkLlxuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgUl9PSzogY29uc3RhbnRzLlJfT0ssXG5cbiAgLyoqXG4gICAqIFVzZSBgY29uc3RhbnRzLldfT0tgIGluc3RlYWQuXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBXX09LOiBjb25zdGFudHMuV19PSyxcblxuICAvKipcbiAgICogVXNlIGBjb25zdGFudHMuWF9PS2AgaW5zdGVhZC5cbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIFhfT0s6IGNvbnN0YW50cy5YX09LXG59O1xuXG5leHBvcnQgeyBmcyB9O1xuZXhwb3J0IGRlZmF1bHQgZnM7XG5cbi8qKlxuICogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoaWNoIHdpbGwgYmUgY2FsbGVkIGR1cmluZyB0aGUgZGlyZWN0b3J5IHdhbGtpbmdcbiAqIEBjYWxsYmFjayBXYWxrRGlyQ2FsbGJhY2tcbiAqIEBwYXJhbSB7c3RyaW5nfSBpdGVtUGF0aCBUaGUgcGF0aCBvZiB0aGUgZmlsZSBvciBmb2xkZXJcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNEaXJlY3RvcnkgU2hvd3MgaWYgaXQgaXMgYSBkaXJlY3Rvcnkgb3IgYSBmaWxlXG4gKiBAcmV0dXJuIHtib29sZWFufSByZXR1cm4gdHJ1ZSBpZiB5b3Ugd2FudCB0byBzdG9wIHdhbGtpbmdcbiovXG5cbi8qKlxuICogQHR5cGVkZWYge2ltcG9ydCgnZ2xvYicpfSBnbG9iXG4gKiBAdHlwZWRlZiB7aW1wb3J0KCdtdicpfSBtdlxuICovXG4iXX0=