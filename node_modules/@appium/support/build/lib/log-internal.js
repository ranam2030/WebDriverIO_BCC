"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SecureValuesPreprocessor = exports.SECURE_VALUES_PREPROCESSOR = void 0;

require("source-map-support/register");

var _fs = _interopRequireDefault(require("./fs"));

var _lodash = _interopRequireDefault(require("lodash"));

const DEFAULT_REPLACER = '**SECURE**';

class SecureValuesPreprocessor {
  constructor() {
    this._rules = [];
  }

  get rules() {
    return this._rules;
  }

  parseRule(rule) {
    let pattern;
    let replacer = DEFAULT_REPLACER;
    let flags = ['g'];

    if (_lodash.default.isString(rule)) {
      if (rule.length === 0) {
        throw new Error(`${JSON.stringify(rule)} -> The value must not be empty`);
      }

      pattern = `\\b${_lodash.default.escapeRegExp(rule)}\\b`;
    } else if (_lodash.default.isPlainObject(rule)) {
      if (_lodash.default.has(rule, 'pattern')) {
        if (!_lodash.default.isString(rule.pattern) || rule.pattern.length === 0) {
          throw new Error(`${JSON.stringify(rule)} -> The value of 'pattern' must be a valid non-empty string`);
        }

        pattern = rule.pattern;
      } else if (_lodash.default.has(rule, 'text')) {
        if (!_lodash.default.isString(rule.text) || rule.text.length === 0) {
          throw new Error(`${JSON.stringify(rule)} -> The value of 'text' must be a valid non-empty string`);
        }

        pattern = `\\b${_lodash.default.escapeRegExp(rule.text)}\\b`;
      }

      if (!pattern) {
        throw new Error(`${JSON.stringify(rule)} -> Must either have a field named 'pattern' or 'text'`);
      }

      if (_lodash.default.has(rule, 'flags')) {
        for (const flag of ['i', 'g', 'm', 's', 'u', 'y']) {
          if (_lodash.default.includes(rule.flags, flag)) {
            flags.push(flag);
          }
        }

        flags = _lodash.default.uniq(flags);
      }

      if (_lodash.default.isString(rule.replacer)) {
        replacer = rule.replacer;
      }
    } else {
      throw new Error(`${JSON.stringify(rule)} -> Must either be a string or an object`);
    }

    return {
      pattern: new RegExp(pattern, flags.join('')),
      replacer
    };
  }

  async loadRules(source) {
    let rules;

    if (_lodash.default.isArray(source)) {
      rules = source;
    } else {
      if (!(await _fs.default.exists(source))) {
        throw new Error(`'${source}' does not exist or is not accessible`);
      }

      try {
        rules = JSON.parse(await _fs.default.readFile(source, 'utf8'));
      } catch (e) {
        throw new Error(`'${source}' must be a valid JSON file. Original error: ${e.message}`);
      }

      if (!_lodash.default.isArray(rules)) {
        throw new Error(`'${source}' must contain a valid JSON array`);
      }
    }

    const issues = [];
    this._rules = [];

    for (const rule of rules) {
      try {
        this._rules.push(this.parseRule(rule));
      } catch (e) {
        issues.push(e.message);
      }
    }

    return issues;
  }

  preprocess(str) {
    if (this._rules.length === 0 || !_lodash.default.isString(str)) {
      return str;
    }

    let result = str;

    for (const rule of this._rules) {
      result = result.replace(rule.pattern, rule.replacer);
    }

    return result;
  }

}

exports.SecureValuesPreprocessor = SecureValuesPreprocessor;
const SECURE_VALUES_PREPROCESSOR = new SecureValuesPreprocessor();
exports.SECURE_VALUES_PREPROCESSOR = SECURE_VALUES_PREPROCESSOR;
var _default = SECURE_VALUES_PREPROCESSOR;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9sb2ctaW50ZXJuYWwuanMiXSwibmFtZXMiOlsiREVGQVVMVF9SRVBMQUNFUiIsIlNlY3VyZVZhbHVlc1ByZXByb2Nlc3NvciIsImNvbnN0cnVjdG9yIiwiX3J1bGVzIiwicnVsZXMiLCJwYXJzZVJ1bGUiLCJydWxlIiwicGF0dGVybiIsInJlcGxhY2VyIiwiZmxhZ3MiLCJfIiwiaXNTdHJpbmciLCJsZW5ndGgiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJlc2NhcGVSZWdFeHAiLCJpc1BsYWluT2JqZWN0IiwiaGFzIiwidGV4dCIsImZsYWciLCJpbmNsdWRlcyIsInB1c2giLCJ1bmlxIiwiUmVnRXhwIiwiam9pbiIsImxvYWRSdWxlcyIsInNvdXJjZSIsImlzQXJyYXkiLCJmcyIsImV4aXN0cyIsInBhcnNlIiwicmVhZEZpbGUiLCJlIiwibWVzc2FnZSIsImlzc3VlcyIsInByZXByb2Nlc3MiLCJzdHIiLCJyZXN1bHQiLCJyZXBsYWNlIiwiU0VDVVJFX1ZBTFVFU19QUkVQUk9DRVNTT1IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUcsWUFBekI7O0FBR0EsTUFBTUMsd0JBQU4sQ0FBK0I7QUFDN0JDLEVBQUFBLFdBQVcsR0FBSTtBQUNiLFNBQUtDLE1BQUwsR0FBYyxFQUFkO0FBQ0Q7O0FBTVEsTUFBTEMsS0FBSyxHQUFJO0FBQ1gsV0FBTyxLQUFLRCxNQUFaO0FBQ0Q7O0FBVURFLEVBQUFBLFNBQVMsQ0FBRUMsSUFBRixFQUFRO0FBQ2YsUUFBSUMsT0FBSjtBQUNBLFFBQUlDLFFBQVEsR0FBR1IsZ0JBQWY7QUFDQSxRQUFJUyxLQUFLLEdBQUcsQ0FBQyxHQUFELENBQVo7O0FBQ0EsUUFBSUMsZ0JBQUVDLFFBQUYsQ0FBV0wsSUFBWCxDQUFKLEVBQXNCO0FBQ3BCLFVBQUlBLElBQUksQ0FBQ00sTUFBTCxLQUFnQixDQUFwQixFQUF1QjtBQUNyQixjQUFNLElBQUlDLEtB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TUFBQUEsTUFBTSxHQUFHQSxNQUFNLENBQUNDLE9BQVAsQ0FBZWpDLElBQUksQ0FBQ0MsT0FBcEIsRUFBNkJELElBQUksQ0FBQ0UsUUFBbEMsQ0FBVDtBQUNEOztBQUNELFdBQU84QixNQUFQO0FBQ0Q7O0FBL0g0Qjs7O0FBa0kvQixNQUFNRSwwQkFBMEIsR0FBRyxJQUFJdkMsd0JBQUosRUFBbkM7O2VBR2V1QywwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICcuL2ZzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmNvbnN0IERFRkFVTFRfUkVQTEFDRVIgPSAnKipTRUNVUkUqKic7XG5cblxuY2xhc3MgU2VjdXJlVmFsdWVzUHJlcHJvY2Vzc29yIHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHRoaXMuX3J1bGVzID0gW107XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge0FycmF5PFNlY3VyZVZhbHVlUHJlcHJvY2Vzc2luZ1J1bGU+fSBUaGUgbGlzdCBvZiBzdWNjZXNzZnVsbHlcbiAgICogcGFyc2VkIHByZXByb2Nlc3NpbmcgcnVsZXNcbiAgICovXG4gIGdldCBydWxlcyAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3J1bGVzO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlcyBzaW5nbGUgcnVsZSBmcm9tIHRoZSBnaXZlbiBKU09OIGZpbGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd8UnVsZX0gcnVsZSBUaGUgcnVsZSBtaWdodCBlaXRoZXIgYmUgcmVwcmVzZW50ZWQgYXMgYSBzaW5nbGUgc3RyaW5nXG4gICAqIG9yIGEgY29uZmlndXJhdGlvbiBvYmplY3RcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBwYXJzaW5nIHRoZSBydWxlXG4gICAqIEByZXR1cm5zIHtTZWN1cmVWYWx1ZVByZXByb2Nlc3NpbmdSdWxlfSBUaGUgcGFyc2VkIHJ1bGVcbiAgICovXG4gIHBhcnNlUnVsZSAocnVsZSkge1xuICAgIGxldCBwYXR0ZXJuO1xuICAgIGxldCByZXBsYWNlciA9IERFRkFVTFRfUkVQTEFDRVI7XG4gICAgbGV0IGZsYWdzID0gWydnJ107XG4gICAgaWYgKF8uaXNTdHJpbmcocnVsZSkpIHtcbiAgICAgIGlmIChydWxlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7SlNPTi5zdHJpbmdpZnkocnVsZSl9IC0+IFRoZSB2YWx1ZSBtdXN0IG5vdCBiZSBlbXB0eWApO1xuICAgICAgfVxuICAgICAgcGF0dGVybiA9IGBcXFxcYiR7Xy5lc2NhcGVSZWdFeHAocnVsZSl9XFxcXGJgO1xuICAgIH0gZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KHJ1bGUpKSB7XG4gICAgICBpZiAoXy5oYXMocnVsZSwgJ3BhdHRlcm4nKSkge1xuICAgICAgICBpZiAoIV8uaXNTdHJpbmcocnVsZS5wYXR0ZXJuKSB8fCBydWxlLnBhdHRlcm4ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke0pTT04uc3RyaW5naWZ5KHJ1bGUpfSAtPiBUaGUgdmFsdWUgb2YgJ3BhdHRlcm4nIG11c3QgYmUgYSB2YWxpZCBub24tZW1wdHkgc3RyaW5nYCk7XG4gICAgICAgIH1cbiAgICAgICAgcGF0dGVybiA9IHJ1bGUucGF0dGVybjtcbiAgICAgIH0gZWxzZSBpZiAoXy5oYXMocnVsZSwgJ3RleHQnKSkge1xuICAgICAgICBpZiAoIV8uaXNTdHJpbmcocnVsZS50ZXh0KSB8fCBydWxlLnRleHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke0pTT04uc3RyaW5naWZ5KHJ1bGUpfSAtPiBUaGUgdmFsdWUgb2YgJ3RleHQnIG11c3QgYmUgYSB2YWxpZCBub24tZW1wdHkgc3RyaW5nYCk7XG4gICAgICAgIH1cbiAgICAgICAgcGF0dGVybiA9IGBcXFxcYiR7Xy5lc2NhcGVSZWdFeHAocnVsZS50ZXh0KX1cXFxcYmA7XG4gICAgICB9XG4gICAgICBpZiAoIXBhdHRlcm4pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke0pTT04uc3RyaW5naWZ5KHJ1bGUpfSAtPiBNdXN0IGVpdGhlciBoYXZlIGEgZmllbGQgbmFtZWQgJ3BhdHRlcm4nIG9yICd0ZXh0J2ApO1xuICAgICAgfVxuXG4gICAgICBpZiAoXy5oYXMocnVsZSwgJ2ZsYWdzJykpIHtcbiAgICAgICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9HdWlkZS9SZWd1bGFyX0V4cHJlc3Npb25zI0FkdmFuY2VkX3NlYXJjaGluZ193aXRoX2ZsYWdzXzJcbiAgICAgICAgZm9yIChjb25zdCBmbGFnIG9mIFsnaScsICdnJywgJ20nLCAncycsICd1JywgJ3knXSkge1xuICAgICAgICAgIGlmIChfLmluY2x1ZGVzKHJ1bGUuZmxhZ3MsIGZsYWcpKSB7XG4gICAgICAgICAgICBmbGFncy5wdXNoKGZsYWcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmbGFncyA9IF8udW5pcShmbGFncyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChfLmlzU3RyaW5nKHJ1bGUucmVwbGFjZXIpKSB7XG4gICAgICAgIHJlcGxhY2VyID0gcnVsZS5yZXBsYWNlcjtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke0pTT04uc3RyaW5naWZ5KHJ1bGUpfSAtPiBNdXN0IGVpdGhlciBiZSBhIHN0cmluZyBvciBhbiBvYmplY3RgKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcGF0dGVybjogbmV3IFJlZ0V4cChwYXR0ZXJuLCBmbGFncy5qb2luKCcnKSksXG4gICAgICByZXBsYWNlcixcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWRzIHJ1bGVzIGZyb20gdGhlIGdpdmVuIEpTT04gZmlsZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ3xzdHJpbmdbXXxSdWxlW119IHNvdXJjZSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBKU09OIGZpbGUgY29udGFpbmluZyBzZWN1cmVcbiAgICogdmFsdWVzIHJlcGxhY2VtZW50IHJ1bGVzIG9yIHRoZSBydWxlcyB0aGVtc2VsdmVzIHJlcHJlc2VudGVkIGFzIGFuIGFycmF5XG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgZm9ybWF0IG9mIHRoZSBzb3VyY2UgZmlsZSBpcyBpbnZhbGlkIG9yXG4gICAqIGl0IGRvZXMgbm90IGV4aXN0XG4gICAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZ1tdPn0gVGhlIGxpc3Qgb2YgaXNzdWVzIGZvdW5kIHdoaWxlIHBhcnNpbmcgZWFjaCBydWxlLlxuICAgKiBBbiBlbXB0eSBsaXN0IGlzIHJldHVybmVkIGlmIG5vIHJ1bGUgcGFyc2luZyBpc3N1ZXMgd2VyZSBmb3VuZFxuICAgKi9cbiAgYXN5bmMgbG9hZFJ1bGVzIChzb3VyY2UpIHtcbiAgICBsZXQgcnVsZXM7XG4gICAgaWYgKF8uaXNBcnJheShzb3VyY2UpKSB7XG4gICAgICBydWxlcyA9IHNvdXJjZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFhd2FpdCBmcy5leGlzdHMoc291cmNlKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke3NvdXJjZX0nIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBydWxlcyA9IEpTT04ucGFyc2UoYXdhaXQgZnMucmVhZEZpbGUoc291cmNlLCAndXRmOCcpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtzb3VyY2V9JyBtdXN0IGJlIGEgdmFsaWQgSlNPTiBmaWxlLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgICBpZiAoIV8uaXNBcnJheShydWxlcykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtzb3VyY2V9JyBtdXN0IGNvbnRhaW4gYSB2YWxpZCBKU09OIGFycmF5YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgaXNzdWVzID0gW107XG4gICAgdGhpcy5fcnVsZXMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IHJ1bGUgb2YgcnVsZXMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMuX3J1bGVzLnB1c2godGhpcy5wYXJzZVJ1bGUocnVsZSkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpc3N1ZXMucHVzaChlLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaXNzdWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIHNlY3VyZSB2YWx1ZXMgcmVwbGFjZW1lbnQgaW5zaWRlIHRoZSBnaXZlbiBzdHJpbmdcbiAgICogYWNjb3JkaW5nIHRvIHRoZSBwcmV2aW91c2x5IGxvYWRlZCBydWxlcy4gTm8gcmVwbGFjZW1lbnQgaXMgbWFkZVxuICAgKiBpZiB0aGVyZSBhcmUgbm8gcnVsZXMgb3IgdGhlIGdpdmVuIHZhbHVlIGlzIG5vdCBhIHN0cmluZ1xuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gbWFrZSByZXBsYWNlbWVudHMgaW5cbiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIHN0cmluZyB3aXRoIHJlcGxhY2VtZW50cyBtYWRlXG4gICAqL1xuICBwcmVwcm9jZXNzIChzdHIpIHtcbiAgICBpZiAodGhpcy5fcnVsZXMubGVuZ3RoID09PSAwIHx8ICFfLmlzU3RyaW5nKHN0cikpIHtcbiAgICAgIHJldHVybiBzdHI7XG4gICAgfVxuXG4gICAgbGV0IHJlc3VsdCA9IHN0cjtcbiAgICBmb3IgKGNvbnN0IHJ1bGUgb2YgdGhpcy5fcnVsZXMpIHtcbiAgICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKHJ1bGUucGF0dGVybiwgcnVsZS5yZXBsYWNlcik7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn1cblxuY29uc3QgU0VDVVJFX1ZBTFVFU19QUkVQUk9DRVNTT1IgPSBuZXcgU2VjdXJlVmFsdWVzUHJlcHJvY2Vzc29yKCk7XG5cbmV4cG9ydCB7IFNFQ1VSRV9WQUxVRVNfUFJFUFJPQ0VTU09SLCBTZWN1cmVWYWx1ZXNQcmVwcm9jZXNzb3IgfTtcbmV4cG9ydCBkZWZhdWx0IFNFQ1VSRV9WQUxVRVNfUFJFUFJPQ0VTU09SO1xuXG4vKipcbiAqIEB0eXBlZGVmIFJ1bGVcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwYXR0ZXJuIEEgdmFsaWQgUmVnRXhwIHBhdHRlcm4gdG8gYmUgcmVwbGFjZWRcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0ZXh0IEEgdGV4dCBtYXRjaCB0byByZXBsYWNlLiBFaXRoZXIgdGhpcyBwcm9wZXJ0eSBvciB0aGVcbiAqIGFib3ZlIG9uZSBtdXN0IGJlIHByb3ZpZGVkLiBgcGF0dGVybmAgaGFzIHByaW9yaXR5IG92ZXIgYHRleHRgIGlmIGJvdGggYXJlIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtmbGFnc10gUmVndWxhciBleHByZXNzaW9uIGZsYWdzIGZvciB0aGUgZ2l2ZW4gcGF0dGVybi5cbiAqIFN1cHBvcnRlZCBmbGFnIGFyZSB0aGUgc2FtZSBhcyBmb3IgdGhlIHN0YW5kYXJkIEphdmFTY3JpcHQgUmVnRXhwIGNvbnN0cnVjdG9yOlxuICogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9HdWlkZS9SZWd1bGFyX0V4cHJlc3Npb25zI0FkdmFuY2VkX3NlYXJjaGluZ193aXRoX2ZsYWdzXzJcbiAqIFRoZSAnZycgKGdsb2JhbCBtYXRjaGluZykgaXMgYWx3YXlzIGVuYWJsZWQgdGhvdWdoLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtyZXBsYWNlcl0gVGhlIHJlcGxhY2VyIHZhbHVlIHRvIHVzZS4gQnkgZGVmYXVsdFxuICogZXF1YWxzIHRvIGBERUZBVUxUX1NFQ1VSRV9SRVBMQUNFUmBcbiAqL1xuXG4vKipcbiAqIEB0eXBlZGVmIFNlY3VyZVZhbHVlUHJlcHJvY2Vzc2luZ1J1bGVcbiAqIEBwcm9wZXJ0eSB7UmVnRXhwfSBwYXR0ZXJuIFRoZSBwYXJzZWQgcGF0dGVybiB3aGljaCBpcyBnb2luZyB0byBiZSB1c2VkIGZvciByZXBsYWNlbWVudFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtyZXBsYWNlcl0gVGhlIHJlcGxhY2VyIHZhbHVlIHRvIHVzZS4gQnkgZGVmYXVsdFxuICogZXF1YWxzIHRvIGBERUZBVUxUX1NFQ1VSRV9SRVBMQUNFUmBcbiAqL1xuIl19